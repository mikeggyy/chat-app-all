# 嚴格商業邏輯測試計劃

## 📋 目標

建立一套全面、嚴格的商業邏輯測試,確保系統在各種極端情況下都能正確運作,保證數據一致性和業務邏輯的正確性。

## 🎯 測試原則

1. **零容忍原則** - 任何商業邏輯錯誤都必須被捕獲
2. **數據一致性** - 所有操作必須保證 Firestore Transaction 的原子性
3. **並發安全** - 測試並發場景下的數據競爭和鎖定機制
4. **邊界條件** - 測試極端值、空值、負值等邊界情況
5. **錯誤恢復** - 驗證錯誤時的回滾和恢復機制
6. **冪等性** - 確保所有消耗性操作的冪等性
7. **性能監控** - 監控關鍵操作的性能指標

## 📊 測試覆蓋範圍

### 1. 金幣系統測試 (test-coins-strict.js)

**基礎功能測試**:
- ✅ 購買功能 (角色解鎖、照片、影片)
- ✅ 使用解鎖券優先於金幣
- ✅ 金幣餘額不足拋出錯誤
- ✅ Transaction 記錄的完整性

**並發測試**:
- ⚠️ 多個用戶同時購買 (測試數據庫鎖定)
- ⚠️ 同一用戶並發購買不同商品
- ⚠️ 同一用戶並發購買同一商品 (應該只成功一次)

**邊界條件測試**:
- ⚠️ 餘額剛好等於價格
- ⚠️ 餘額為 0
- ⚠️ 餘額為負數 (異常數據)
- ⚠️ 購買價格為 0 的商品
- ⚠️ 購買價格為負數的商品 (異常數據)

**Transaction 原子性測試**:
- ⚠️ Transaction 中途失敗,驗證完全回滾
- ⚠️ 多步驟操作的原子性 (扣款 + 解鎖 + 記錄)
- ⚠️ 驗證 balanceBefore 和 balanceAfter 的準確性

**錯誤恢復測試**:
- ⚠️ Firestore 連接中斷
- ⚠️ 數據寫入失敗
- ⚠️ 部分成功場景處理

### 2. 限制服務測試 (test-limits-strict.js)

**對話限制測試**:
- ✅ 基礎限制檢查 (Free/VIP/VVIP)
- ✅ 每日重置邏輯
- ⚠️ 廣告解鎖邏輯 (次數累加、上限檢查)
- ⚠️ 永久解鎖檢查
- ⚠️ 並發發送消息 (同一角色)
- ⚠️ 跨角色限制獨立性

**語音限制測試**:
- ✅ 基礎限制檢查
- ✅ 付費用戶無限制
- ⚠️ 每日重置邏輯
- ⚠️ 廣告解鎖邏輯
- ⚠️ 並發播放語音

**拍照限制測試**:
- ✅ 免費用戶終生限制 (3 次)
- ✅ VIP/VVIP 使用拍照卡
- ⚠️ 拍照卡餘額不足
- ⚠️ 拍照卡與金幣 fallback
- ⚠️ 並發拍照請求

**影片限制測試**:
- ✅ 免費用戶無權限
- ✅ VIP/VVIP 使用影片卡
- ⚠️ 影片卡餘額不足
- ⚠️ 並發影片生成請求

**重置邏輯測試**:
- ⚠️ 每日重置 (對話、語音)
- ⚠️ 每月重置 (角色創建)
- ⚠️ 永不重置 (拍照、影片)
- ⚠️ 跨時區重置邏輯 (UTC+8)
- ⚠️ 廣告解鎖次數每日重置

### 3. 會員系統測試 (test-membership-strict.js)

**升級測試** (已有,需要加強):
- ✅ 正常升級流程
- ✅ 並發升級防護
- ✅ 過期鎖定自動解鎖
- ⚠️ 升級時的獎勵發放驗證 (角色卡、拍照卡、影片卡、創建卡)
- ⚠️ 升級後限制立即生效
- ⚠️ 升級失敗回滾測試

**降級測試**:
- ⚠️ 會員到期自動降級
- ⚠️ 降級後限制立即生效
- ⚠️ 降級不影響已解鎖的角色
- ⚠️ 降級不扣除已發放的卡片

**會員過期測試**:
- ⚠️ 會員到期時間準確性
- ⚠️ 會員到期後功能限制
- ⚠️ 會員續費邏輯

### 4. 冪等性測試 (test-idempotency-strict.js)

**基礎冪等性測試**:
- ⚠️ 相同 idempotency key 重複請求返回相同結果
- ⚠️ 不同 idempotency key 正常執行
- ⚠️ 冪等性 key 過期後可重複執行

**並發冪等性測試**:
- ⚠️ 並發請求使用相同 idempotency key (只有一個成功)
- ⚠️ 並發請求使用不同 idempotency key (都成功)

**TTL 測試**:
- ⚠️ 不同操作類型的 TTL 配置正確
- ⚠️ TTL 過期後自動清理
- ⚠️ TTL 內重複請求被拒絕

**覆蓋操作**:
- ⚠️ 購買操作冪等性
- ⚠️ 送禮操作冪等性
- ⚠️ 會員升級冪等性
- ⚠️ AI 生成操作冪等性 (拍照、影片、TTS)

### 5. 虛擬商品系統測試 (test-virtual-goods-strict.js)

**禮物系統測試**:
- ⚠️ 禮物購買 (金幣扣除)
- ⚠️ 禮物發送記錄
- ⚠️ 禮物統計更新 (角色、用戶)
- ⚠️ 並發送禮測試
- ⚠️ 金幣不足拋出錯誤
- ⚠️ Transaction 原子性

**解鎖券系統測試** (已有,需要加強):
- ✅ 使用解鎖券購買角色
- ✅ 使用金幣購買角色
- ✅ 重複購買防護
- ⚠️ 拍照解鎖券使用
- ⚠️ 影片解鎖券使用
- ⚠️ 解鎖券與金幣 fallback 邏輯
- ⚠️ 並發使用解鎖券

**藥水系統測試** (已有,需要加強):
- ✅ 購買藥水增加庫存
- ✅ 使用藥水扣除庫存並激活效果
- ✅ 庫存不足防護
- ✅ 重複使用同一角色防護
- ⚠️ 藥水效果過期自動清理
- ⚠️ 並發購買藥水
- ⚠️ 並發使用藥水
- ⚠️ 藥水效果檢查性能

### 6. 數據一致性測試 (test-data-consistency.js)

**Transaction 原子性測試**:
- ⚠️ 單個 Transaction 多個寫操作
- ⚠️ Transaction 失敗完全回滾
- ⚠️ 嵌套 Transaction 處理
- ⚠️ Transaction 超時處理

**並發修改測試**:
- ⚠️ 多個用戶同時修改同一文檔
- ⚠️ 樂觀鎖機制驗證
- ⚠️ 衝突解決策略

**數據庫狀態驗證**:
- ⚠️ 操作後驗證所有相關文檔狀態
- ⚠️ 外鍵完整性檢查 (交易記錄 <-> 用戶餘額)
- ⚠️ 統計數據一致性 (角色收到的禮物數 vs 禮物記錄)

**跨集合一致性**:
- ⚠️ users.wallet.balance vs transactions 總和
- ⚠️ usage_limits 統計 vs 實際使用記錄
- ⚠️ character 統計 vs 對話記錄

### 7. 角色創建系統測試 (test-character-creation-strict.js)

**創建限制測試**:
- ⚠️ 每月創建次數限制 (Free/VIP/VVIP)
- ⚠️ 創建卡使用邏輯
- ⚠️ 每月重置邏輯 (每月 1 號凌晨)
- ⚠️ VVIP 額外創建卡 (30 張,永久有效)

**並發創建測試**:
- ⚠️ 並發創建角色
- ⚠️ 創建卡並發消耗
- ⚠️ 創建次數並發檢查

**數據完整性測試**:
- ⚠️ 創建的角色數據完整
- ⚠️ 創建記錄準確
- ⚠️ 統計數據更新

## 🚀 測試執行策略

### 測試優先級

**P0 - 關鍵商業邏輯** (必須 100% 通過):
- 金幣購買和扣除
- Transaction 記錄
- 會員升級獎勵發放
- 冪等性保證

**P1 - 核心功能** (必須通過):
- 各種限制服務
- 虛擬商品購買
- 並發場景處理

**P2 - 邊界和錯誤處理** (建議通過):
- 極端值測試
- 錯誤恢復測試
- 性能測試

### 測試環境

**推薦使用 Firebase Emulator**:
- 完全隔離的測試環境
- 快速重置數據
- 無生產環境風險

**測試數據清理**:
- 每個測試前創建臨時測試用戶
- 每個測試後完全清理測試數據
- 使用唯一的用戶 ID (timestamp)

### 測試執行

```bash
# 啟動 Firebase Emulator
cd chat-app
npm run dev:with-emulator

# 運行所有嚴格測試
node backend/scripts/test-all-business-logic-strict.js

# 運行單個測試套件
node backend/scripts/test-coins-strict.js
node backend/scripts/test-limits-strict.js
node backend/scripts/test-idempotency-strict.js
node backend/scripts/test-data-consistency.js
```

## 📈 測試指標

### 成功標準

- **測試通過率**: 100%
- **並發測試成功率**: >= 95%
- **數據一致性驗證**: 100%
- **錯誤恢復測試**: 100%

### 性能基準

- 單個購買操作: < 500ms
- 並發 10 個請求: < 2s
- Transaction 操作: < 1s

## 📝 測試報告

每次測試執行後生成報告:
- 測試時間
- 通過/失敗數量
- 失敗原因詳情
- 性能指標
- 數據一致性檢查結果

## 🔄 持續改進

1. 發現 bug 後立即添加對應測試用例
2. 新功能開發必須同步編寫測試
3. 定期 review 測試覆蓋率
4. 監控生產環境問題,反向添加測試

## ✅ 當前狀態

### 已完成
- ✅ 會員升級基礎測試 (5 個測試)
- ✅ 角色解鎖購買測試 (6 個測試)
- ✅ 藥水系統基礎測試 (13 個步驟)

### 待完成 (本次任務)
- ⚠️ 金幣系統嚴格測試 (包含並發、Transaction、邊界條件)
- ⚠️ 限制服務嚴格測試 (包含並發、重置邏輯)
- ⚠️ 冪等性系統測試 (包含並發、TTL)
- ⚠️ 數據一致性測試 (包含 Transaction 原子性)
- ⚠️ 統一測試執行腳本

## 🎯 本次目標

建立以下嚴格測試套件:
1. **test-coins-strict.js** - 金幣系統完整測試 (15+ 測試)
2. **test-limits-strict.js** - 限制服務完整測試 (20+ 測試)
3. **test-idempotency-strict.js** - 冪等性系統測試 (10+ 測試)
4. **test-data-consistency.js** - 數據一致性測試 (15+ 測試)
5. **test-all-business-logic-strict.js** - 統一執行腳本

預期新增測試數量: **60+** 個嚴格測試
