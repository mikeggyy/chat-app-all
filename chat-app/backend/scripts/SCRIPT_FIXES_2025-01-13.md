# æœƒå“¡æ•¸æ“šç›£æ§èˆ‡æ¸…ç†è…³æœ¬ä¿®æ­£èªªæ˜

**æ—¥æœŸ**ï¼š2025-01-13
**ç‰ˆæœ¬**ï¼šv1.1ï¼ˆä¿®æ­£ç‰ˆï¼‰

## ğŸ“‹ ä¿®æ­£æ¦‚è¦½

æœ¬æ¬¡ä¿®æ­£é‡å°æœƒå“¡æ•¸æ“šç›£æ§å’Œæ¸…ç†è…³æœ¬é€²è¡Œäº†é‡è¦çš„é‚è¼¯å„ªåŒ–å’ŒéŒ¯èª¤ä¿®å¾©ï¼Œç¢ºä¿æ¥­å‹™é‚è¼¯æ›´åŠ å®‰å…¨å¯é ã€‚

## ğŸ”§ ä¿®å¾©çš„å•é¡Œ

### 1. **åš´é‡å•é¡Œï¼šfs æ¨¡å¡Šå°å…¥éŒ¯èª¤** âœ… å·²ä¿®å¾©

**å•é¡Œæè¿°**ï¼š
- **æ–‡ä»¶**ï¼š`monitor-membership-data.js` å’Œ `cleanup-membership-data.js`
- **éŒ¯èª¤ä»£ç¢¼**ï¼š
  ```javascript
  const fs = await import('fs');  // âŒ å‹•æ…‹å°å…¥å¯èƒ½å°è‡´å•é¡Œ
  fs.writeFileSync(...);           // âŒ å¯èƒ½ç„¡æ³•æ­£ç¢ºå·¥ä½œ
  ```
- **å½±éŸ¿**ï¼šåœ¨æŸäº› Node.js ç‰ˆæœ¬ä¸­å¯èƒ½ç„¡æ³•ä¿å­˜å ±å‘Šæ–‡ä»¶

**ä¿®å¾©æ–¹æ¡ˆ**ï¼š
```javascript
import fs from 'fs';  // âœ… åœ¨æ–‡ä»¶é ‚éƒ¨éœæ…‹å°å…¥
// ... å¾ŒçºŒç›´æ¥ä½¿ç”¨
fs.writeFileSync(...);
```

**å½±éŸ¿ç¯„åœ**ï¼š
- âœ… `monitor-membership-data.js` line 20
- âœ… `cleanup-membership-data.js` line 26

---

### 2. **æ¥­å‹™é‚è¼¯é¢¨éšªï¼šé»˜èªéæœŸæ™‚é–“éæ–¼å¯¬é¬†** âš ï¸ å·²å„ªåŒ–

**å•é¡Œæè¿°**ï¼š
- **åŸé‚è¼¯**ï¼šå°ç¼ºå°‘æˆ–ç„¡æ•ˆ `membershipExpiresAt` çš„æœƒå“¡ï¼Œé»˜èªè¨­ç½®ç‚º 30 å¤©å¾Œ
- **é¢¨éšª**ï¼š
  - å¦‚æœç”¨æˆ¶æœ¬æ‡‰å·²éæœŸï¼Œçµ¦äºˆ 30 å¤© = å…è²»äº«å— 30 å¤©ä»˜è²»æ¬Šç›Š
  - æ½›åœ¨æå¤±ï¼šæ¯å€‹ç”¨æˆ¶ VIP åƒ¹å€¼ç´„ $10-20ï¼Œ30 å¤©æå¤±å¯è§€
  - å¦‚æœ‰å¤šå€‹ç”¨æˆ¶ï¼Œç´¯è¨ˆæå¤±å¯é”æ•¸ç™¾è‡³æ•¸åƒç¾å…ƒ

**ä¿®å¾©æ–¹æ¡ˆ**ï¼š
```javascript
// âŒ åŸæ–¹æ¡ˆï¼ˆéæ–¼å¯¬é¬†ï¼‰
const defaultExpiration = new Date();
defaultExpiration.setDate(defaultExpiration.getDate() + 30); // 30 å¤©

// âœ… ä¿®å¾©å¾Œï¼ˆæ›´ä¿å®ˆï¼‰
const defaultExpiration = new Date();
defaultExpiration.setDate(defaultExpiration.getDate() + 7); // 7 å¤©

const updates = {
  membershipExpiresAt: defaultExpiration.toISOString(),
  _needsManualReview: true,
  _needsUrgentReview: true, // ğŸ”´ ç·Šæ€¥å¯©æ ¸æ¨™è¨˜
  _originalTier: userData.membershipTier, // ä¿å­˜åŸå§‹ç­‰ç´š
  // ...
};
```

**å„ªå‹¢**ï¼š
- âœ… é™ä½è²¡å‹™é¢¨éšªï¼š7 å¤© vs 30 å¤©
- âœ… å¼·åˆ¶äººå·¥å¯©æ ¸ï¼š`_needsUrgentReview: true`
- âœ… ä¿ç•™å¯©æ ¸ä¾æ“šï¼šä¿å­˜åŸå§‹ç­‰ç´šå’Œåˆ°æœŸæ™‚é–“

**å½±éŸ¿ç¯„åœ**ï¼š
- âœ… `fixMissingExpiresAt()` å‡½æ•¸
- âœ… `fixInvalidDateFormat()` å‡½æ•¸

---

### 3. **æ¥­å‹™é‚è¼¯ï¼šå·²éæœŸæœƒå“¡è™•ç†** âœ… å·²ç¢ºèª

**ç­–ç•¥æè¿°**ï¼š
- **é‚è¼¯**ï¼šå·²éæœŸæœƒå“¡ç«‹å³é™ç´šç‚º `free`
- **åŸå› **ï¼šåš´æ ¼åŸ·è¡ŒéæœŸæ”¿ç­–ï¼Œç¢ºä¿ç³»çµ±ä¸€è‡´æ€§

**ä¿®å¾©æ–¹æ¡ˆ**ï¼šä¿æŒç°¡å–®ç›´æ¥çš„é™ç´šé‚è¼¯

```javascript
const daysSinceExpired = Math.floor((now - expiresAt) / (1000 * 60 * 60 * 24));

const updates = {
  membershipTier: 'free',
  membershipStatus: 'expired',
  _previousTier: userData.membershipTier,
  _daysSinceExpired: daysSinceExpired,
};
```

**å„ªå‹¢**ï¼š
- âœ… é‚è¼¯ç°¡å–®æ˜ç¢ºï¼šéæœŸå³é™ç´š
- âœ… ç³»çµ±ä¸€è‡´æ€§ï¼šç¢ºä¿æ‰€æœ‰éæœŸç”¨æˆ¶ç‹€æ…‹æ­£ç¢º
- âœ… è¨˜éŒ„å®Œæ•´ï¼šä¿å­˜éæœŸå¤©æ•¸å’ŒåŸå§‹ç­‰ç´š

**å½±éŸ¿ç¯„åœ**ï¼š
- âœ… `fixExpiredNotUpdated()` å‡½æ•¸

---

## ğŸ“Š ä¿®æ­£å‰å¾Œå°æ¯”

### å ´æ™¯ 1ï¼šä»˜è²»æœƒå“¡ç¼ºå°‘åˆ°æœŸæ™‚é–“

| ç¶­åº¦ | ä¿®æ­£å‰ | ä¿®æ­£å¾Œ |
|-----|-------|-------|
| é»˜èªéæœŸæ™‚é–“ | 30 å¤©å¾Œ | **7 å¤©å¾Œ** âš ï¸ |
| å¯©æ ¸æ¨™è¨˜ | `_needsManualReview: true` | `_needsManualReview: true`<br>`_needsUrgentReview: true` ğŸ”´ |
| åŸå§‹æ•¸æ“šä¿å­˜ | âŒ ç„¡ | âœ… `_originalTier` |
| è²¡å‹™é¢¨éšª | é«˜ï¼ˆ30 å¤©å…è²»æ¬Šç›Šï¼‰ | ä½ï¼ˆ7 å¤©å…è²»æ¬Šç›Šï¼‰ |

### å ´æ™¯ 2ï¼šä»˜è²»æœƒå“¡å·²éæœŸä½†ç‹€æ…‹æœªæ›´æ–°

| éæœŸå¤©æ•¸ | ä¿®æ­£å‰ | ä¿®æ­£å¾Œ |
|---------|-------|-------|
| 1 å¤© | ç«‹å³é™ç´šç‚º free | âœ… ç«‹å³é™ç´šç‚º free |
| 2 å¤© | ç«‹å³é™ç´šç‚º free | âœ… ç«‹å³é™ç´šç‚º free |
| 3 å¤© | ç«‹å³é™ç´šç‚º free | âœ… ç«‹å³é™ç´šç‚º free |
| 7 å¤© | ç«‹å³é™ç´šç‚º free | âœ… ç«‹å³é™ç´šç‚º free |
| 30 å¤© | ç«‹å³é™ç´šç‚º free | âœ… ç«‹å³é™ç´šç‚º free |

---

## ğŸ¯ æ–°å¢åŠŸèƒ½

### 1. ç·Šæ€¥å¯©æ ¸æ¨™è¨˜

**ç”¨é€”**ï¼šæ¨™è¨˜éœ€è¦ç·Šæ€¥äººå·¥å¯©æ ¸çš„ç”¨æˆ¶

```javascript
_needsUrgentReview: true  // ğŸ”´ ç·Šæ€¥å¯©æ ¸æ¨™è¨˜
```

**æŸ¥è©¢ç·Šæ€¥å¯©æ ¸ç”¨æˆ¶**ï¼š
```javascript
db.collection('users')
  .where('_needsUrgentReview', '==', true)
  .get()
```

**å¯©æ ¸å¾Œæ“ä½œ**ï¼š
1. æŸ¥çœ‹ç”¨æˆ¶è³¼è²·è¨˜éŒ„ï¼ˆorders/transactions é›†åˆï¼‰
2. ç¢ºå®šçœŸå¯¦çš„åˆ°æœŸæ™‚é–“
3. æ›´æ–° `membershipExpiresAt` ç‚ºæ­£ç¢ºå€¼
4. ç§»é™¤å¯©æ ¸æ¨™è¨˜ï¼š
   ```javascript
   db.collection('users').doc(userId).update({
     _needsUrgentReview: false,
     _needsManualReview: false,
     _reviewedBy: 'admin_user_id',
     _reviewedAt: new Date().toISOString(),
   });
   ```

### 2. éæœŸå¤©æ•¸è¿½è¹¤

**ç”¨é€”**ï¼šè¨˜éŒ„ç”¨æˆ¶å·²éæœŸçš„å¤©æ•¸ï¼Œä¾›å¯©æ ¸åƒè€ƒ

**è¨˜éŒ„æ¬„ä½**ï¼š
- `_daysSinceExpired`: å·²éæœŸå¤©æ•¸
- `_previousTier`: åŸå§‹æœƒå“¡ç­‰ç´š

**æŸ¥è©¢å·²éæœŸç”¨æˆ¶**ï¼š
```javascript
db.collection('users')
  .where('membershipStatus', '==', 'expired')
  .where('membershipTier', '==', 'free')
  .get()
```

---

## âœ… é©—è­‰æ¸…å–®

### åŸ·è¡Œå‰æª¢æŸ¥

- [ ] ç¢ºèª Node.js ç‰ˆæœ¬ >= 14ï¼ˆæ”¯æ´ ESMï¼‰
- [ ] ç¢ºèªå·²å®‰è£æ‰€æœ‰ä¾è³´ï¼š`npm install`
- [ ] ç¢ºèªæœ‰ Firestore è®€å¯«æ¬Šé™
- [ ] ç¢ºèªåœ¨æ­£ç¢ºçš„ç’°å¢ƒï¼ˆç”Ÿç”¢ç’°å¢ƒéœ€æ ¼å¤–å°å¿ƒï¼‰

### åŸ·è¡Œæ­¥é©Ÿ

1. **é‹è¡Œç›£æ§è…³æœ¬**
   ```bash
   cd chat-app/backend
   node scripts/monitor-membership-data.js
   ```
   - [ ] æª¢æŸ¥æ§åˆ¶å°è¼¸å‡ºæ˜¯å¦æ­£å¸¸
   - [ ] ç¢ºèªç”Ÿæˆ `membership-data-report.json` æ–‡ä»¶
   - [ ] æª¢æŸ¥å ±å‘Šå…§å®¹æ˜¯å¦åˆç†

2. **æ¨¡æ“¬ä¿®å¾©ï¼ˆæ¨è–¦ï¼‰**
   ```bash
   node scripts/cleanup-membership-data.js --fix-dry-run
   ```
   - [ ] æª¢æŸ¥ä¿®å¾©é‚è¼¯æ˜¯å¦æ­£ç¢º
   - [ ] ç¢ºèªæ²’æœ‰èª¤é™ç´šç”¨æˆ¶
   - [ ] ç¢ºèªéæœŸæœƒå“¡æ­£ç¢ºé™ç´šç‚º free

3. **åŸ·è¡Œå¯¦éš›ä¿®å¾©**
   ```bash
   node scripts/cleanup-membership-data.js --fix
   ```
   - [ ] ç­‰å¾… 3 ç§’ç¢ºèª
   - [ ] æª¢æŸ¥åŸ·è¡Œçµæœ
   - [ ] ç¢ºèªå‚™ä»½å·²å‰µå»ºï¼ˆ`membership_data_backup` é›†åˆï¼‰
   - [ ] ç¢ºèªæ“ä½œå·²è¨˜éŒ„ï¼ˆ`audit_logs` é›†åˆï¼‰

4. **äººå·¥å¯©æ ¸**
   - [ ] æŸ¥è©¢éœ€è¦å¯©æ ¸çš„ç”¨æˆ¶ï¼š
     ```javascript
     db.collection('users')
       .where('_needsUrgentReview', '==', true)
       .get()
     ```
   - [ ] æª¢æŸ¥æ¯å€‹ç”¨æˆ¶çš„è³¼è²·è¨˜éŒ„
   - [ ] èª¿æ•´åˆ°æœŸæ™‚é–“ç‚ºæ­£ç¢ºå€¼
   - [ ] ç§»é™¤å¯©æ ¸æ¨™è¨˜

### åŸ·è¡Œå¾Œæª¢æŸ¥

- [ ] å†æ¬¡é‹è¡Œç›£æ§è…³æœ¬ï¼Œç¢ºèªå•é¡Œå·²ä¿®å¾©
- [ ] æª¢æŸ¥å‚™ä»½æ•¸æ“šæ˜¯å¦å®Œæ•´
- [ ] æª¢æŸ¥ audit logs æ˜¯å¦æ­£ç¢ºè¨˜éŒ„
- [ ] æ¸¬è©¦å—å½±éŸ¿ç”¨æˆ¶çš„æ¬Šé™æ˜¯å¦æ­£ç¢º

---

## ğŸš¨ é‡è¦æé†’

### è²¡å‹™é¢¨éšªæ§åˆ¶

1. **7 å¤©ç·Šæ€¥å¯©æ ¸**ï¼šæ‰€æœ‰ç¼ºå°‘æˆ–ç„¡æ•ˆåˆ°æœŸæ™‚é–“çš„æœƒå“¡ï¼Œé»˜èªçµ¦äºˆ 7 å¤©ï¼Œ**å¿…é ˆåœ¨ 7 å¤©å…§å®Œæˆäººå·¥å¯©æ ¸**
2. **éæœŸæœƒå“¡ç›£æ§**ï¼šå®šæœŸæª¢æŸ¥å·²éæœŸé™ç´šçš„ç”¨æˆ¶ï¼Œç¢ºèªæ˜¯å¦æœ‰èª¤é™ç´šæƒ…æ³
3. **è³¼è²·è¨˜éŒ„æ ¸å°**ï¼šå¯©æ ¸æ™‚å‹™å¿…æ ¸å° orders/transactions é›†åˆï¼Œç¢ºå®šçœŸå¯¦è³¼è²·æƒ…æ³

### æ•¸æ“šå®‰å…¨

1. **å‚™ä»½é©—è­‰**ï¼šä¿®å¾©å‰ç¢ºèª `membership_data_backup` é›†åˆå¯ç”¨
2. **å›æ»¾æº–å‚™**ï¼šå¦‚ç™¼ç¾éŒ¯èª¤ï¼Œå¯å¾å‚™ä»½æ¢å¾©ï¼š
   ```javascript
   const backupDoc = await db.collection('membership_data_backup').doc(userId).get();
   const backupData = backupDoc.data();
   delete backupData.backedUpAt;
   delete backupData.backupReason;
   await db.collection('users').doc(userId).set(backupData, { merge: true });
   ```
3. **å¯©è¨ˆæ—¥èªŒ**ï¼šæ‰€æœ‰æ“ä½œå·²è¨˜éŒ„åˆ° `audit_logs`ï¼Œå¯è¿½æº¯

### ç”¨æˆ¶é«”é©—

1. **éæœŸé€šçŸ¥**ï¼šå»ºè­°åœ¨æœƒå“¡å³å°‡åˆ°æœŸå‰é€šçŸ¥ç”¨æˆ¶çºŒè¨‚
2. **å®¢æœæº–å‚™**ï¼šå‘ŠçŸ¥å®¢æœåœ˜éšŠæœƒå“¡éæœŸè™•ç†æ”¿ç­–
3. **ç›£æ§æŠ•è¨´**ï¼šé—œæ³¨æ˜¯å¦æœ‰ç”¨æˆ¶æŠ•è¨´æ¬Šé™å•é¡Œ

---

## ğŸ“ˆ å¾ŒçºŒå»ºè­°

### è‡ªå‹•åŒ–ç›£æ§

å»ºè­°è¨­ç½® Cloud Scheduler å®šæœŸé‹è¡Œç›£æ§è…³æœ¬ï¼š

```javascript
// Cloud Function ç¤ºä¾‹
exports.scheduledMembershipMonitor = functions.pubsub
  .schedule('0 2 * * 1') // æ¯é€±ä¸€å‡Œæ™¨ 2 é»
  .timeZone('Asia/Taipei')
  .onRun(async (context) => {
    // é‹è¡Œç›£æ§é‚è¼¯
    const report = await monitorMembershipData();

    // å¦‚ç™¼ç¾å•é¡Œï¼Œé€šçŸ¥ç®¡ç†å“¡
    if (report.totalIssues > 0) {
      await sendAdminNotification({
        subject: `æœƒå“¡æ•¸æ“šç›£æ§ï¼šç™¼ç¾ ${report.totalIssues} å€‹å•é¡Œ`,
        body: JSON.stringify(report, null, 2),
      });
    }
  });
```

### è³¼è²·è¨˜éŒ„æ•´åˆ

å»ºè­°åœ¨ä¿®å¾©é‚è¼¯ä¸­æ•´åˆè³¼è²·è¨˜éŒ„æŸ¥è©¢ï¼š

```javascript
// æŸ¥è©¢ç”¨æˆ¶æœ€è¿‘çš„è³¼è²·è¨˜éŒ„
const ordersSnapshot = await db.collection('orders')
  .where('userId', '==', userId)
  .where('status', '==', 'completed')
  .orderBy('createdAt', 'desc')
  .limit(1)
  .get();

if (!ordersSnapshot.empty) {
  const lastOrder = ordersSnapshot.docs[0].data();
  // æ ¹æ“šè³¼è²·è¨˜éŒ„è¨ˆç®—çœŸå¯¦åˆ°æœŸæ™‚é–“
  const realExpiresAt = calculateExpiresAt(lastOrder);
  updates.membershipExpiresAt = realExpiresAt.toISOString();
}
```

### é€šçŸ¥ç³»çµ±

å»ºè­°æ·»åŠ ç”¨æˆ¶é€šçŸ¥ï¼š

1. **åˆ°æœŸå‰é€šçŸ¥**ï¼šæœƒå“¡åˆ°æœŸå‰ 3 å¤©é€šçŸ¥
2. **é™ç´šé€šçŸ¥**ï¼šæœƒå“¡é™ç´šç‚º free æ™‚é€šçŸ¥ç”¨æˆ¶
3. **ç·Šæ€¥å¯©æ ¸é€šçŸ¥**ï¼šç™¼ç¾ç¼ºå°‘åˆ°æœŸæ™‚é–“æ™‚é€šçŸ¥ç®¡ç†å“¡

---

## ğŸ“š ç›¸é—œæ–‡æª”

- **ä½¿ç”¨æŒ‡å—**ï¼š[MEMBERSHIP_DATA_SCRIPTS.md](./MEMBERSHIP_DATA_SCRIPTS.md)
- **æ¥­å‹™é‚è¼¯ä¿®å¾©å ±å‘Š**ï¼šå¾…å‰µå»ºï¼ˆå¦‚éœ€è¦ï¼‰
- **æœƒå“¡æœå‹™æ ¸å¿ƒé‚è¼¯**ï¼š`../src/membership/membership.service.js`

---

## ğŸ”„ ç‰ˆæœ¬æ­·å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®æ”¹å…§å®¹ |
|-----|------|---------|
| v1.0 | 2025-01-13 | åˆå§‹ç‰ˆæœ¬ |
| v1.1 | 2025-01-13 | ä¿®å¾© fs å°å…¥å•é¡Œï¼Œå„ªåŒ–æ¥­å‹™é‚è¼¯ |

---

**æ›´æ–°æ—¥æœŸ**ï¼š2025-01-13
**ç¶­è­·è€…**ï¼šå¾Œç«¯é–‹ç™¼åœ˜éšŠ
**å¯©æ ¸ç‹€æ…‹**ï¼šâœ… å·²å¯©æ ¸ä¸¦æ¸¬è©¦
