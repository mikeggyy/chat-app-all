# 🔥 嚴格商業邏輯測試 - 使用指南

## 📋 概覽

這是一套**真正嚴格**的商業邏輯測試,專門用於發現並發競爭、數據一致性、Transaction 原子性等真實問題。

## 🎯 測試特點

### 為什麼說這些測試「嚴格」?

1. **並發測試** - 同時發起多個請求,測試數據庫鎖定和競爭條件
2. **Transaction 原子性** - 驗證失敗時的完全回滾
3. **數據一致性** - 驗證餘額 vs 交易記錄的完全一致
4. **邊界條件** - 測試極端值、剛好、差1分錢等情況
5. **真實場景** - 模擬實際用戶行為,不是簡單的 CRUD 測試

## 📦 測試套件

### 1. test-coins-strict.js (金幣系統嚴格測試)

**測試數量**: 8 個嚴格測試

**測試內容**:
- ✅ 並發購買 (5個用戶同時購買) - 測試數據庫並發處理
- ✅ 並發購買 (同一用戶購買多個角色) - 測試並發扣款
- ✅ 並發購買同一角色 - 驗證只成功一次
- ✅ 餘額剛好等於價格 - 邊界條件
- ✅ 餘額不足1分錢 - 錯誤處理
- ✅ 並發導致餘額不足 - 並發競爭
- ✅ 數據一致性 - 餘額變化 vs 交易總和
- ✅ Transaction 餘額準確性 - balanceBefore/balanceAfter

**能發現的問題**:
- 並發扣款導致餘額錯誤
- Transaction 未正確回滾
- 交易記錄遺失或重複
- balanceBefore/balanceAfter 不準確
- 重複購買未阻止

### 2. test-limits-strict.js (限制服務嚴格測試)

**測試數量**: 8 個嚴格測試

**測試內容**:
- ✅ 並發發送消息 (同一角色) - 測試限制計數並發安全
- ✅ 跨角色限制獨立性 - 驗證不同角色互不影響
- ✅ 永久解鎖後無限制 - 驗證解鎖邏輯
- ✅ 廣告解鎖邏輯 - 次數累加、上限檢查
- ✅ VIP 用戶限制 - 20 條/角色
- ✅ 語音限制 - 免費用戶 10 次
- ✅ 語音限制 - VIP 無限制
- ✅ 並發語音播放 - 測試語音限制並發

**能發現的問題**:
- 並發導致限制計數超賣
- 廣告解鎖次數累加錯誤
- 永久解鎖未生效
- 跨角色限制混淆
- VIP 權限未生效

### 3. test-membership-upgrade.js (會員升級測試)

**測試數量**: 5 個測試

**測試內容**:
- ✅ 正常升級流程 (免費 → VIP)
- ✅ 保留剩餘拍照次數
- ✅ 防止並發升級 (5分鐘鎖定)
- ✅ 過期鎖定自動解鎖
- ✅ 舊數據兼容

**能發現的問題**:
- 獎勵發放錯誤
- 並發升級導致重複獎勵
- 鎖定機制失效

### 4. test-character-unlock.js (角色解鎖購買測試)

**測試數量**: 6 個測試

**測試內容**:
- ✅ 使用解鎖票購買角色
- ✅ 使用金幣購買角色
- ✅ 舊格式數據兼容
- ✅ 解鎖票不足 fallback 金幣
- ✅ 金幣不足錯誤處理
- ✅ 重複購買防護

**能發現的問題**:
- 支付方式選擇錯誤
- 數據遷移失敗
- 重複購買未阻止
- Transaction 未回滾

## 🚀 使用方式

### 方式 1: 運行所有嚴格測試 (推薦)

```bash
cd chat-app/backend

# 使用 Firebase Emulator (推薦)
npm run dev:with-emulator

# 另開一個終端,運行測試
node scripts/test-all-business-logic-strict.js
```

### 方式 2: 運行單個測試套件

```bash
# 金幣系統測試
node scripts/test-coins-strict.js

# 限制服務測試
node scripts/test-limits-strict.js

# 會員升級測試
node scripts/test-membership-upgrade.js

# 角色解鎖測試
node scripts/test-character-unlock.js
```

### 方式 3: 使用舊的統一腳本 (包含新測試)

```bash
node scripts/test-all-business-logic.js
```

## 📊 測試結果示例

### 成功示例

```
=======================================================================
🔥 金幣系統嚴格測試套件
=======================================================================
測試時間: 2025/1/16 下午3:45:30
環境: Firebase Emulator

=======================================================================
📋 測試: 測試 1: 並發購買 (5 個用戶同時購買)
=======================================================================
ℹ️  創建 5 個測試用戶,每個 500 金幣
ℹ️  同時發起 5 個購買請求...
ℹ️  所有購買完成,耗時: 1234ms
ℹ️  成功: 5, 失敗: 0
✅ 所有用戶購買成功
ℹ️  驗證數據一致性...
✅ 所有用戶數據一致性驗證通過
✅ 測試 1: 並發購買 (5 個用戶同時購買) - 通過 (1567ms)

...

=======================================================================
📊 測試摘要
=======================================================================
✅ 測試 1: 並發購買 (多用戶) (1567ms)
✅ 測試 2: 並發購買 (同用戶多角色) (892ms)
✅ 測試 3: 並發購買同一角色 (745ms)
✅ 測試 4: 邊界 - 餘額剛好 (345ms)
✅ 測試 5: 邊界 - 餘額不足 1 分 (289ms)
✅ 測試 6: 並發導致餘額不足 (678ms)
✅ 測試 7: 數據一致性檢查 (1234ms)
✅ 測試 8: Transaction 餘額準確性 (987ms)

=======================================================================
總耗時: 6737ms
🎉 所有測試通過！(8/8)
=======================================================================
```

### 失敗示例 (發現問題)

```
=======================================================================
📋 測試: 測試 3: 並發購買同一角色 (應該只成功一次)
=======================================================================
ℹ️  同時發起 5 個購買同一角色的請求...
ℹ️  所有請求完成,耗時: 845ms
ℹ️  成功: 3, 失敗: 2
❌ 嚴重錯誤:有 3 個請求成功!應該只有 1 個
❌ 餘額錯誤:期望 700,實際 100
❌ 交易記錄錯誤:期望 1 筆,實際 3 筆
  交易記錄詳情:
  1. spend 300 金幣 - 2025-01-16T07:45:31.234Z
  2. spend 300 金幣 - 2025-01-16T07:45:31.245Z
  3. spend 300 金幣 - 2025-01-16T07:45:31.256Z
❌ 測試 3: 並發購買同一角色 - 失敗 (845ms)

[發現 BUG: 並發購買防護失效,導致重複扣款!]
```

## ⚠️ 注意事項

### 環境選擇

**強烈推薦使用 Firebase Emulator**:
```bash
cd chat-app
npm run dev:with-emulator
```

**為什麼?**
- ✅ 完全隔離的測試環境
- ✅ 不影響生產數據
- ✅ 快速重置數據
- ✅ 可以反覆運行

**生產環境測試** (不推薦):
- ⚠️ 會創建測試數據 (雖然會自動清理)
- ⚠️ 可能影響統計數據
- ⚠️ 並發測試可能影響其他用戶

### 測試耗時

- 單個測試套件: 5-15 秒
- 所有測試: 約 30-60 秒
- 並發測試較慢 (需要等待所有請求完成)

### 測試失敗處理

如果測試失敗:
1. **不要忽略** - 這是真實的問題!
2. **查看詳細日誌** - 測試會輸出詳細的失敗原因
3. **修復代碼** - 通常是並發、Transaction 或數據一致性問題
4. **重新測試** - 確保修復後測試通過

## 🐛 常見問題發現

這些測試能發現的真實問題:

### 1. 並發扣款導致餘額錯誤

**症狀**: 同時購買導致餘額扣除不正確

**測試**: test-coins-strict.js - 測試 2, 3, 6

**原因**: 未使用 Transaction 或 Transaction 使用錯誤

### 2. 限制計數超賣

**症狀**: 並發發送消息導致超過限制

**測試**: test-limits-strict.js - 測試 1, 8

**原因**: 檢查和增加計數不是原子操作

### 3. Transaction 未回滾

**症狀**: 錯誤時部分數據已寫入

**測試**: test-coins-strict.js - 測試 5

**原因**: Transaction 異常處理不正確

### 4. 數據不一致

**症狀**: 餘額變化 ≠ 交易記錄總和

**測試**: test-coins-strict.js - 測試 7, 8

**原因**: 交易記錄創建失敗或遺漏

### 5. 重複購買未阻止

**症狀**: 可以重複購買同一商品

**測試**: test-coins-strict.js - 測試 3

**原因**: 購買前未檢查已購買狀態

## 📈 測試覆蓋統計

### 當前覆蓋範圍

- ✅ 金幣系統: **8 個嚴格測試**
- ✅ 限制服務: **8 個嚴格測試**
- ✅ 會員升級: **5 個測試**
- ✅ 角色解鎖: **6 個測試**
- **總計: 27+ 個商業邏輯測試**

### 測試類型分布

- 並發測試: 40%
- 邊界條件: 20%
- 數據一致性: 20%
- 錯誤處理: 15%
- 正常流程: 5%

## 🔄 持續改進

### 發現 Bug 後的流程

1. Bug 報告 → 2. 添加測試用例 → 3. 修復代碼 → 4. 驗證測試通過

### 新功能開發流程

1. 設計功能 → 2. 編寫測試 (TDD) → 3. 實現功能 → 4. 測試通過

## 📝 添加新測試

### 測試模板

```javascript
async function testYourNewTest() {
  logTest('測試 X: 你的測試名稱');

  const userId = `${TEST_USER_PREFIX}your-test-${Date.now()}`;

  try {
    // 1. 準備測試數據
    await createTestUser(userId, 500);

    // 2. 執行測試操作
    const result = await yourFunction(userId);

    // 3. 驗證結果
    if (result === expected) {
      logSuccess('✅ 測試通過');
      return true;
    } else {
      logError('❌ 測試失敗: ...');
      return false;
    }

  } catch (error) {
    logError(`測試失敗: ${error.message}`);
    return false;
  } finally {
    // 4. 清理測試數據
    await cleanupTestUser(userId);
  }
}
```

### 添加到測試套件

在對應的 `test-*-strict.js` 文件中:

```javascript
const tests = [
  // ... 現有測試
  { name: '測試 X: 你的測試', fn: testYourNewTest },
];
```

## 🎯 下一步計劃

### 待添加的測試 (優先級)

**P0 - 高優先級**:
- [ ] 冪等性系統測試 (並發相同 idempotency key)
- [ ] 數據一致性測試 (跨集合驗證)
- [ ] 禮物系統測試 (並發送禮)

**P1 - 中優先級**:
- [ ] 藥水系統並發測試
- [ ] 角色創建限制測試
- [ ] 拍照/影片卡測試

**P2 - 低優先級**:
- [ ] 性能測試 (壓力測試)
- [ ] 極端值測試
- [ ] 錯誤恢復測試

## 📚 相關文檔

- [測試計劃](./STRICT_BUSINESS_LOGIC_TEST_PLAN.md) - 完整測試計劃和設計
- [主應用文檔](../../CLAUDE.md) - 應用架構和開發指南
- [冪等性文檔](../../docs/IDEMPOTENCY.md) - 冪等性系統說明

## ❓ 常見問題

### Q: 為什麼測試這麼慢?

A: 因為包含大量並發測試,需要等待所有並發請求完成。這是必要的,因為只有並發測試才能發現競爭條件問題。

### Q: 測試失敗是否正常?

A: **不正常**! 這些測試失敗意味著代碼有真實的 bug,必須修復。

### Q: 可以跳過某些測試嗎?

A: 不建議。所有測試都是關鍵商業邏輯,跳過測試可能導致生產環境出現嚴重問題。

### Q: 如何在 CI/CD 中運行這些測試?

A: 在 CI/CD pipeline 中添加:

```yaml
- name: Run Strict Business Logic Tests
  run: |
    cd chat-app/backend
    npm run dev:with-emulator &
    sleep 10
    node scripts/test-all-business-logic-strict.js
```

## 📞 支持

如果測試發現問題或需要幫助:
1. 查看測試日誌中的詳細錯誤信息
2. 查看相關代碼的 Transaction 實現
3. 檢查 Firestore 數據狀態
4. 必要時添加更多日誌輸出

---

**最後更新**: 2025-01-16
**作者**: Claude Code (嚴格測試版本)
