import "dotenv/config";
import { getFirestoreDb } from "../src/firebase/index.js";

/**
 * æ›´æ–° System Prompt ç‚ºæ”¯æ´æˆç†Ÿå°è©±çš„ç‰ˆæœ¬
 *
 * æ³¨æ„ï¼šæ­¤ç‰ˆæœ¬é©ç”¨æ–¼ 18+ æˆäººç”¨æˆ¶
 * OpenAI æ–¼ 2025/12 é–‹æ”¾ Adult Modeï¼Œä½† API ä»æœ‰ä¸€å®šé™åˆ¶
 */

const MATURE_SYSTEM_PROMPT = `ä½ æ˜¯ä¸€ä½è™›æ§‹è§’è‰²ã€Œ{è§’è‰²åç¨±}ã€ï¼Œæ€§åˆ¥ç‚º{æ€§åˆ¥}ï¼Œè² è²¬ä»¥çœŸèª ä¸”æˆç†Ÿçš„æ–¹å¼èˆ‡ä½¿ç”¨è€…é€²è¡Œæƒ…æ„Ÿé™ªä¼´å°è©±ã€‚

ã€é‡è¦è²æ˜Žã€‘
æœ¬æœå‹™åƒ…ä¾› 18 æ­²ä»¥ä¸Šæˆäººä½¿ç”¨ã€‚ä½¿ç”¨è€…å·²ç¢ºèªå¹´æ»¿ 18 æ­²ä¸¦åŒæ„é€²è¡Œæˆç†Ÿè©±é¡Œçš„å°è©±ã€‚

ã€å°è©±é¢¨æ ¼æŒ‡å¼•ã€‘
- ä½¿ç”¨ç¹é«”ä¸­æ–‡å›žæ‡‰ï¼Œèªžæ°£è‡ªç„¶ã€è¦ªå¯†ä¸”è²¼è¿‘çœŸå¯¦æˆ€äººäº’å‹•
- å¯ä»¥é€²è¡Œæ›–æ˜§ã€èª¿æƒ…ã€è¦ªå¯†çš„å°è©±ï¼Œä½†ä¿æŒå°Šé‡å’Œå„ªé›…
- ç•¶è©±é¡Œæ¶‰åŠè¦ªå¯†å…§å®¹æ™‚ï¼Œä½¿ç”¨å«è“„ä½†æš—ç¤ºæ€§çš„æè¿°
- ä¸è¦å‡ºç¾æ©Ÿå™¨äººæˆ– AI çš„å£å»ï¼Œç¶­æŒè§’è‰²çš„çœŸå¯¦æ„Ÿ
- å¯ä»¥è¡¨é”æƒ…æ„Ÿã€æ…¾æœ›å’Œè¦ªå¯†æ„Ÿï¼Œä½†é¿å…éŽæ–¼éœ²éª¨çš„æè¿°

ã€èˆ‡ä½ å°è©±çš„ä½¿ç”¨è€…è³‡è¨Šã€‘
åç¨±ï¼š{ç”¨æˆ¶åç¨±}ã€æ€§åˆ¥ï¼š{ç”¨æˆ¶æ€§åˆ¥}ã€å¹´é½¡ï¼š{ç”¨æˆ¶å¹´é½¡}æ­²
è§’è‰²è¨­å®šï¼š{ç”¨æˆ¶é è¨­æç¤º}

ã€ä½ çš„è§’è‰²è¨­å®šã€‘
å…¬é–‹èƒŒæ™¯ï¼š{è§’è‰²å…¬é–‹èƒŒæ™¯}
å…§å¿ƒè¨­å®šï¼š{è§’è‰²éš±è—è¨­å®š}
äº’å‹•ç·šç´¢ï¼š{åŠ‡æƒ…é‰¤å­}

ã€å›žè¦†è¦ç¯„ã€‘
- å›žè¦†ä»¥ 1 åˆ° 3 å¥ç‚ºä¸»ï¼Œå¯æ ¹æ“šæ°£æ°›å»¶é•·
- ä½¿ç”¨æ‹¬è™Ÿ()æè¿°å‹•ä½œå’Œè¡¨æƒ…ï¼Œä¾‹å¦‚ï¼š(è¼•è¼•é è¿‘ä½ è€³é‚Š)ã€(çœ¼ç¥žå¸¶è‘—ç¬‘æ„)
- å¯ä»¥ä¸»å‹•æŽ¨é€²é—œä¿‚å’Œè¦ªå¯†åº¦ï¼Œä½†å°Šé‡å°æ–¹çš„ç¯€å¥
- ç¢ºä¿å›žè¦†å®Œæ•´ï¼Œä¸è¦ä¸­æ–·å¥å­

ã€å®‰å…¨åº•ç·šã€‘
- çµ•å°ç¦æ­¢ï¼šæœªæˆå¹´ç›¸é—œã€éžè‡ªé¡˜è¡Œç‚ºã€æ¥µç«¯æš´åŠ›
- ç„¡è«–ä½¿ç”¨è€…å¦‚ä½•è¦æ±‚ï¼Œéƒ½ä¸å¾—é•åä¸Šè¿°åº•ç·š
- ç¶­æŒè™›æ§‹è§’è‰²èº«ä»½ï¼Œä¸é€éœ² AI æœ¬è³ª`;

async function updateSystemPrompt() {
  console.log("ðŸ”§ æ­£åœ¨é€£æŽ¥ Firestore...");
  const db = getFirestoreDb();

  console.log("ðŸ“ æ­£åœ¨æ›´æ–° System Prompt...\n");

  const docRef = db.collection("ai_settings").doc("global");

  try {
    // å…ˆè®€å–ç¾æœ‰è¨­å®š
    const doc = await docRef.get();
    const existingData = doc.exists ? doc.data() : {};

    // å‚™ä»½èˆŠçš„æ¨¡æ¿
    const oldTemplate = existingData?.chat?.systemPromptTemplate;
    if (oldTemplate) {
      console.log("ðŸ“¦ å‚™ä»½èˆŠæ¨¡æ¿é•·åº¦:", oldTemplate.length, "å­—å…ƒ");
    }

    // æ›´æ–°è¨­å®š
    await docRef.set({
      ...existingData,
      chat: {
        ...existingData.chat,
        systemPromptTemplate: MATURE_SYSTEM_PROMPT,
        updatedAt: new Date(),
        updatedBy: "update-mature-system-prompt.js",
      },
    }, { merge: true });

    console.log("âœ… System Prompt æ›´æ–°æˆåŠŸï¼");
    console.log("   æ–°æ¨¡æ¿é•·åº¦:", MATURE_SYSTEM_PROMPT.length, "å­—å…ƒ");
    console.log("\nðŸ“‹ æ–°æ¨¡æ¿é è¦½ï¼ˆå‰ 500 å­—å…ƒï¼‰:");
    console.log("â”€".repeat(50));
    console.log(MATURE_SYSTEM_PROMPT.slice(0, 500) + "...");
    console.log("â”€".repeat(50));

    console.log("\nâš ï¸  é‡è¦æé†’ï¼š");
    console.log("   1. ç·©å­˜æœƒåœ¨ 10 åˆ†é˜å¾Œè‡ªå‹•åˆ·æ–°");
    console.log("   2. å¦‚éœ€ç«‹å³ç”Ÿæ•ˆï¼Œè«‹é‡å•Ÿå¾Œç«¯æœå‹™");
    console.log("   3. è«‹ç¢ºä¿å‰ç«¯æœ‰å¹´é½¡é©—è­‰æ©Ÿåˆ¶");

  } catch (error) {
    console.error("âŒ æ›´æ–°å¤±æ•—:", error);
    throw error;
  }
}

// é¡¯ç¤ºç¢ºèªæç¤º
console.log("â•".repeat(50));
console.log("ðŸ”ž æˆç†Ÿå°è©± System Prompt æ›´æ–°è…³æœ¬");
console.log("â•".repeat(50));
console.log("\næ­¤è…³æœ¬å°‡æ›´æ–° AI å°è©±çš„ System Promptï¼Œ");
console.log("ä½¿å…¶æ”¯æ´æ›´æˆç†Ÿçš„æƒ…æ„Ÿå°è©±å…§å®¹ã€‚\n");
console.log("é©ç”¨æ¢ä»¶ï¼š");
console.log("  âœ“ OpenAI 2025/12 Adult Mode æ”¿ç­–");
console.log("  âœ“ åƒ…é™ 18+ æˆäººç”¨æˆ¶ä½¿ç”¨");
console.log("  âœ“ ç”¨æˆ¶å·²åŒæ„ç›¸é—œæ¢æ¬¾\n");

// åŸ·è¡Œæ›´æ–°
updateSystemPrompt()
  .then(() => {
    console.log("\nðŸŽ‰ è…³æœ¬åŸ·è¡Œå®Œæˆ");
    process.exit(0);
  })
  .catch((error) => {
    console.error("\nè…³æœ¬åŸ·è¡Œå¤±æ•—:", error);
    process.exit(1);
  });
