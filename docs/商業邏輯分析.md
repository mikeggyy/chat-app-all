# 商業邏輯完整分析（基於程式碼）

> 最後更新：2025-11-30
> 本文檔基於實際程式碼梳理，非假設或推測

---

## 一、功能與 API 成本對照表

### 1.1 所有會觸發 API 成本的功能

| 功能 | 觸發時機 | API 調用 | 單次成本估算 (TWD) |
|-----|---------|---------|-------------------|
| **對話** | 用戶發送訊息 | GPT-4o-mini | ~0.06-0.12 |
| **快速建議** | 打開聊天室 | GPT-4o-mini | ~0.06 |
| **語音播放** | 點擊播放按鈕 | Google TTS | ~0.008 |
| **AI 拍照** | 用戶請求拍照 | Gemini 圖片生成 | ~1.5-2.0 |
| **AI 影片** | 用戶請求影片 | Veo/Replicate | ~6-15 |
| **送禮物** | 用戶送禮 | GPT-4o-mini + Gemini 圖片 | **~1.6** |
| **角色創建** | 創建新角色 | GPT-4o + OpenAI 圖片生成 | ~3-5 |

### 1.2 成本計算詳情

#### 對話系統 (`ai.service.js`)
```
觸發：每次用戶發送訊息
API：GPT-4o-mini (預設) 或 GPT-4o (VVIP/藥水效果)

Token 消耗：
- 系統提示詞：~400-600 tokens
- 對話歷史（最多 12 條）：~600-1200 tokens
- 用戶訊息：~50-100 tokens
- AI 回覆：~100-150 tokens

成本（GPT-4o-mini）：
- Input: $0.15/1M tokens
- Output: $0.60/1M tokens
- 每次對話：~0.06-0.12 TWD
```

#### 快速建議系統 (`ai.service.js`)
```
觸發：每次打開聊天室
API：GPT-4o-mini
輸出：3 個建議選項

Token 消耗：
- 系統提示詞：~200 tokens
- 對話歷史（最近 6 條）：~300-600 tokens
- AI 回覆（JSON）：~100 tokens

成本：~0.06 TWD/次
```

#### 語音播放 (`googleTts.service.js`)
```
觸發：用戶點擊播放語音
API：Google Cloud TTS（預設）或 OpenAI TTS

成本：
- Google TTS: $16/100 萬字符
- 平均回覆 100 字：~0.008 TWD

緩存機制：
- 相同文字不重複生成
- 實際成本更低
```

#### AI 拍照 (`gemini.service.js`)
```
觸發：用戶請求 AI 拍照
API：Gemini 2.5 Flash Image

流程：
1. 下載角色參考圖片
2. 構建場景提示詞
3. 調用 Gemini 生成圖片
4. 壓縮為 WebP 格式
5. 上傳到 Firebase Storage
6. 保存到相簿

成本：~1.5-2.0 TWD/張
```

#### AI 影片 (`video.service.js`)
```
觸發：用戶請求 AI 影片
API：Veo 3.1 / Replicate SVD

成本：
- Veo 3.1 Fast: ~6-15 TWD/支
- Replicate SVD: ~0.5-1 TWD/支

⚠️ 高成本功能，需嚴格限制
```

#### 🔴 送禮物 (`giftResponse.service.js`)
```
觸發：用戶送禮物給角色
API：GPT-4o-mini + Gemini 圖片生成

完整流程：
1. 扣除用戶金幣
2. 生成 AI 感謝訊息（GPT-4o-mini）→ ~0.06 TWD
3. 生成 AI 感謝照片（Gemini）→ ~1.5 TWD
4. 保存訊息到對話歷史
5. 保存照片到相簿

總成本：~1.56 TWD/次

⚠️ 重要：每次送禮都會觸發圖片生成！
禮物價格（金幣）vs 實際成本（TWD）：
- 玫瑰花 10 金幣 → 成本 1.56 TWD → 可能虧損！
- 咖啡 15 金幣 → 成本 1.56 TWD → 可能虧損！
- 巧克力 20 金幣 → 成本 1.56 TWD → 勉強持平
```

#### 角色創建 (`characterCreation.ai.js`)
```
觸發：用戶創建新角色
API：多個 AI 魔術師

AI 魔術師 1 - 角色設定生成：
- API：GPT-4o（有圖片時）或 GPT-4o-mini
- 輸出：名字、背景、隱藏設定、開場白
- 成本：~0.1-0.5 TWD

AI 魔術師 2 - 角色圖片生成：
- API：OpenAI gpt-image-1-mini
- 輸出：4 張候選圖片
- 成本：~2-3 TWD

AI 魔術師 3 - 外觀描述生成：
- API：GPT-4o（有圖片時）或 GPT-4o-mini
- 輸出：150-200 字外觀描述
- 成本：~0.1-0.5 TWD

總成本：~3-5 TWD/次
```

---

## 二、現有機制詳解

### 2.1 角色解鎖機制（`unlockTickets.service.js`）

```javascript
// 🔴 重要：現在是 7 天臨時解鎖，不是永久解鎖！
const unlockDays = 7;
const unlockUntil = new Date(now.getTime() + unlockDays * 24 * 60 * 60 * 1000);

// 解鎖後的效果
limitData.conversation[characterId].temporaryUnlockUntil = unlockUntil.toISOString();
limitData.conversation[characterId].permanentUnlock = false;
```

**解鎖方式**：
1. 使用「角色解鎖卡」→ 7 天無限對話
2. VVIP 會員 → 所有角色免費解鎖（永久）
3. 金幣購買 → 7 天無限對話

### 2.2 禮物系統機制（`gift.routes.js` + `giftResponse.service.js`）

**禮物價格範圍**（金幣）：
| 稀有度 | 價格範圍 | 禮物範例 |
|-------|---------|---------|
| common | 10-25 | 玫瑰花、咖啡、巧克力、冰淇淋 |
| uncommon | 30-60 | 蛋糕、花束、泰迪熊、香水 |
| rare | 70-120 | 口紅、手錶、戒指、項鍊 |
| epic | 150-300 | 名牌包、鑽石、玫瑰花海 |
| legendary | 400-2000 | 跑車、皇冠、豪宅、私人島嶼、火箭 |

**送禮完整流程**：
```
1. POST /api/gifts/send
   - 檢查金幣餘額
   - 扣除金幣
   - 記錄交易

2. POST /api/gifts/response
   - 生成 AI 感謝訊息（GPT-4o-mini）
   - 生成 AI 感謝照片（Gemini）← 主要成本！
   - 保存到對話歷史
   - 保存到相簿

3. 如果失敗
   - POST /api/gifts/refund 退還金幣
```

### 2.3 對話限制機制（`limits.js`）

```javascript
// 每日對話次數限制（每個角色獨立計算）
CONVERSATION_LIMITS = {
  FREE_PER_CHARACTER: 10,   // 免費用戶
  VIP_PER_CHARACTER: 20,    // VIP
  VVIP_PER_CHARACTER: 50,   // VVIP

  // 廣告解鎖
  FREE_UNLOCKED_PER_AD: 5,  // 免費用戶每次廣告+5次
  VIP_UNLOCKED_PER_AD: 10,  // VIP每次廣告+10次
  VVIP_UNLOCKED_PER_AD: 20, // VVIP每次廣告+20次

  RESET_PERIOD: "daily"     // 每日凌晨重置
}
```

### 2.4 語音限制機制

```javascript
VOICE_LIMITS = {
  FREE_PER_CHARACTER: 10,   // 免費用戶每角色10次
  PAID_UNLIMITED: -1,       // VIP/VVIP 無限制

  // 廣告解鎖（僅免費用戶）
  FREE_DAILY_AD_LIMIT: 10,
  UNLOCKED_PER_AD: 5,

  RESET_PERIOD: "daily"
}
```

### 2.5 拍照限制機制

```javascript
PHOTO_LIMITS = {
  FREE_LIFETIME: 3,         // 免費用戶終生3次
  VIP_MONTHLY: 0,           // VIP 使用卡片
  VVIP_MONTHLY: 0,          // VVIP 使用卡片

  // 開通時贈送的拍照卡
  // VIP: 20 張
  // VVIP: 60 張
}
```

---

## 三、成本問題分析

### 3.1 🔴 禮物系統成本倒掛問題

**問題**：每次送禮都會生成 AI 照片，成本約 1.56 TWD

| 禮物 | 價格(金幣) | 金幣價值(TWD) | API成本(TWD) | 盈虧 |
|-----|----------|--------------|-------------|------|
| 玫瑰花 | 10 | ~3.5 | 1.56 | ✅ +1.94 |
| 咖啡 | 15 | ~5.25 | 1.56 | ✅ +3.69 |
| 巧克力 | 20 | ~7.0 | 1.56 | ✅ +5.44 |
| 鑽石 | 200 | ~70 | 1.56 | ✅ +68.44 |
| 火箭 | 2000 | ~700 | 1.56 | ✅ +698.44 |

> 金幣價值按「超值包 500 金幣 = 299 TWD」計算，約 0.35 TWD/金幣

**結論**：在金幣定價合理的情況下，禮物系統是盈利的。
但如果金幣價格太便宜（如免費贈送大量金幣），則會虧損。

### 3.2 🔴 角色創建成本問題

**成本**：每次創建約 3-5 TWD

| 會員等級 | 每月免費額度 | 開通贈送卡片 | 總可用次數 |
|---------|------------|-------------|----------|
| 免費 | 3 次/月 | 0 | 3 次 |
| VIP | 3 次/月 | 10 張 | 13 次（首月） |
| VVIP | 3 次/月 | 30 張 | 33 次（首月） |

**問題**：如果用戶大量創建角色，成本會很高
- VVIP 首月創建 33 個角色 → 成本 ~130 TWD
- VVIP 月費 999 TWD → 還有餘裕

### 3.3 🟡 對話成本分析

假設用戶每日行為：
```
打開聊天室 3 次 → 建議生成：3 × 0.06 = 0.18 TWD
對話 20 次 → AI 回覆：20 × 0.09 = 1.80 TWD
語音 10 次 → TTS：10 × 0.008 = 0.08 TWD
───────────────────────────────────────
每日成本：~2.06 TWD
每月成本：~62 TWD
```

| 會員等級 | 月費(TWD) | 預估月成本 | 毛利 |
|---------|----------|-----------|------|
| 免費 | 0 | ~40 | ❌ -40 |
| VIP | 399 | ~80 | ✅ +319 |
| VVIP | 999 | ~120 | ✅ +879 |

---

## 四、優化建議

### 4.1 禮物系統優化

**方案 A：根據禮物價格決定是否生成照片**
```javascript
// 建議修改 giftResponse.service.js
const shouldGeneratePhoto = (giftPrice) => {
  // 只有 uncommon 以上（30金幣+）才生成照片
  return giftPrice >= 30;
};

// common 禮物使用預設回覆
const PRESET_RESPONSES = {
  common: [
    "謝謝你的禮物！💕",
    "好開心收到禮物～",
    "你對我太好了！"
  ]
};
```

**方案 B：根據禮物稀有度決定回覆方式**
| 稀有度 | 回覆方式 | 成本 |
|-------|---------|------|
| common | 預設文字 | 0 TWD |
| uncommon | AI 文字 | 0.06 TWD |
| rare | AI 文字 + 選擇現有照片 | 0.06 TWD |
| epic | AI 文字 + AI 照片 | 1.56 TWD |
| legendary | AI 文字 + AI 照片 + 特效 | 1.56 TWD |

### 4.2 角色解鎖機制建議

**現狀**：7 天臨時解鎖

**建議選項**：
1. **保持 7 天** - 促進重複消費
2. **30 天解鎖** - 提高單次付費感知價值
3. **永久解鎖** - 簡化用戶心智模型
4. **訂閱制** - 解鎖期間持續有效

### 4.3 免費用戶成本控制

**問題**：免費用戶無收入但有成本

**解決方案**：
1. 廣告收入覆蓋成本（需要 5+ 次廣告/天）
2. 降低免費用戶的 AI 品質（更短回覆）
3. 降低建議生成頻率（緩存更久）
4. 限制高成本功能（拍照、影片）

---

## 五、平台抽成影響

### 5.1 抽成比例

| 平台 | 抽成 | 實際到手 |
|-----|------|---------|
| Google Play（小開發者） | 15% | 85% |
| Google Play（一般） | 30% | 70% |
| Apple App Store（首年） | 30% | 70% |
| Apple App Store（續訂） | 15% | 85% |
| 網頁自有金流 | 2.5% | 97.5% |

### 5.2 考慮抽成後的會員定價

| 會員 | 售價 | 到手(70%) | 月成本 | 淨利 | 毛利率 |
|-----|------|----------|-------|------|-------|
| VIP | 399 | 279 | ~80 | 199 | 71% |
| VVIP | 999 | 699 | ~150 | 549 | 79% |

---

## 六、配置文件位置索引

| 配置 | 文件位置 |
|-----|---------|
| 功能限制 | `backend/src/config/limits.js` |
| 禮物定義 | `shared/config/gifts.js` |
| 會員等級 | `backend/src/membership/membership.config.js` |
| AI 設定 | Firestore `ai_settings/global` |
| 金幣包 | `shared/config/assetPackages.js` |
| 藥水系統 | `shared/config/potions.js` |

---

## 七、關鍵發現總結

1. **禮物系統每次都會生成照片** - 成本 ~1.56 TWD/次
2. **角色解鎖是 7 天臨時解鎖** - 不是永久解鎖
3. **建議系統每次打開聊天室都會觸發** - 成本 ~0.06 TWD/次
4. **角色創建成本較高** - ~3-5 TWD/次
5. **免費用戶有成本但無收入** - 需要廣告覆蓋

---

_本文檔基於程式碼分析，如有更新請同步修改_
