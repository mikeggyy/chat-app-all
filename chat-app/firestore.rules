rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // 用戶只能讀寫自己的數據
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // 對話數據 - 用戶只能訪問自己的對話
    match /conversations/{conversationId} {
      allow read, write: if request.auth != null &&
        conversationId.matches('^' + request.auth.uid + '::.*');
    }

    // 使用限制 - 用戶只能訪問自己的限制記錄
    match /usage_limits/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // 角色數據 - 所有認證用戶可讀
    match /characters/{characterId} {
      allow read: if request.auth != null;
      allow write: if false; // 只能由後端管理
    }

    // 交易記錄 - 用戶只能訪問自己的交易
    match /transactions/{transactionId} {
      allow read, write: if request.auth != null &&
        resource.data.userId == request.auth.uid;
    }

    // 廣告觀看統計 - 用戶只能讀取自己的統計，只能由後端寫入
    // ✅ P0-1 安全規則：防止前端偽造廣告觀看記錄
    match /ad_watch_stats/{userId} {
      // 用戶可以讀取自己的廣告統計（用於顯示剩餘次數）
      allow read: if request.auth != null && request.auth.uid == userId;

      // ⚠️ 禁止前端直接寫入（只能由後端 Admin SDK 寫入）
      // 這確保了廣告觀看驗證的安全性
      allow write: if false;
    }

    // 禮物交易記錄 - 用戶只能讀取自己的記錄
    match /gift_transactions/{transactionId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow write: if false; // 只能由後端寫入
    }

    // 會員變更歷史 - 用戶只能讀取自己的記錄
    match /membership_history/{historyId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow write: if false; // 只能由後端寫入
    }

    // 用戶子集合：角色禮物統計
    match /users/{userId}/character_gift_stats/{characterId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false; // 只能由後端寫入
    }

    // 廣告觀看事件記錄 - 只能由後端寫入（用於異常檢測）
    match /ad_watch_events/{eventId} {
      allow read: if false; // 用戶無需讀取
      allow write: if false; // 只能由後端寫入
    }

    // 廣告異常告警 - 只能由後端管理
    match /ad_anomaly_alerts/{alertId} {
      allow read: if false; // 僅管理員可讀（通過後端 API）
      allow write: if false; // 只能由後端寫入
    }

    // 冪等性 Key - 只能由後端管理（防止重複消耗）
    // ✅ 冪等性系統：確保支付、解鎖等操作不會重複執行
    match /idempotency_keys/{keyId} {
      allow read: if false; // 用戶無需讀取
      allow write: if false; // 只能由後端寫入
    }

    // ========== 新增功能集合 ==========

    // 閃購活動 - 所有認證用戶可讀，只能由後端管理
    match /flash_sales/{saleId} {
      allow read: if request.auth != null;
      allow write: if false; // 只能由後端（管理員）寫入
    }

    // 登入獎勵記錄 - 用戶只能讀取自己的記錄
    match /login_rewards/{rewardId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow write: if false; // 只能由後端寫入
    }

    // 特殊優惠 - 所有認證用戶可讀，只能由後端管理
    match /special_offers/{offerId} {
      allow read: if request.auth != null;
      allow write: if false; // 只能由後端（管理員）寫入
    }

    // 角色創建流程 - 用戶只能訪問自己的創建流程
    match /character_creation_flows/{flowId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow write: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // 用戶照片相簿 - 用戶只能訪問自己的照片
    match /user_photos/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      match /photos/{photoId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // 用戶子集合：組合禮包購買記錄
    match /users/{userId}/bundle_purchases/{bundleId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false; // 只能由後端寫入
    }

    // 用戶子集合：角色等級
    match /users/{userId}/character_levels/{characterId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false; // 只能由後端寫入
    }

    // 用戶子集合：對話記錄
    match /users/{userId}/conversations/{characterId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // 用戶子集合：收藏角色
    match /users/{userId}/favorites/{favoriteId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // 開發環境：允許所有操作（僅在 Emulator 模式）
    // ⚠️ 警告：此規則在生產環境已被禁用以確保安全性
    // 如需在開發環境使用寬鬆規則，請在本地 Firebase Emulator 中配置
    // match /{document=**} {
    //   allow read, write: if request.time < timestamp.date(2099, 1, 1);
    // }
  }
}
