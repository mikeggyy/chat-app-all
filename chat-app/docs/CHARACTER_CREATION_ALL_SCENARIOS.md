# è§’è‰²å‰µå»ºå®Œæ•´è¡Œç‚ºåˆ†æ

## ğŸ“‹ æ‰€æœ‰å¯èƒ½çš„å‰µå»ºè·¯å¾‘

### A. æˆåŠŸå‰µå»ºï¼ˆHappy Pathsï¼‰
### B. å¤±æ•—å‰µå»ºï¼ˆError Pathsï¼‰
### C. ä¸­æ–·/æ¢å¾©ï¼ˆInterruption & Recovery Pathsï¼‰

---

## ğŸ¯ ç‹€æ…‹æ©Ÿæ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     è§’è‰²å‰µå»ºç‹€æ…‹æ©Ÿ                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[ç”¨æˆ¶é€²å…¥] â†’ [æ€§åˆ¥é¸æ“‡] â†’ [å¤–è§€è¨­è¨ˆ] â†’ [åœ–ç‰‡ç”Ÿæˆ] â†’ [è§’è‰²è¨­å®š] â†’ [èªéŸ³é¸æ“‡] â†’ [å‰µå»ºå®Œæˆ]
               â†“            â†“            â†“            â†“            â†“            â†“
             [é€€å‡º]      [é€€å‡º]      [ç¶²è·¯ä¸­æ–·]    [é€€å‡º]      [é€€å‡º]      [ä¿å­˜å¤±æ•—]
               â†“            â†“            â†“            â†“            â†“            â†“
           [æ¸…é™¤ç‹€æ…‹]  [ä¿ç•™ç‹€æ…‹]  [ä¿ç•™flow]   [ä¿ç•™ç‹€æ…‹]  [ä¿ç•™ç‹€æ…‹]   [é‡è©¦/æ”¾æ£„]
```

### ç‹€æ…‹å®šç¾©

1. **draft** - åˆå§‹ç‹€æ…‹ï¼ˆå°šæœªé–‹å§‹ï¼‰
2. **gender_selected** - å·²é¸æ“‡æ€§åˆ¥
3. **appearance_editing** - æ­£åœ¨ç·¨è¼¯å¤–è§€
4. **appearance_confirmed** - å¤–è§€å·²ç¢ºèªï¼ˆflow å·²å‰µå»ºï¼‰
5. **generating** - åœ–ç‰‡ç”Ÿæˆä¸­
6. **generation_completed** - åœ–ç‰‡ç”Ÿæˆå®Œæˆ
7. **persona_editing** - æ­£åœ¨ç·¨è¼¯è§’è‰²è¨­å®š
8. **persona_confirmed** - è§’è‰²è¨­å®šå·²ç¢ºèª
9. **voice_selecting** - æ­£åœ¨é¸æ“‡èªéŸ³
10. **saving** - ä¿å­˜ä¸­
11. **completed** - å‰µå»ºå®Œæˆ
12. **failed** - å‰µå»ºå¤±æ•—

---

## A. æˆåŠŸå‰µå»ºè·¯å¾‘

### A1. å®Œæ•´æˆåŠŸè·¯å¾‘ï¼ˆæœ‰å…è²»æ¬¡æ•¸ï¼Œä¸ä½¿ç”¨ AIï¼‰

```
æ­¥é©Ÿ 1ï¼šé€²å…¥æ€§åˆ¥é¸æ“‡é é¢
â”œâ”€ æ¸…é™¤ localStorage: character-create-flow-id
â”œâ”€ æ¸…é™¤ sessionStorage: character-create-summary
â”œâ”€ æ¸…é™¤ sessionStorage: characterCreation.gender
â”œâ”€ æª¢æŸ¥ç”¨æˆ¶ç™»å…¥ç‹€æ…‹
â”œâ”€ æŸ¥è©¢å‰©é¤˜å‰µå»ºæ¬¡æ•¸ï¼ˆAPI: GET /api/character-creation/limits/:userIdï¼‰
â”‚  â””â”€ å›æ‡‰: { remaining: 3, total: 3, used: 0 }
â””â”€ é¡¯ç¤ºæ€§åˆ¥é¸é …

æ­¥é©Ÿ 2ï¼šé¸æ“‡æ€§åˆ¥ï¼ˆä¾‹å¦‚ï¼šfemaleï¼‰
â”œâ”€ ä¿å­˜åˆ° sessionStorage: characterCreation.gender = 'female'
â”œâ”€ è·³è½‰åˆ°å¤–è§€è¨­è¨ˆé é¢
â””â”€ ç‹€æ…‹: gender_selected

æ­¥é©Ÿ 3ï¼šå¤–è§€è¨­è¨ˆé é¢
â”œâ”€ è®€å– sessionStorage: characterCreation.gender = 'female'
â”œâ”€ ç”¨æˆ¶å¡«å¯«å½¢è±¡æè¿°ï¼šã€Œä¸€å€‹å¯æ„›çš„å¥³å­©ï¼Œæœ‰é•·é•·çš„é»‘é«®å’Œå¤§å¤§çš„çœ¼ç›ã€
â”œâ”€ é¸æ“‡é¢¨æ ¼æ¨™ç±¤ï¼š['anime', 'cute']
â”œâ”€ ï¼ˆå¯é¸ï¼‰ä¸Šå‚³åƒè€ƒåœ–ç‰‡
â””â”€ ç‹€æ…‹: appearance_editing

æ­¥é©Ÿ 4ï¼šé»æ“Šã€Œç¢ºèªç”Ÿæˆã€
â”œâ”€ é©—è­‰æè¿°ä¸ç‚ºç©º
â”œâ”€ å‰µå»º flowï¼ˆAPI: POST /api/character-creation/flowsï¼‰
â”‚  â”œâ”€ è«‹æ±‚:
â”‚  â”‚  {
â”‚  â”‚    status: 'appearance',
â”‚  â”‚    appearance: {
â”‚  â”‚      description: 'ä¸€å€‹å¯æ„›çš„å¥³å­©...',
â”‚  â”‚      styles: ['anime', 'cute'],
â”‚  â”‚      referenceInfo: null
â”‚  â”‚    },
â”‚  â”‚    metadata: { gender: 'female' }
â”‚  â”‚  }
â”‚  â””â”€ å›æ‡‰:
â”‚     {
â”‚       flow: {
â”‚         id: 'flow-abc123',
â”‚         userId: 'user-123',
â”‚         status: 'appearance',
â”‚         ...
â”‚       }
â”‚     }
â”œâ”€ ä¿å­˜ flow ID åˆ° localStorage: character-create-flow-id = 'flow-abc123'
â”œâ”€ è·³è½‰åˆ°ç”Ÿæˆé é¢
â””â”€ ç‹€æ…‹: appearance_confirmed

æ­¥é©Ÿ 5ï¼šç”Ÿæˆé é¢è¼‰å…¥
â”œâ”€ è®€å– localStorage: character-create-flow-id = 'flow-abc123'
â”œâ”€ æª¢æŸ¥ flow æ˜¯å¦å·²æœ‰ç”Ÿæˆçš„åœ–ç‰‡ï¼ˆAPI: GET /api/character-creation/flows/flow-abc123ï¼‰
â”‚  â””â”€ å›æ‡‰: flow.generation.status = 'idle'ï¼ˆå°šæœªç”Ÿæˆï¼‰
â”œâ”€ é–‹å§‹é€²åº¦å‹•ç•«ï¼ˆ18% â†’ 90%ï¼‰
â”œâ”€ èª¿ç”¨åœ–ç‰‡ç”Ÿæˆ APIï¼ˆPOST /api/character-creation/flows/flow-abc123/generate-imagesï¼‰
â”‚  â”œâ”€ è«‹æ±‚:
â”‚  â”‚  {
â”‚  â”‚    quality: 'low',
â”‚  â”‚    count: 4,
â”‚  â”‚    idempotencyKey: 'flow-abc123-images'
â”‚  â”‚  }
â”‚  â””â”€ ç‹€æ…‹: generating
â””â”€ å¾Œç«¯è™•ç†é‚è¼¯...

å¾Œç«¯æ­¥é©Ÿ 5.1ï¼šæª¢æŸ¥ flow
â”œâ”€ ç²å– flowï¼ˆflowId: 'flow-abc123'ï¼‰
â”œâ”€ æª¢æŸ¥ flow.appearance.description å­˜åœ¨
â””â”€ âœ… é€šé

å¾Œç«¯æ­¥é©Ÿ 5.2ï¼šæª¢æŸ¥å‰µå»ºé™åˆ¶
â”œâ”€ èª¿ç”¨ canCreateCharacter(userId)
â”‚  â””â”€ å›æ‡‰: { allowed: true }
â”œâ”€ èª¿ç”¨ getCreationStats(userId)
â”‚  â””â”€ å›æ‡‰: { remaining: 3, used: 0, total: 3 }
â”œâ”€ åˆ¤æ–·: remaining > 0 â†’ æœ‰å…è²»æ¬¡æ•¸
â”œâ”€ shouldRecordCreation = true
â””â”€ usedCreateCard = falseï¼ˆä¸æ‰£é™¤å‰µå»ºå¡ï¼‰

å¾Œç«¯æ­¥é©Ÿ 5.3ï¼šæª¢æŸ¥ Idempotency
â”œâ”€ æª¢æŸ¥ flow.generation.status
â”‚  â””â”€ 'idle' â†’ æœªç”Ÿæˆé
â”œâ”€ æª¢æŸ¥ flow.generation.idempotencyKey
â”‚  â””â”€ null â†’ æœªè¨­ç½®
â””â”€ âœ… éœ€è¦åŸ·è¡Œæ–°çš„ç”Ÿæˆ

å¾Œç«¯æ­¥é©Ÿ 5.4ï¼šç”Ÿæˆåœ–ç‰‡
â”œâ”€ è¨­ç½® flow.generation.status = 'generating'
â”œâ”€ è¨­ç½® flow.generation.idempotencyKey = 'flow-abc123-images'
â”œâ”€ è¨­ç½® flow.generation.startedAt = ç•¶å‰æ™‚é–“
â”œâ”€ èª¿ç”¨ Gemini API ç”Ÿæˆåœ–ç‰‡
â”‚  â”œâ”€ åƒæ•¸:
â”‚  â”‚  {
â”‚  â”‚    gender: 'female',
â”‚  â”‚    description: 'ä¸€å€‹å¯æ„›çš„å¥³å­©...',
â”‚  â”‚    styles: ['anime', 'cute'],
â”‚  â”‚    quality: 'low',
â”‚  â”‚    count: 4
â”‚  â”‚  }
â”‚  â””â”€ ç”Ÿæˆæ™‚é–“: ~30-60 ç§’
â”œâ”€ âœ… ç”ŸæˆæˆåŠŸ
â”œâ”€ è¨­ç½® flow.generation.status = 'completed'
â”œâ”€ è¨­ç½® flow.generation.completedAt = ç•¶å‰æ™‚é–“
â”œâ”€ è¨­ç½® flow.generation.result = { images: [...] }
â””â”€ è¨­ç½® flow.status = 'appearance'

å¾Œç«¯æ­¥é©Ÿ 5.5ï¼šè¨˜éŒ„å‰µå»ºæ¬¡æ•¸
â”œâ”€ æª¢æŸ¥: !reused && shouldRecordCreation â†’ true
â”œâ”€ èª¿ç”¨ recordCreation(userId, flowId)
â”‚  â””â”€ æ›´æ–° usage_limits/{userId}
â”‚     {
â”‚       character_creation: {
â”‚         count: 1,  // 0 + 1
â”‚         history: [
â”‚           { timestamp: '2025-11-09T10:00:00Z', characterId: null }
â”‚         ]
â”‚       }
â”‚     }
â””â”€ âœ… è¨˜éŒ„æˆåŠŸ

å¾Œç«¯æ­¥é©Ÿ 5.6ï¼šè¿”å›çµæœ
â””â”€ å›æ‡‰:
   {
     flow: { ... },
     reused: false,
     images: [
       { url: 'https://storage.googleapis.com/...image1.jpg' },
       { url: 'https://storage.googleapis.com/...image2.jpg' },
       { url: 'https://storage.googleapis.com/...image3.jpg' },
       { url: 'https://storage.googleapis.com/...image4.jpg' }
     ]
   }

æ­¥é©Ÿ 6ï¼šå‰ç«¯æ¥æ”¶åœ–ç‰‡
â”œâ”€ åœæ­¢é€²åº¦å‹•ç•«
â”œâ”€ è¨­ç½® progress = 100%
â”œâ”€ é¡¯ç¤º 4 å¼µç”Ÿæˆçš„åœ–ç‰‡
â”œâ”€ è‡ªå‹•é¸æ“‡ç¬¬ä¸€å¼µåœ–ç‰‡
â””â”€ ç‹€æ…‹: generation_completed

æ­¥é©Ÿ 7ï¼šç”¨æˆ¶é¸æ“‡åœ–ç‰‡
â”œâ”€ é¸æ“‡ç¬¬ 2 å¼µåœ–ç‰‡
â”œâ”€ ä¿å­˜åˆ° sessionStorage: character-create-summary
â”‚  {
â”‚    appearance: {
â”‚      id: 'generated-1',
â”‚      label: 'é¢¨æ ¼ 2',
â”‚      image: 'https://storage.googleapis.com/...image2.jpg'
â”‚    },
â”‚    gender: 'female'
â”‚  }
â””â”€ é»æ“Šã€Œä¸‹ä¸€æ­¥ã€

æ­¥é©Ÿ 8ï¼šé€²å…¥è§’è‰²è¨­å®šæ­¥é©Ÿ
â”œâ”€ å¡«å¯«è§’è‰²åï¼šã€Œå°ç¾ã€
â”œâ”€ å¡«å¯«è§’è‰²è¨­å®šï¼šã€Œæ´»æ½‘å¯æ„›çš„å¥³å­©ï¼Œå–œæ­¡äº¤æœ‹å‹ã€
â”œâ”€ å¡«å¯«éš±è—è¨­å®šï¼šã€Œå…¶å¯¦å¾ˆå®³ç¾ï¼Œå®¹æ˜“è‡‰ç´…ã€
â”œâ”€ å¡«å¯«é–‹å ´ç™½ï¼šã€Œä½ å¥½å‘€ï¼æˆ‘æ˜¯å°ç¾ï¼Œå¾ˆé«˜èˆˆèªè­˜ä½ ï¼ã€
â”œâ”€ æ›´æ–° sessionStorage: character-create-summary
â””â”€ ç‹€æ…‹: persona_editing

æ­¥é©Ÿ 9ï¼šé»æ“Šã€Œä¸‹ä¸€æ­¥ã€ï¼ˆé€²å…¥èªéŸ³é¸æ“‡ï¼‰
â”œâ”€ é©—è­‰æ‰€æœ‰å¿…å¡«æ¬„ä½å·²å¡«å¯«
â”œâ”€ åŒæ­¥åˆ°å¾Œç«¯ï¼ˆAPI: PATCH /api/character-creation/flows/flow-abc123ï¼‰
â”œâ”€ è·³è½‰åˆ°èªéŸ³é¸æ“‡é é¢
â””â”€ ç‹€æ…‹: persona_confirmed

æ­¥é©Ÿ 10ï¼šèªéŸ³é¸æ“‡é é¢
â”œâ”€ è®€å– sessionStorage: character-create-summary
â”œâ”€ é¡¯ç¤ºèªéŸ³åˆ—è¡¨ï¼ˆéæ¿¾ gender = 'female'ï¼‰
â”œâ”€ ç”¨æˆ¶é¸æ“‡èªéŸ³ï¼šã€Œzh-TW-HsiaoChenNeuralã€
â”œâ”€ è©¦è½èªéŸ³ï¼ˆå¯é¸ï¼‰
â””â”€ ç‹€æ…‹: voice_selecting

æ­¥é©Ÿ 11ï¼šé»æ“Šã€Œå®Œæˆå‰µå»ºã€
â”œâ”€ é©—è­‰å·²é¸æ“‡èªéŸ³
â”œâ”€ çµ„è£è§’è‰²æ•¸æ“š:
â”‚  {
â”‚    display_name: 'å°ç¾',
â”‚    background: 'æ´»æ½‘å¯æ„›çš„å¥³å­©ï¼Œå–œæ­¡äº¤æœ‹å‹',
â”‚    secret_background: 'å…¶å¯¦å¾ˆå®³ç¾ï¼Œå®¹æ˜“è‡‰ç´…',
â”‚    first_message: 'ä½ å¥½å‘€ï¼æˆ‘æ˜¯å°ç¾ï¼Œå¾ˆé«˜èˆˆèªè­˜ä½ ï¼',
â”‚    portraitUrl: 'https://storage.googleapis.com/...image2.jpg',
â”‚    gender: 'female',
â”‚    voice: 'zh-TW-HsiaoChenNeural',
â”‚    creator: 'user-123',
â”‚    isPublic: false
â”‚  }
â”œâ”€ èª¿ç”¨ä¿å­˜ APIï¼ˆPOST /api/charactersï¼‰
â”œâ”€ ç‹€æ…‹: saving
â””â”€ å¾Œç«¯ä¿å­˜é‚è¼¯...

å¾Œç«¯æ­¥é©Ÿ 11.1ï¼šä¿å­˜è§’è‰²åˆ° Firestore
â”œâ”€ ç”Ÿæˆ characterId: 'match-1762700000000-abc123'
â”œâ”€ ä¿å­˜åˆ° characters é›†åˆ
â””â”€ âœ… ä¿å­˜æˆåŠŸ

æ­¥é©Ÿ 12ï¼šå‰ç«¯æ¥æ”¶æˆåŠŸå›æ‡‰
â”œâ”€ æ¸…é™¤ localStorage: character-create-flow-id
â”œâ”€ æ¸…é™¤ sessionStorage: character-create-summary
â”œâ”€ æ¸…é™¤ sessionStorage: characterCreation.gender
â”œâ”€ æ¸…é™¤æ‰€æœ‰æ€§åˆ¥çš„ AI Magician è¨ˆæ•¸å™¨:
â”‚  â”œâ”€ sessionStorage.removeItem('ai-magician-usage-male')
â”‚  â”œâ”€ sessionStorage.removeItem('ai-magician-usage-female')
â”‚  â””â”€ sessionStorage.removeItem('ai-magician-usage-non-binary')
â”œâ”€ é¡¯ç¤ºæˆåŠŸå½ˆçª—
â”œâ”€ è·³è½‰åˆ°ã€Œæˆ‘çš„è§’è‰²ã€é é¢
â””â”€ ç‹€æ…‹: completed

æœ€çµ‚ç‹€æ…‹ï¼š
â”œâ”€ ç”¨æˆ¶å…è²»æ¬¡æ•¸: 3 â†’ 2
â”œâ”€ å‰µå»ºå¡æ•¸é‡: 5 â†’ 5ï¼ˆæœªæ‰£é™¤ï¼‰
â”œâ”€ è§’è‰²å·²å‰µå»ºä¸¦ä¿å­˜åˆ° Firestore
â””â”€ æ‰€æœ‰è‡¨æ™‚ç‹€æ…‹å·²æ¸…é™¤
```

---

### A2. å®Œæ•´æˆåŠŸè·¯å¾‘ï¼ˆç„¡å…è²»æ¬¡æ•¸ï¼Œä½¿ç”¨å‰µå»ºå¡ï¼‰

```
æ­¥é©Ÿ 1-4ï¼šåŒ A1

æ­¥é©Ÿ 5ï¼šç”Ÿæˆé é¢è¼‰å…¥ï¼ˆå¾Œç«¯è™•ç†é‚è¼¯ï¼‰

å¾Œç«¯æ­¥é©Ÿ 5.2ï¼šæª¢æŸ¥å‰µå»ºé™åˆ¶ï¼ˆå·®ç•°ï¼‰
â”œâ”€ èª¿ç”¨ getCreationStats(userId)
â”‚  â””â”€ å›æ‡‰: { remaining: 0, used: 3, total: 3 }  // âš ï¸ å…è²»æ¬¡æ•¸ç”¨å®Œ
â”œâ”€ åˆ¤æ–·: remaining <= 0 â†’ å…è²»æ¬¡æ•¸ç”¨å®Œ
â”œâ”€ å˜—è©¦æ‰£é™¤å‰µå»ºå¡:
â”‚  â”œâ”€ èª¿ç”¨ consumeUserAsset(userId, 'createCards', 1)
â”‚  â”œâ”€ æª¢æŸ¥ç”¨æˆ¶å‰µå»ºå¡æ•¸é‡: 5 å¼µ
â”‚  â”œâ”€ âœ… å‰µå»ºå¡è¶³å¤ 
â”‚  â”œâ”€ æ‰£é™¤ 1 å¼µå‰µå»ºå¡: 5 â†’ 4
â”‚  â””â”€ è¨˜éŒ„åˆ° asset_audit_logs:
â”‚     {
â”‚       userId: 'user-123',
â”‚       assetType: 'createCards',
â”‚       action: 'consume',
â”‚       amount: 1,
â”‚       previousQuantity: 5,
â”‚       newQuantity: 4,
â”‚       reason: 'å‰µå»ºè§’è‰²',
â”‚       metadata: { flowId: 'flow-abc123' }
â”‚     }
â”œâ”€ shouldRecordCreation = true
â””â”€ usedCreateCard = true  // âš ï¸ å·²æ‰£é™¤å‰µå»ºå¡

å¾Œç«¯æ­¥é©Ÿ 5.3-5.6ï¼šåŒ A1ï¼ˆç”Ÿæˆåœ–ç‰‡ã€è¨˜éŒ„å‰µå»ºæ¬¡æ•¸ã€è¿”å›çµæœï¼‰

æ­¥é©Ÿ 6-12ï¼šåŒ A1

æœ€çµ‚ç‹€æ…‹ï¼š
â”œâ”€ ç”¨æˆ¶å…è²»æ¬¡æ•¸: 0 â†’ 0ï¼ˆå·²ç”¨å®Œï¼‰
â”œâ”€ å‰µå»ºå¡æ•¸é‡: 5 â†’ 4  // âš ï¸ æ‰£é™¤äº† 1 å¼µ
â”œâ”€ è§’è‰²å·²å‰µå»ºä¸¦ä¿å­˜åˆ° Firestore
â””â”€ æ‰€æœ‰è‡¨æ™‚ç‹€æ…‹å·²æ¸…é™¤
```

---

### A3. å®Œæ•´æˆåŠŸè·¯å¾‘ï¼ˆä½¿ç”¨ AI Magicianï¼‰

```
æ­¥é©Ÿ 1-3ï¼šåŒ A1

æ­¥é©Ÿ 3.1ï¼šä½¿ç”¨ AI Magician ç”Ÿæˆæè¿°ï¼ˆå¤–è§€é é¢ï¼‰
â”œâ”€ è®€å– sessionStorage: ai-magician-usage-female
â”‚  â””â”€ ç•¶å‰å€¼: nullï¼ˆå°šæœªä½¿ç”¨ï¼‰
â”œâ”€ æª¢æŸ¥ä½¿ç”¨æ¬¡æ•¸: 0 < 3 â†’ å¯ä»¥ä½¿ç”¨
â”œâ”€ é»æ“Šã€ŒAI é­”æ³•å¸«ã€æŒ‰éˆ•
â”œâ”€ èª¿ç”¨ APIï¼ˆPOST /api/character-creation/ai-descriptionï¼‰
â”‚  â”œâ”€ è«‹æ±‚:
â”‚  â”‚  {
â”‚  â”‚    gender: 'female',
â”‚  â”‚    styles: ['anime', 'cute'],
â”‚  â”‚    referenceInfo: null
â”‚  â”‚  }
â”‚  â””â”€ å›æ‡‰:
â”‚     {
â”‚       description: 'ä¸€å€‹æ“æœ‰é•·é•·é»‘é«®å’Œå¤§å¤§çœ¼ç›çš„å¯æ„›å¥³å­©ï¼Œç©¿è‘—å¯æ„›çš„æ´‹è£...'
â”‚     }
â”œâ”€ è‡ªå‹•å¡«å…¥æè¿°æ¡†
â”œâ”€ æ›´æ–°è¨ˆæ•¸å™¨: sessionStorage.setItem('ai-magician-usage-female', '1')
â””â”€ é¡¯ç¤ºå‰©é¤˜æ¬¡æ•¸: å‰©é¤˜ 2/3 æ¬¡

æ­¥é©Ÿ 3.2ï¼šç¹¼çºŒç·¨è¼¯æˆ–ç›´æ¥ç¢ºèª
â”œâ”€ ç”¨æˆ¶å¯ä»¥ä¿®æ”¹ AI ç”Ÿæˆçš„æè¿°
â””â”€ é»æ“Šã€Œç¢ºèªç”Ÿæˆã€

æ­¥é©Ÿ 4-12ï¼šåŒ A1

æ­¥é©Ÿ 12.1ï¼šæ¸…é™¤ç‹€æ…‹æ™‚ï¼ˆå·®ç•°ï¼‰
â””â”€ æ¸…é™¤ AI Magician è¨ˆæ•¸å™¨:
   sessionStorage.removeItem('ai-magician-usage-female') = null

æœ€çµ‚ç‹€æ…‹ï¼š
â”œâ”€ AI Magician è¨ˆæ•¸å™¨: 1 â†’ 0ï¼ˆå·²é‡ç½®ï¼‰
â””â”€ å…¶ä»–åŒ A1
```

---

## B. å¤±æ•—å‰µå»ºè·¯å¾‘

### B1. å‰µå»ºå¤±æ•— - å‰µå»ºå¡ä¸è¶³

```
æ­¥é©Ÿ 1-4ï¼šåŒ A1

æ­¥é©Ÿ 5ï¼šç”Ÿæˆé é¢è¼‰å…¥ï¼ˆå¾Œç«¯è™•ç†é‚è¼¯ï¼‰

å¾Œç«¯æ­¥é©Ÿ 5.2ï¼šæª¢æŸ¥å‰µå»ºé™åˆ¶ï¼ˆå¤±æ•—ï¼‰
â”œâ”€ èª¿ç”¨ getCreationStats(userId)
â”‚  â””â”€ å›æ‡‰: { remaining: 0, used: 3, total: 3 }  // å…è²»æ¬¡æ•¸ç”¨å®Œ
â”œâ”€ åˆ¤æ–·: remaining <= 0 â†’ éœ€è¦æ‰£é™¤å‰µå»ºå¡
â”œâ”€ å˜—è©¦æ‰£é™¤å‰µå»ºå¡:
â”‚  â”œâ”€ èª¿ç”¨ consumeUserAsset(userId, 'createCards', 1)
â”‚  â”œâ”€ æª¢æŸ¥ç”¨æˆ¶å‰µå»ºå¡æ•¸é‡: 0 å¼µ  // âŒ å‰µå»ºå¡ä¸è¶³
â”‚  â”œâ”€ âŒ æ‹‹å‡ºéŒ¯èª¤: 'createCards æ•¸é‡ä¸è¶³'
â”‚  â””â”€ è¿”å›éŒ¯èª¤éŸ¿æ‡‰:
â”‚     {
â”‚       message: 'å‰µå»ºå¡æ•¸é‡ä¸è¶³',
â”‚       error: 'INSUFFICIENT_CREATE_CARDS'
â”‚     }
â””â”€ ç‹€æ…‹: failed

æ­¥é©Ÿ 6ï¼šå‰ç«¯æ¥æ”¶éŒ¯èª¤
â”œâ”€ åœæ­¢é€²åº¦å‹•ç•«
â”œâ”€ é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯: ã€Œå‰µå»ºå¡æ•¸é‡ä¸è¶³ã€
â”œâ”€ é¡¯ç¤ºè³¼è²·æŒ‰éˆ•ï¼ˆè·³è½‰åˆ°å•†åº—ï¼‰
â””â”€ ä¿ç•™ flow ID å’Œç‹€æ…‹ï¼ˆç”¨æˆ¶å¯ä»¥è³¼è²·å¾Œé‡è©¦ï¼‰

ç”¨æˆ¶é¸æ“‡ 1ï¼šè³¼è²·å‰µå»ºå¡
â”œâ”€ è·³è½‰åˆ°å•†åº—é é¢
â”œâ”€ è³¼è²·å‰µå»ºå¡ï¼ˆ5 å¼µï¼‰
â”œâ”€ è¿”å›ç”Ÿæˆé é¢
â”œâ”€ åˆ·æ–°é é¢é‡æ–°è§¸ç™¼ç”Ÿæˆ
â””â”€ é‡è©¦æˆåŠŸï¼ˆåƒè¦‹ A2ï¼‰

ç”¨æˆ¶é¸æ“‡ 2ï¼šæ”¾æ£„å‰µå»º
â”œâ”€ è¿”å›é¦–é æˆ–å€‹äººé é¢
â”œâ”€ flow ID ä¿ç•™åœ¨ localStorage
â””â”€ ä¸‹æ¬¡é€²å…¥æ€§åˆ¥é¸æ“‡é é¢æ™‚è¢«æ¸…é™¤

æœ€çµ‚ç‹€æ…‹ï¼š
â”œâ”€ ç”¨æˆ¶å…è²»æ¬¡æ•¸: 0ï¼ˆæœªè®Šï¼‰
â”œâ”€ å‰µå»ºå¡æ•¸é‡: 0ï¼ˆæœªæ‰£é™¤ï¼‰
â”œâ”€ è§’è‰²æœªå‰µå»º
â”œâ”€ flow ä¿ç•™åœ¨å¾Œç«¯è¨˜æ†¶é«”ï¼ˆå°šæœªå®Œæˆï¼‰
â””â”€ è‡¨æ™‚ç‹€æ…‹ä¿ç•™ï¼ˆå¯æ¢å¾©ï¼‰
```

---

### B2. å‰µå»ºå¤±æ•— - åœ–ç‰‡ç”Ÿæˆå¤±æ•—ï¼ˆAPI éŒ¯èª¤ï¼‰

```
æ­¥é©Ÿ 1-4ï¼šåŒ A1

æ­¥é©Ÿ 5ï¼šç”Ÿæˆé é¢è¼‰å…¥

å¾Œç«¯æ­¥é©Ÿ 5.1-5.3ï¼šåŒ A1ï¼ˆæª¢æŸ¥é€šéï¼‰

å¾Œç«¯æ­¥é©Ÿ 5.4ï¼šç”Ÿæˆåœ–ç‰‡ï¼ˆå¤±æ•—ï¼‰
â”œâ”€ è¨­ç½® flow.generation.status = 'generating'
â”œâ”€ èª¿ç”¨ Gemini API ç”Ÿæˆåœ–ç‰‡
â”‚  â”œâ”€ âŒ API éŒ¯èª¤ï¼ˆä¾‹å¦‚ï¼šé…é¡ç”¨å®Œã€æœå‹™æš«æ™‚ä¸å¯ç”¨ï¼‰
â”‚  â””â”€ æ‹‹å‡ºéŒ¯èª¤: 'Gemini API éŒ¯èª¤: é…é¡å·²ç”¨å®Œ'
â”œâ”€ æ•ç²éŒ¯èª¤
â”œâ”€ è¨­ç½® flow.generation.status = 'failed'
â”œâ”€ è¨­ç½® flow.generation.error = { message: 'Gemini API éŒ¯èª¤...' }
â”œâ”€ è¨­ç½® flow.status = 'failed'
â””â”€ è¿”å›éŒ¯èª¤éŸ¿æ‡‰:
   {
     message: 'åœ–åƒç”Ÿæˆæµç¨‹ç™¼ç”ŸéŒ¯èª¤',
     error: 'Gemini API éŒ¯èª¤: é…é¡å·²ç”¨å®Œ'
   }

é‡è¦ï¼šå¦‚æœå·²æ‰£é™¤å‰µå»ºå¡æ€éº¼è¾¦ï¼Ÿ
â”œâ”€ å‰µå»ºå¡å·²åœ¨æ­¥é©Ÿ 5.2 æ‰£é™¤ï¼ˆç„¡æ³•å›æ»¾ï¼‰
â”œâ”€ âŒ å•é¡Œï¼šç”¨æˆ¶æå¤±äº†å‰µå»ºå¡ä½†æ²’æœ‰å¾—åˆ°è§’è‰²
â””â”€ å»ºè­°ï¼šå¯¦ç¾è£œå„Ÿæ©Ÿåˆ¶ï¼ˆé€€é‚„å‰µå»ºå¡æˆ–æä¾›è£œå„Ÿï¼‰

æ­¥é©Ÿ 6ï¼šå‰ç«¯æ¥æ”¶éŒ¯èª¤
â”œâ”€ åœæ­¢é€²åº¦å‹•ç•«
â”œâ”€ é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
â”œâ”€ æä¾›é‡è©¦æŒ‰éˆ•
â””â”€ ä¿ç•™ flow IDï¼ˆå¯ä»¥é‡è©¦ï¼‰

ç”¨æˆ¶é¸æ“‡ï¼šé‡è©¦
â”œâ”€ é»æ“Šé‡è©¦æŒ‰éˆ•
â”œâ”€ å†æ¬¡èª¿ç”¨ç”Ÿæˆ API
â”œâ”€ ä½¿ç”¨ç›¸åŒçš„ idempotencyKey
â”‚  â””â”€ å¾Œç«¯æœƒæª¢æŸ¥ flow.generation.status = 'failed'
â”‚     â””â”€ é‡æ–°åŸ·è¡Œç”Ÿæˆï¼ˆä¸æœƒé‡è¤‡æ‰£é™¤å‰µå»ºå¡ï¼‰
â””â”€ å¦‚æœæˆåŠŸ â†’ åƒè¦‹ A1

æœ€çµ‚ç‹€æ…‹ï¼ˆå¤±æ•—æƒ…æ³ï¼‰ï¼š
â”œâ”€ ç”¨æˆ¶å…è²»æ¬¡æ•¸: 3 â†’ 3ï¼ˆæœªè¨˜éŒ„ï¼‰æˆ– 5 â†’ 4ï¼ˆå·²æ‰£é™¤å‰µå»ºå¡ï¼‰
â”œâ”€ å‰µå»ºå¡æ•¸é‡: å¯èƒ½å·²æ‰£é™¤ä½†æœªå¾—åˆ°è§’è‰²
â”œâ”€ è§’è‰²æœªå‰µå»º
â”œâ”€ flow ç‹€æ…‹: failed
â””â”€ è‡¨æ™‚ç‹€æ…‹ä¿ç•™ï¼ˆå¯é‡è©¦ï¼‰
```

---

### B3. å‰µå»ºå¤±æ•— - æœªå¡«å¯«å¿…å¡«æ¬„ä½

```
å ´æ™¯ 1ï¼šæœªé¸æ“‡æ€§åˆ¥
â”œâ”€ ç”¨æˆ¶ç›´æ¥è·³éæ€§åˆ¥é¸æ“‡é é¢ï¼ˆä¾‹å¦‚ï¼šç›´æ¥è¨ªå•å¤–è§€é é¢ URLï¼‰
â”œâ”€ sessionStorage: characterCreation.gender = null
â”œâ”€ å¤–è§€é é¢æª¢æŸ¥æ€§åˆ¥
â”‚  â””â”€ âŒ æœªé¸æ“‡æ€§åˆ¥
â”œâ”€ é‡å®šå‘å›æ€§åˆ¥é¸æ“‡é é¢
â””â”€ é¡¯ç¤ºæç¤º: ã€Œè«‹å…ˆé¸æ“‡æ€§åˆ¥ã€

å ´æ™¯ 2ï¼šæœªå¡«å¯«å½¢è±¡æè¿°
â”œâ”€ ç”¨æˆ¶æœªå¡«å¯«å½¢è±¡æè¿°
â”œâ”€ é»æ“Šã€Œç¢ºèªç”Ÿæˆã€
â”œâ”€ å‰ç«¯é©—è­‰:
â”‚  â””â”€ âŒ æè¿°ç‚ºç©º
â”œâ”€ é¡¯ç¤ºéŒ¯èª¤: ã€Œè«‹å¡«å¯«è§’è‰²å½¢è±¡æè¿°ã€
â””â”€ ä¿æŒåœ¨å¤–è§€é é¢

å ´æ™¯ 3ï¼šæœªé¸æ“‡åœ–ç‰‡
â”œâ”€ åœ–ç‰‡ç”Ÿæˆå®Œæˆ
â”œâ”€ ç”¨æˆ¶æœªé¸æ“‡ä»»ä½•åœ–ç‰‡
â”œâ”€ é»æ“Šã€Œä¸‹ä¸€æ­¥ã€
â”œâ”€ å‰ç«¯é©—è­‰:
â”‚  â””â”€ âŒ æœªé¸æ“‡åœ–ç‰‡
â”œâ”€ é¡¯ç¤ºéŒ¯èª¤: ã€Œè«‹é¸æ“‡ä¸€å¼µåœ–ç‰‡ã€
â””â”€ ä¿æŒåœ¨ç”Ÿæˆé é¢

å ´æ™¯ 4ï¼šæœªå¡«å¯«è§’è‰²è³‡æ–™
â”œâ”€ ç”¨æˆ¶æœªå¡«å¯«è§’è‰²åæˆ–å…¶ä»–å¿…å¡«æ¬„ä½
â”œâ”€ é»æ“Šã€Œä¸‹ä¸€æ­¥ã€
â”œâ”€ å‰ç«¯é©—è­‰:
â”‚  â””â”€ âŒ å¿…å¡«æ¬„ä½ç‚ºç©º
â”œâ”€ é¡¯ç¤ºéŒ¯èª¤: ã€Œè«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ã€
â””â”€ ä¿æŒåœ¨è¨­å®šé é¢

å ´æ™¯ 5ï¼šæœªé¸æ“‡èªéŸ³
â”œâ”€ ç”¨æˆ¶æœªé¸æ“‡èªéŸ³
â”œâ”€ é»æ“Šã€Œå®Œæˆå‰µå»ºã€
â”œâ”€ å‰ç«¯é©—è­‰:
â”‚  â””â”€ âŒ æœªé¸æ“‡èªéŸ³
â”œâ”€ é¡¯ç¤ºéŒ¯èª¤: ã€Œè«‹é¸æ“‡è§’è‰²èªéŸ³ã€
â””â”€ ä¿æŒåœ¨èªéŸ³é é¢
```

---

### B4. å‰µå»ºå¤±æ•— - ä¿å­˜è§’è‰²å¤±æ•—ï¼ˆFirestore éŒ¯èª¤ï¼‰

```
æ­¥é©Ÿ 1-10ï¼šåŒ A1ï¼ˆåœ–ç‰‡å·²ç”Ÿæˆï¼Œè§’è‰²è³‡æ–™å·²å¡«å¯«å®Œæˆï¼‰

æ­¥é©Ÿ 11ï¼šé»æ“Šã€Œå®Œæˆå‰µå»ºã€

å¾Œç«¯æ­¥é©Ÿ 11.1ï¼šä¿å­˜è§’è‰²åˆ° Firestoreï¼ˆå¤±æ•—ï¼‰
â”œâ”€ çµ„è£è§’è‰²æ•¸æ“š
â”œâ”€ èª¿ç”¨ Firestore API
â”‚  â”œâ”€ âŒ Firestore éŒ¯èª¤ï¼ˆä¾‹å¦‚ï¼šç¶²çµ¡å•é¡Œã€æ¬Šé™å•é¡Œï¼‰
â”‚  â””â”€ æ‹‹å‡ºéŒ¯èª¤: 'Firestore error: ...'
â””â”€ è¿”å›éŒ¯èª¤éŸ¿æ‡‰:
   {
     message: 'ä¿å­˜è§’è‰²å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦',
     error: 'FIRESTORE_ERROR'
   }

æ­¥é©Ÿ 12ï¼šå‰ç«¯æ¥æ”¶éŒ¯èª¤
â”œâ”€ éš±è— loading ç‹€æ…‹
â”œâ”€ é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
â”œâ”€ æä¾›é‡è©¦æŒ‰éˆ•
â”œâ”€ ä¿ç•™æ‰€æœ‰ç‹€æ…‹ï¼ˆflow IDã€sessionStorageï¼‰
â””â”€ ç‹€æ…‹: saving_failed

ç”¨æˆ¶é¸æ“‡ï¼šé‡è©¦
â”œâ”€ é»æ“Šé‡è©¦æŒ‰éˆ•
â”œâ”€ å†æ¬¡èª¿ç”¨ä¿å­˜ API
â”‚  â””â”€ ä½¿ç”¨ç›¸åŒçš„è§’è‰²æ•¸æ“š
â””â”€ å¦‚æœæˆåŠŸ â†’ åƒè¦‹ A1 æ­¥é©Ÿ 12

æœ€çµ‚ç‹€æ…‹ï¼ˆå¤±æ•—æƒ…æ³ï¼‰ï¼š
â”œâ”€ ç”¨æˆ¶å…è²»æ¬¡æ•¸: 3 â†’ 2ï¼ˆå·²è¨˜éŒ„ï¼‰
â”œâ”€ å‰µå»ºå¡æ•¸é‡: å¯èƒ½å·²æ‰£é™¤
â”œâ”€ è§’è‰²æœªå‰µå»ºï¼ˆFirestore ä¸­ä¸å­˜åœ¨ï¼‰
â”œâ”€ flow ç‹€æ…‹: completedï¼ˆåœ–ç‰‡å·²ç”Ÿæˆï¼‰
â””â”€ è‡¨æ™‚ç‹€æ…‹ä¿ç•™ï¼ˆå¯é‡è©¦ä¿å­˜ï¼‰

å•é¡Œï¼šå…è²»æ¬¡æ•¸å·²æ‰£é™¤ï¼Œä½†è§’è‰²æœªä¿å­˜
â””â”€ å»ºè­°ï¼šåœ¨ä¿å­˜æˆåŠŸå¾Œæ‰è¨˜éŒ„å‰µå»ºæ¬¡æ•¸ï¼ˆä¿®æ”¹å¾Œç«¯é‚è¼¯ï¼‰
```

---

## C. ä¸­æ–·/æ¢å¾©è·¯å¾‘

### C1. æ€§åˆ¥é¸æ“‡é é¢é—œé–‰/åˆ·æ–°

```
ç”¨æˆ¶è¡Œç‚ºï¼š
â”œâ”€ é€²å…¥æ€§åˆ¥é¸æ“‡é é¢
â”œâ”€ é—œé–‰ç€è¦½å™¨æˆ–åˆ·æ–°é é¢
â””â”€ é‡æ–°é€²å…¥

ç‹€æ…‹æª¢æŸ¥ï¼š
â”œâ”€ localStorage: character-create-flow-id = nullï¼ˆå·²æ¸…é™¤ï¼‰
â”œâ”€ sessionStorage: å…¨éƒ¨æ¸…é™¤ï¼ˆç€è¦½å™¨é—œé–‰ï¼‰
â””â”€ å¾Œç«¯ flow: ç„¡ï¼ˆå°šæœªå‰µå»ºï¼‰

æ¢å¾©è¡Œç‚ºï¼š
â”œâ”€ é¡¯ç¤ºæ€§åˆ¥é¸æ“‡é é¢ï¼ˆå…¨æ–°é–‹å§‹ï¼‰
â”œâ”€ ç„¡éœ€æ¢å¾©ä»»ä½•ç‹€æ…‹
â””â”€ âœ… æ­£å¸¸æµç¨‹

å½±éŸ¿ï¼š
â””â”€ ç„¡å½±éŸ¿ï¼ˆå°šæœªé–‹å§‹å‰µå»ºï¼‰
```

---

### C2. å¤–è§€é é¢é—œé–‰/åˆ·æ–°ï¼ˆæœªé»æ“Šã€Œç¢ºèªç”Ÿæˆã€ï¼‰

```
ç”¨æˆ¶è¡Œç‚ºï¼š
â”œâ”€ é¸æ“‡æ€§åˆ¥: female
â”œâ”€ é€²å…¥å¤–è§€é é¢
â”œâ”€ å¡«å¯«å½¢è±¡æè¿°: ã€Œå¯æ„›å¥³å­©...ã€
â”œâ”€ é—œé–‰ç€è¦½å™¨æˆ–åˆ·æ–°é é¢
â””â”€ é‡æ–°é€²å…¥æ€§åˆ¥é¸æ“‡é é¢

ç‹€æ…‹æª¢æŸ¥ï¼š
â”œâ”€ localStorage: character-create-flow-id = nullï¼ˆå°šæœªå‰µå»º flowï¼‰
â”œâ”€ sessionStorage: å…¨éƒ¨æ¸…é™¤ï¼ˆç€è¦½å™¨é—œé–‰ï¼‰
â”‚  â”œâ”€ characterCreation.gender = 'female' â†’ æ¸…é™¤
â”‚  â””â”€ å½¢è±¡æè¿° â†’ ä¸Ÿå¤±
â””â”€ å¾Œç«¯ flow: ç„¡ï¼ˆå°šæœªå‰µå»ºï¼‰

æ¢å¾©è¡Œç‚ºï¼š
â”œâ”€ é€²å…¥æ€§åˆ¥é¸æ“‡é é¢
â”œâ”€ æ¸…é™¤æ‰€æœ‰èˆŠç‹€æ…‹ï¼ˆå³ä½¿æ²’æœ‰ä¹ŸæœƒåŸ·è¡Œæ¸…é™¤é‚è¼¯ï¼‰
â”œâ”€ é¡¯ç¤ºæ€§åˆ¥é¸æ“‡é é¢
â””â”€ âœ… å…¨æ–°é–‹å§‹

å½±éŸ¿ï¼š
â””â”€ ç”¨æˆ¶å¡«å¯«çš„å½¢è±¡æè¿°ä¸Ÿå¤±ï¼ˆéœ€è¦é‡æ–°å¡«å¯«ï¼‰
```

---

### C3. ç”Ÿæˆé é¢ç¶²è·¯ä¸­æ–·ï¼ˆåœ–ç‰‡ç”Ÿæˆä¸­ï¼‰

```
ç”¨æˆ¶è¡Œç‚ºï¼š
â”œâ”€ å·²é¸æ“‡æ€§åˆ¥ã€å¡«å¯«å½¢è±¡æè¿°
â”œâ”€ é»æ“Šã€Œç¢ºèªç”Ÿæˆã€
â”‚  â””â”€ flow å·²å‰µå»º: flow-abc123
â”‚     â””â”€ localStorage: character-create-flow-id = 'flow-abc123'
â”œâ”€ é€²å…¥ç”Ÿæˆé é¢
â”œâ”€ é–‹å§‹ç”Ÿæˆåœ–ç‰‡ï¼ˆé€²åº¦ 18% â†’ 45%ï¼‰
â”œâ”€ âŒ ç¶²è·¯ä¸­æ–·æˆ–ç”¨æˆ¶åˆ·æ–°é é¢
â””â”€ é é¢é‡æ–°è¼‰å…¥

ç‹€æ…‹æª¢æŸ¥ï¼š
â”œâ”€ localStorage: character-create-flow-id = 'flow-abc123'ï¼ˆä¿ç•™ï¼‰
â”œâ”€ sessionStorage: éƒ¨åˆ†æ¸…é™¤ï¼ˆç€è¦½å™¨åˆ·æ–°ï¼‰
â”‚  â”œâ”€ characterCreation.gender = 'female'ï¼ˆå¯èƒ½æ¸…é™¤ï¼‰
â”‚  â””â”€ character-create-summaryï¼ˆå¯èƒ½æ¸…é™¤ï¼‰
â””â”€ å¾Œç«¯ flow:
   â”œâ”€ flowId: 'flow-abc123'
   â”œâ”€ status: 'generating'  // âš ï¸ ç”Ÿæˆä¸­
   â””â”€ generation: {
        status: 'generating',  // âš ï¸ ç”Ÿæˆä¸­
        idempotencyKey: 'flow-abc123-images',
        startedAt: '2025-11-09T10:00:00Z',
        result: null  // å°šæœªå®Œæˆ
      }

æ¢å¾©è¡Œç‚ºï¼ˆé‡æ–°é€²å…¥ç”Ÿæˆé é¢ï¼‰ï¼š

æ­¥é©Ÿ 1ï¼šé é¢è¼‰å…¥
â”œâ”€ è®€å– localStorage: character-create-flow-id = 'flow-abc123'
â””â”€ èª¿ç”¨ API ç²å– flowï¼ˆGET /api/character-creation/flows/flow-abc123ï¼‰

æ­¥é©Ÿ 2ï¼šæª¢æŸ¥ flow ç‹€æ…‹
â”œâ”€ flow.generation.status = 'generating'  // âš ï¸ ç”Ÿæˆä¸­
â””â”€ flow.generation.result = null  // å°šæœªå®Œæˆ

æƒ…æ³ Aï¼šå¾Œç«¯ç”Ÿæˆå·²å®Œæˆï¼ˆåœ¨åˆ·æ–°æœŸé–“å®Œæˆï¼‰
â”œâ”€ flow.generation.status = 'completed'
â”œâ”€ flow.generation.result.images = [...]  // å·²æœ‰åœ–ç‰‡
â”œâ”€ ç›´æ¥é¡¯ç¤ºç”Ÿæˆçš„åœ–ç‰‡
â”œâ”€ progress = 100%
â””â”€ âœ… æ¢å¾©æˆåŠŸ

æƒ…æ³ Bï¼šå¾Œç«¯ç”Ÿæˆä»åœ¨é€²è¡Œä¸­
â”œâ”€ flow.generation.status = 'generating'
â”œâ”€ å‰ç«¯æª¢æ¸¬åˆ°ç”Ÿæˆä¸­
â”œâ”€ æ±ºç­–ï¼š
â”‚  â”œâ”€ é¸é … 1ï¼šç­‰å¾…ç”Ÿæˆå®Œæˆï¼ˆè¼ªè©¢ï¼‰
â”‚  â”‚  â”œâ”€ æ¯ 3 ç§’è¼ªè©¢ä¸€æ¬¡ flow ç‹€æ…‹
â”‚  â”‚  â”œâ”€ ç›´åˆ° status = 'completed'
â”‚  â”‚  â””â”€ é¡¯ç¤ºåœ–ç‰‡
â”‚  â”‚
â”‚  â”œâ”€ é¸é … 2ï¼šé‡æ–°è§¸ç™¼ç”Ÿæˆï¼ˆä½¿ç”¨ç›¸åŒ idempotencyKeyï¼‰
â”‚  â”‚  â”œâ”€ èª¿ç”¨ POST /api/character-creation/flows/flow-abc123/generate-images
â”‚  â”‚  â”œâ”€ idempotencyKey = 'flow-abc123-images'ï¼ˆç›¸åŒï¼‰
â”‚  â”‚  â”œâ”€ å¾Œç«¯æª¢æŸ¥:
â”‚  â”‚  â”‚  â””â”€ flow.generation.status = 'generating' ä¸” key ç›¸åŒ
â”‚  â”‚  â”‚     â””â”€ è¿”å›ç•¶å‰ç‹€æ…‹ï¼ˆä¸é‡æ–°ç”Ÿæˆï¼‰
â”‚  â”‚  â””â”€ å‰ç«¯ç­‰å¾…æˆ–è¼ªè©¢
â”‚  â”‚
â”‚  â””â”€ âš ï¸ ç•¶å‰å¯¦ç¾ï¼šé¸é … 2
â””â”€ æœ€çµ‚çµæœï¼šç­‰å¾…ç”Ÿæˆå®Œæˆ

æƒ…æ³ Cï¼šå¾Œç«¯ç”Ÿæˆå¤±æ•—ï¼ˆåœ¨åˆ·æ–°æœŸé–“å¤±æ•—ï¼‰
â”œâ”€ flow.generation.status = 'failed'
â”œâ”€ flow.generation.error = { message: '...' }
â”œâ”€ å‰ç«¯é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
â”œâ”€ æä¾›é‡è©¦æŒ‰éˆ•
â””â”€ ç”¨æˆ¶å¯ä»¥é‡è©¦ï¼ˆæœƒä½¿ç”¨æ–°çš„ idempotencyKeyï¼‰

å½±éŸ¿ï¼ˆæƒ…æ³ B - ç”Ÿæˆä¸­ï¼‰ï¼š
â”œâ”€ ç”¨æˆ¶é«”é©—ï¼šéœ€è¦ç­‰å¾…ç”Ÿæˆå®Œæˆï¼ˆå¯èƒ½ 30-60 ç§’ï¼‰
â”œâ”€ å‰µå»ºå¡ï¼šå·²æ‰£é™¤ï¼ˆå¦‚æœç„¡å…è²»æ¬¡æ•¸ï¼‰
â”œâ”€ å…è²»æ¬¡æ•¸ï¼šå°šæœªè¨˜éŒ„ï¼ˆç”Ÿæˆå®Œæˆå¾Œæ‰è¨˜éŒ„ï¼‰
â””â”€ å¯æ¢å¾©ï¼šâœ… å¯ä»¥æ¢å¾©åˆ°ç”Ÿæˆå®Œæˆç‹€æ…‹

âš ï¸ å•é¡Œï¼šå¦‚æœç”¨æˆ¶å¤šæ¬¡åˆ·æ–°é é¢æ€éº¼è¾¦ï¼Ÿ
â””â”€ ç”±æ–¼ä½¿ç”¨ç›¸åŒçš„ idempotencyKeyï¼Œä¸æœƒé‡è¤‡ç”Ÿæˆæˆ–æ‰£è²»
   â””â”€ âœ… Idempotency æ©Ÿåˆ¶ä¿è­·
```

---

### C4. ç”Ÿæˆé é¢åˆ·æ–°ï¼ˆåœ–ç‰‡å·²ç”Ÿæˆï¼‰

```
ç”¨æˆ¶è¡Œç‚ºï¼š
â”œâ”€ åœ–ç‰‡ç”Ÿæˆå®Œæˆ
â”œâ”€ é¡¯ç¤º 4 å¼µåœ–ç‰‡
â”œâ”€ ç”¨æˆ¶åˆ·æ–°é é¢
â””â”€ é é¢é‡æ–°è¼‰å…¥

ç‹€æ…‹æª¢æŸ¥ï¼š
â”œâ”€ localStorage: character-create-flow-id = 'flow-abc123'ï¼ˆä¿ç•™ï¼‰
â”œâ”€ sessionStorage: éƒ¨åˆ†æ¸…é™¤
â””â”€ å¾Œç«¯ flow:
   â”œâ”€ flowId: 'flow-abc123'
   â”œâ”€ status: 'appearance'
   â””â”€ generation: {
        status: 'completed',  // âœ… å·²å®Œæˆ
        result: {
          images: [
            { url: '..image1.jpg' },
            { url: '..image2.jpg' },
            { url: '..image3.jpg' },
            { url: '..image4.jpg' }
          ]
        },
        idempotencyKey: 'flow-abc123-images'
      }

æ¢å¾©è¡Œç‚ºï¼š

æ­¥é©Ÿ 1ï¼šé é¢è¼‰å…¥
â”œâ”€ è®€å– localStorage: character-create-flow-id = 'flow-abc123'
â””â”€ èª¿ç”¨ API ç²å– flow

æ­¥é©Ÿ 2ï¼šæª¢æŸ¥ flow ç‹€æ…‹
â”œâ”€ flow.generation.status = 'completed'  // âœ… å·²å®Œæˆ
â”œâ”€ flow.generation.result.images.length = 4  // æœ‰åœ–ç‰‡
â””â”€ ç›´æ¥é¡¯ç¤ºç”Ÿæˆçš„åœ–ç‰‡ï¼ˆä¸é‡æ–°ç”Ÿæˆï¼‰

æ­¥é©Ÿ 3ï¼šé‡ç”¨å·²ç”Ÿæˆçš„åœ–ç‰‡
â”œâ”€ generatedResults.value = flow.generation.result.images
â”œâ”€ progress = 100%
â”œâ”€ è‡ªå‹•é¸æ“‡ç¬¬ä¸€å¼µåœ–ç‰‡
â””â”€ âœ… æ¢å¾©æˆåŠŸ

å½±éŸ¿ï¼š
â”œâ”€ ä¸æœƒé‡è¤‡ç”Ÿæˆåœ–ç‰‡
â”œâ”€ ä¸æœƒé‡è¤‡æ‰£é™¤å‰µå»ºå¡
â”œâ”€ ç”¨æˆ¶é¸æ“‡ä¸Ÿå¤±ï¼ˆéœ€è¦é‡æ–°é¸æ“‡åœ–ç‰‡ï¼‰
â””â”€ âœ… Idempotency æ©Ÿåˆ¶ä¿è­·

ç”¨æˆ¶é«”é©—ï¼š
â”œâ”€ âœ… åœ–ç‰‡ç«‹å³é¡¯ç¤ºï¼ˆç„¡éœ€ç­‰å¾…ï¼‰
â”œâ”€ âŒ ä¹‹å‰é¸æ“‡çš„åœ–ç‰‡ä¸Ÿå¤±ï¼ˆéœ€è¦é‡æ–°é¸æ“‡ï¼‰
â””â”€ å»ºè­°ï¼šå°‡é¸æ“‡çš„åœ–ç‰‡ ID ä¿å­˜åˆ° sessionStorage
```

---

### C5. è¨­å®šé é¢é—œé–‰/åˆ·æ–°

```
ç”¨æˆ¶è¡Œç‚ºï¼š
â”œâ”€ åœ–ç‰‡å·²ç”Ÿæˆä¸¦é¸æ“‡
â”œâ”€ é€²å…¥è§’è‰²è¨­å®šæ­¥é©Ÿ
â”œâ”€ å¡«å¯«éƒ¨åˆ†è³‡æ–™:
â”‚  â”œâ”€ è§’è‰²å: ã€Œå°ç¾ã€
â”‚  â”œâ”€ è§’è‰²è¨­å®š: ï¼ˆæœªå¡«å¯«ï¼‰
â”‚  â””â”€ ...
â”œâ”€ é—œé–‰ç€è¦½å™¨æˆ–åˆ·æ–°é é¢
â””â”€ é‡æ–°é€²å…¥

ç‹€æ…‹æª¢æŸ¥ï¼š
â”œâ”€ localStorage: character-create-flow-id = 'flow-abc123'ï¼ˆä¿ç•™ï¼‰
â”œâ”€ sessionStorage: å…¨éƒ¨æ¸…é™¤
â”‚  â””â”€ character-create-summaryï¼ˆå·²å¡«å¯«çš„è³‡æ–™ï¼‰ â†’ ä¸Ÿå¤±
â””â”€ å¾Œç«¯ flow:
   â”œâ”€ flowId: 'flow-abc123'
   â”œâ”€ persona: å¯èƒ½æœ‰éƒ¨åˆ†è³‡æ–™ï¼ˆå¦‚æœæœ‰åŒæ­¥ï¼‰
   â””â”€ generation.result.images: ä»ç„¶ä¿ç•™

æ¢å¾©é¸é …ï¼š

é¸é … Aï¼šå¾æ€§åˆ¥é¸æ“‡é é¢é‡æ–°é–‹å§‹ï¼ˆç•¶å‰å¯¦ç¾ï¼‰
â”œâ”€ ç”¨æˆ¶é‡æ–°é€²å…¥æ‡‰ç”¨
â”œâ”€ é€²å…¥æ€§åˆ¥é¸æ“‡é é¢
â”œâ”€ onMounted æ¸…é™¤æ‰€æœ‰ç‹€æ…‹:
â”‚  â”œâ”€ localStorage.removeItem('character-create-flow-id')
â”‚  â””â”€ sessionStorage æ¸…é™¤
â”œâ”€ âœ… å…¨æ–°é–‹å§‹
â””â”€ âŒ å·²ç”Ÿæˆçš„åœ–ç‰‡ä¸Ÿå¤±ï¼ˆå¾Œç«¯ flow ä»å­˜åœ¨ä½†å‰ç«¯ç„¡æ³•è¨ªå•ï¼‰

é¸é … Bï¼šæ¢å¾©åˆ°ç”Ÿæˆé é¢ï¼ˆå»ºè­°ï¼‰
â”œâ”€ ç”¨æˆ¶é‡æ–°é€²å…¥æ‡‰ç”¨
â”œâ”€ æª¢æŸ¥ localStorage ä¸­çš„ flow ID
â”œâ”€ å¦‚æœå­˜åœ¨ flow ID:
â”‚  â”œâ”€ ç²å– flow ç‹€æ…‹
â”‚  â”œâ”€ æ ¹æ“š flow.status æ±ºå®šè·³è½‰åˆ°å“ªå€‹é é¢:
â”‚  â”‚  â”œâ”€ status = 'appearance' â†’ è·³è½‰åˆ°ç”Ÿæˆé é¢
â”‚  â”‚  â”œâ”€ status = 'persona' â†’ è·³è½‰åˆ°è¨­å®šé é¢
â”‚  â”‚  â””â”€ status = 'voice' â†’ è·³è½‰åˆ°èªéŸ³é é¢
â”‚  â””â”€ é¡¯ç¤ºç¢ºèªå½ˆçª—: ã€Œæ˜¯å¦ç¹¼çºŒä¸Šæ¬¡çš„å‰µå»ºï¼Ÿã€
â””â”€ âœ… å¯ä»¥æ¢å¾©ï¼ˆä¸ä¸Ÿå¤±å·²ç”Ÿæˆçš„åœ–ç‰‡ï¼‰

å½±éŸ¿ï¼ˆç•¶å‰å¯¦ç¾ - é¸é … Aï¼‰ï¼š
â”œâ”€ å·²ç”Ÿæˆçš„åœ–ç‰‡ä¸Ÿå¤±
â”œâ”€ å·²æ‰£é™¤çš„å‰µå»ºå¡ç„¡æ³•é€€é‚„
â”œâ”€ ç”¨æˆ¶éœ€è¦é‡æ–°é–‹å§‹
â””â”€ âŒ ä¸ä½³çš„ç”¨æˆ¶é«”é©—

å»ºè­°ï¼š
â””â”€ å¯¦ç¾é¸é … Bï¼ˆæ¢å¾©æ©Ÿåˆ¶ï¼‰
```

---

### C6. èªéŸ³é é¢é—œé–‰/åˆ·æ–°

```
ç”¨æˆ¶è¡Œç‚ºï¼š
â”œâ”€ æ‰€æœ‰è³‡æ–™å·²å¡«å¯«å®Œæˆ
â”œâ”€ é€²å…¥èªéŸ³é¸æ“‡é é¢
â”œâ”€ é¸æ“‡èªéŸ³: ã€Œzh-TW-HsiaoChenNeuralã€
â”œâ”€ é—œé–‰ç€è¦½å™¨æˆ–åˆ·æ–°é é¢
â””â”€ é‡æ–°é€²å…¥

ç‹€æ…‹æª¢æŸ¥ï¼š
â”œâ”€ localStorage: character-create-flow-id = 'flow-abc123'ï¼ˆä¿ç•™ï¼‰
â”œâ”€ sessionStorage: å…¨éƒ¨æ¸…é™¤
â”‚  â””â”€ character-create-summaryï¼ˆåŒ…æ‹¬é¸æ“‡çš„èªéŸ³ï¼‰ â†’ ä¸Ÿå¤±
â””â”€ å¾Œç«¯ flow:
   â””â”€ voice: å¯èƒ½æœ‰è³‡æ–™ï¼ˆå¦‚æœæœ‰åŒæ­¥ï¼‰

æ¢å¾©è¡Œç‚ºï¼š
â””â”€ åŒ C5ï¼ˆå–æ±ºæ–¼æ˜¯å¦å¯¦ç¾æ¢å¾©æ©Ÿåˆ¶ï¼‰

å½±éŸ¿ï¼š
â””â”€ åŒ C5
```

---

### C7. ä¿å­˜éç¨‹ä¸­ç¶²è·¯ä¸­æ–·

```
ç”¨æˆ¶è¡Œç‚ºï¼š
â”œâ”€ é»æ“Šã€Œå®Œæˆå‰µå»ºã€
â”œâ”€ å‰ç«¯èª¿ç”¨ä¿å­˜ API
â”œâ”€ âŒ ç¶²è·¯ä¸­æ–·ï¼ˆè«‹æ±‚æœªåˆ°é”å¾Œç«¯ï¼‰
â””â”€ å‰ç«¯é¡¯ç¤ºéŒ¯èª¤

ç‹€æ…‹æª¢æŸ¥ï¼š
â”œâ”€ localStorage: character-create-flow-id = 'flow-abc123'ï¼ˆä¿ç•™ï¼‰
â”œâ”€ sessionStorage: character-create-summaryï¼ˆä¿ç•™ï¼‰
â”‚  â””â”€ åŒ…å«æ‰€æœ‰è§’è‰²è³‡æ–™
â””â”€ å¾Œç«¯:
   â”œâ”€ æœªæ”¶åˆ°è«‹æ±‚
   â””â”€ è§’è‰²æœªä¿å­˜

æ¢å¾©è¡Œç‚ºï¼š

å‰ç«¯é¡¯ç¤ºï¼š
â”œâ”€ éŒ¯èª¤è¨Šæ¯: ã€Œç¶²è·¯é€£æ¥å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦ã€
â”œâ”€ é‡è©¦æŒ‰éˆ•
â””â”€ ä¿ç•™æ‰€æœ‰ç‹€æ…‹

ç”¨æˆ¶é»æ“Šé‡è©¦ï¼š
â”œâ”€ é‡æ–°èª¿ç”¨ä¿å­˜ API
â”œâ”€ ä½¿ç”¨ç›¸åŒçš„è§’è‰²æ•¸æ“šï¼ˆå¾ sessionStorage è®€å–ï¼‰
â”œâ”€ å¦‚æœæˆåŠŸ â†’ åƒè¦‹ A1 æ­¥é©Ÿ 12
â””â”€ âœ… æ¢å¾©æˆåŠŸ

å½±éŸ¿ï¼š
â”œâ”€ å…è²»æ¬¡æ•¸: å·²æ‰£é™¤ï¼ˆåœ¨åœ–ç‰‡ç”Ÿæˆæ™‚ï¼‰
â”œâ”€ å‰µå»ºå¡: å¯èƒ½å·²æ‰£é™¤
â”œâ”€ è§’è‰²: æœªä¿å­˜
â””â”€ âœ… å¯ä»¥é‡è©¦ä¿å­˜ï¼ˆä¸æœƒé‡è¤‡æ‰£è²»ï¼‰

âš ï¸ å•é¡Œï¼šå¦‚æœç”¨æˆ¶åˆ·æ–°é é¢æ€éº¼è¾¦ï¼Ÿ
â”œâ”€ sessionStorage æ¸…é™¤ â†’ è§’è‰²è³‡æ–™ä¸Ÿå¤±
â”œâ”€ éœ€è¦é‡æ–°å¡«å¯«æ‰€æœ‰è³‡æ–™
â””â”€ å»ºè­°ï¼š
   â”œâ”€ å°‡è³‡æ–™ä¹ŸåŒæ­¥åˆ°å¾Œç«¯ flowï¼ˆä½œç‚ºè‰ç¨¿ï¼‰
   â””â”€ æˆ–ä½¿ç”¨ localStorage ä¿å­˜ï¼ˆä¸å—åˆ·æ–°å½±éŸ¿ï¼‰
```

---

## ğŸ“Š ç‹€æ…‹è½‰æ›è¡¨

| ç•¶å‰ç‹€æ…‹ | ç”¨æˆ¶æ“ä½œ | ä¸‹ä¸€ç‹€æ…‹ | æ•¸æ“šè®ŠåŒ– | å¯æ¢å¾©æ€§ |
|---------|---------|---------|---------|---------|
| draft | é€²å…¥æ€§åˆ¥é¸æ“‡é é¢ | gender_selecting | æ¸…é™¤æ‰€æœ‰èˆŠç‹€æ…‹ | N/A |
| gender_selecting | é¸æ“‡æ€§åˆ¥ | gender_selected | sessionStorage.gender | âœ… |
| gender_selected | é€²å…¥å¤–è§€é é¢ | appearance_editing | - | âœ… |
| appearance_editing | å¡«å¯«æè¿° | appearance_editing | - | âŒï¼ˆsessionStorageï¼‰ |
| appearance_editing | é»æ“Šã€Œç¢ºèªç”Ÿæˆã€ | appearance_confirmed | localStorage.flowId | âœ… |
| appearance_confirmed | é€²å…¥ç”Ÿæˆé é¢ | generating | å¾Œç«¯å‰µå»º flow | âœ… |
| generating | ç”Ÿæˆåœ–ç‰‡ï¼ˆæˆåŠŸï¼‰ | generation_completed | flow.generation.result | âœ… |
| generating | ç”Ÿæˆåœ–ç‰‡ï¼ˆå¤±æ•—ï¼‰ | generation_failed | flow.generation.error | âœ…ï¼ˆå¯é‡è©¦ï¼‰ |
| generation_completed | é¸æ“‡åœ–ç‰‡ | generation_completed | sessionStorage.summary | âŒï¼ˆsessionStorageï¼‰ |
| generation_completed | é»æ“Šã€Œä¸‹ä¸€æ­¥ã€ | persona_editing | - | âœ… |
| persona_editing | å¡«å¯«è³‡æ–™ | persona_editing | sessionStorage.summary | âŒï¼ˆsessionStorageï¼‰ |
| persona_editing | é»æ“Šã€Œä¸‹ä¸€æ­¥ã€ | persona_confirmed | å¯èƒ½åŒæ­¥åˆ°å¾Œç«¯ | âš ï¸ï¼ˆéƒ¨åˆ†ï¼‰ |
| persona_confirmed | é€²å…¥èªéŸ³é é¢ | voice_selecting | - | âš ï¸ |
| voice_selecting | é¸æ“‡èªéŸ³ | voice_selected | sessionStorage.summary | âŒï¼ˆsessionStorageï¼‰ |
| voice_selected | é»æ“Šã€Œå®Œæˆã€ | saving | - | âš ï¸ |
| saving | ä¿å­˜æˆåŠŸ | completed | Firestore + æ¸…é™¤ç‹€æ…‹ | âŒï¼ˆå·²æ¸…é™¤ï¼‰ |
| saving | ä¿å­˜å¤±æ•— | saving_failed | - | âœ…ï¼ˆå¯é‡è©¦ï¼‰ |

**åœ–ä¾‹**:
- âœ… å¯æ¢å¾©ï¼šæ•¸æ“šä¿å­˜åœ¨ localStorage æˆ–å¾Œç«¯ï¼Œåˆ·æ–°/é—œé–‰å¾Œå¯æ¢å¾©
- âŒ ä¸å¯æ¢å¾©ï¼šæ•¸æ“šåªåœ¨ sessionStorage æˆ–è¨˜æ†¶é«”ï¼Œåˆ·æ–°/é—œé–‰å¾Œä¸Ÿå¤±
- âš ï¸ éƒ¨åˆ†å¯æ¢å¾©ï¼šå–æ±ºæ–¼æ˜¯å¦æœ‰åŒæ­¥åˆ°å¾Œç«¯

---

## ğŸ” é—œéµå•é¡Œå’Œå»ºè­°

### å•é¡Œ 1ï¼šå‰µå»ºå¡é æ‰£é™¤ vs è³‡æºæµªè²»

**ç•¶å‰å¯¦ç¾**:
```
ç”Ÿæˆåœ–ç‰‡å‰ â†’ æ‰£é™¤å‰µå»ºå¡ â†’ ç”Ÿæˆåœ–ç‰‡
         â†“ï¼ˆå¤±æ•—ï¼‰
     å‰µå»ºå¡å·²æ‰£é™¤ä½†æ²’æœ‰å¾—åˆ°è§’è‰²
```

**å•é¡Œ**:
- å¦‚æœç”Ÿæˆå¤±æ•—ï¼Œç”¨æˆ¶æå¤±å‰µå»ºå¡ä½†æ²’æœ‰å¾—åˆ°è§’è‰²
- å¦‚æœä¿å­˜å¤±æ•—ï¼Œç”¨æˆ¶å¾—åˆ°åœ–ç‰‡ä½†è§’è‰²æœªä¿å­˜

**å»ºè­°æ–¹æ¡ˆ**:

æ–¹æ¡ˆ Aï¼šå»¶é²æ‰£é™¤ï¼ˆä¿å­˜æˆåŠŸå¾Œæ‰æ‰£é™¤ï¼‰
```
ç”Ÿæˆåœ–ç‰‡ â†’ ä¿å­˜è§’è‰² â†’ æ‰£é™¤å‰µå»ºå¡
```
- âœ… å„ªé»ï¼šç¢ºä¿ç”¨æˆ¶å¾—åˆ°è§’è‰²æ‰æ‰£é™¤
- âŒ ç¼ºé»ï¼šå¯èƒ½è¢«æ¿«ç”¨ï¼ˆç”Ÿæˆå¾Œä¸ä¿å­˜ï¼‰

æ–¹æ¡ˆ Bï¼šè£œå„Ÿæ©Ÿåˆ¶
```
ç”Ÿæˆå¤±æ•—æˆ–ä¿å­˜å¤±æ•— â†’ é€€é‚„å‰µå»ºå¡
```
- âœ… å„ªé»ï¼šä¿è­·ç”¨æˆ¶æ¬Šç›Š
- âŒ ç¼ºé»ï¼šå¯¦ç¾è¤‡é›œï¼Œéœ€è¦å›æ»¾é‚è¼¯

æ–¹æ¡ˆ Cï¼šè¨˜éŒ„å‰µå»ºæ¬¡æ•¸åœ¨ä¿å­˜æˆåŠŸå¾Œ
```
ç•¶å‰ï¼šç”ŸæˆæˆåŠŸ â†’ è¨˜éŒ„å‰µå»ºæ¬¡æ•¸
å»ºè­°ï¼šä¿å­˜æˆåŠŸ â†’ è¨˜éŒ„å‰µå»ºæ¬¡æ•¸
```
- âœ… å„ªé»ï¼šé¿å…ä¿å­˜å¤±æ•—æ™‚æµªè²»å…è²»æ¬¡æ•¸
- âœ… ç¼ºé»ï¼šè¼ƒå°çš„ä¿®æ”¹

---

### å•é¡Œ 2ï¼šsessionStorage æ•¸æ“šä¸Ÿå¤±

**å½±éŸ¿ç¯„åœ**:
- ç”¨æˆ¶é¸æ“‡çš„åœ–ç‰‡
- ç”¨æˆ¶å¡«å¯«çš„è§’è‰²è³‡æ–™
- AI Magician è¨ˆæ•¸å™¨

**å»ºè­°æ–¹æ¡ˆ**:

æ–¹æ¡ˆ Aï¼šä½¿ç”¨ localStorage ä»£æ›¿ sessionStorage
```javascript
// ç•¶å‰
sessionStorage.setItem('character-create-summary', ...);

// å»ºè­°
localStorage.setItem('character-create-summary', ...);
```
- âœ… å„ªé»ï¼šåˆ·æ–°å¾Œæ•¸æ“šä¿ç•™
- âŒ ç¼ºé»ï¼šè·¨æ¨™ç±¤é å…±äº«ï¼ˆå¯èƒ½ä¸æ˜¯æœŸæœ›è¡Œç‚ºï¼‰

æ–¹æ¡ˆ Bï¼šåŒæ­¥åˆ°å¾Œç«¯ flow
```javascript
// æ¯æ¬¡ä¿®æ”¹æ™‚è‡ªå‹•åŒæ­¥
const updateFlow = debounce(async (data) => {
  await apiJson(`/api/character-creation/flows/${flowId}`, {
    method: 'PATCH',
    body: data
  });
}, 1000);
```
- âœ… å„ªé»ï¼šæ•¸æ“šæœ€å®‰å…¨
- âœ… å„ªé»ï¼šå¯ä»¥åœ¨ä»»ä½•è¨­å‚™æ¢å¾©
- âŒ ç¼ºé»ï¼šå¢åŠ API èª¿ç”¨

æ–¹æ¡ˆ Cï¼šæ··åˆæ–¹æ¡ˆ
- é—œéµæ•¸æ“šï¼ˆé¸æ“‡çš„åœ–ç‰‡ã€è§’è‰²è³‡æ–™ï¼‰â†’ åŒæ­¥åˆ°å¾Œç«¯
- è¼”åŠ©æ•¸æ“šï¼ˆAI Magician è¨ˆæ•¸å™¨ï¼‰â†’ localStorage
- âœ… å¹³è¡¡å®‰å…¨æ€§å’Œæ€§èƒ½

---

### å•é¡Œ 3ï¼šæ¢å¾©æ©Ÿåˆ¶ä¸å®Œå–„

**ç•¶å‰å¯¦ç¾**:
```
ç”¨æˆ¶é—œé–‰ â†’ é‡æ–°é€²å…¥æ€§åˆ¥é¸æ“‡é é¢ â†’ æ¸…é™¤æ‰€æœ‰ç‹€æ…‹ â†’ å…¨æ–°é–‹å§‹
```

**å•é¡Œ**:
- å·²ç”Ÿæˆçš„åœ–ç‰‡ä¸Ÿå¤±
- å·²æ‰£é™¤çš„å‰µå»ºå¡ç„¡æ³•é€€é‚„
- ç”¨æˆ¶éœ€è¦é‡æ–°é–‹å§‹æ•´å€‹æµç¨‹

**å»ºè­°æ–¹æ¡ˆ**:

å¯¦ç¾æ™ºèƒ½æ¢å¾©
```javascript
// æ€§åˆ¥é¸æ“‡é é¢ onMounted
const flowId = localStorage.getItem('character-create-flow-id');

if (flowId) {
  const flow = await fetchCharacterCreationFlow(flowId);

  if (flow) {
    // é¡¯ç¤ºç¢ºèªå½ˆçª—
    const resume = confirm('æª¢æ¸¬åˆ°æœªå®Œæˆçš„è§’è‰²å‰µå»ºï¼Œæ˜¯å¦ç¹¼çºŒï¼Ÿ');

    if (resume) {
      // æ ¹æ“š flow.status è·³è½‰åˆ°å°æ‡‰é é¢
      switch (flow.status) {
        case 'appearance':
          router.push({ name: 'character-create-generating' });
          break;
        case 'persona':
          router.push({ name: 'character-create-generating', query: { step: 'settings' } });
          break;
        case 'voice':
          router.push({ name: 'character-create-voice' });
          break;
      }
      return; // ä¸æ¸…é™¤ç‹€æ…‹
    }
  }
}

// åªæœ‰åœ¨ç”¨æˆ¶é¸æ“‡ã€Œé‡æ–°é–‹å§‹ã€æ™‚æ‰æ¸…é™¤
clearStoredCharacterCreationFlowId();
clearCreationState();
```

---

### å•é¡Œ 4ï¼šAI Magician è¨ˆæ•¸å™¨åœ¨ flow é‡ç”¨æ™‚æœªé‡ç½®

**æƒ…å¢ƒ**:
```
ç”¨æˆ¶ A å‰µå»ºè§’è‰²:
  â†’ ä½¿ç”¨ AI Magician 3 æ¬¡
  â†’ å‰µå»ºæˆåŠŸ
  â†’ è¨ˆæ•¸å™¨é‡ç½® âœ…

ç”¨æˆ¶ A å†æ¬¡å‰µå»º:
  â†’ æ€§åˆ¥é¸æ“‡é é¢æ¸…é™¤æ‰€æœ‰ç‹€æ…‹ âœ…
  â†’ è¨ˆæ•¸å™¨ = 0 âœ…
  â†’ ä½¿ç”¨ AI Magician 2 æ¬¡
  â†’ é»æ“Šã€Œç¢ºèªç”Ÿæˆã€
  â†’ flow å‰µå»ºæˆåŠŸï¼ŒflowId = 'flow-new-123'
  â†’ é€²å…¥ç”Ÿæˆé é¢
  â†’ âŒ ç¶²è·¯å•é¡Œï¼Œè¿”å›æ€§åˆ¥é¸æ“‡é é¢
  â†’ âš ï¸ è¨ˆæ•¸å™¨è¢«æ¸…é™¤ï¼ˆflowId ä¹Ÿè¢«æ¸…é™¤ï¼‰
  â†’ é‡æ–°é–‹å§‹å‰µå»º
  â†’ æ–° flowï¼ŒflowId = 'flow-new-456'
  â†’ AI Magician è¨ˆæ•¸å™¨ = 0ï¼ˆé‡æ–°é–‹å§‹ï¼‰
```

**å•é¡Œ**:
- è¨ˆæ•¸å™¨èˆ‡ flow æ²’æœ‰ç¶å®š
- æ€§åˆ¥é¸æ“‡é é¢æœƒæ¸…é™¤è¨ˆæ•¸å™¨
- å¯èƒ½è¢«æ¿«ç”¨ï¼ˆå¤šæ¬¡é‡æ–°é–‹å§‹ä¾†é‡ç½®è¨ˆæ•¸å™¨ï¼‰

**å»ºè­°æ–¹æ¡ˆ**:

å°‡è¨ˆæ•¸å™¨ç¶å®šåˆ° flow
```javascript
// å¾Œç«¯ flow çµæ§‹æ·»åŠ 
{
  metadata: {
    gender: 'female',
    aiMagicianUsageCount: 2  // åœ¨ flow ä¸­è¨˜éŒ„
  }
}

// å‰ç«¯ä½¿ç”¨æ™‚æª¢æŸ¥
const flow = await fetchCharacterCreationFlow(flowId);
const usageCount = flow.metadata?.aiMagicianUsageCount || 0;
if (usageCount >= 3) {
  alert('AI é­”æ³•å¸«ä½¿ç”¨æ¬¡æ•¸å·²é”ä¸Šé™');
}
```

---

## âœ… è«‹æª¢æŸ¥å’Œç¢ºèª

è«‹å¹«æˆ‘ç¢ºèªä»¥ä¸‹å¹¾é»ï¼š

### 1. æµç¨‹æ˜¯å¦æ­£ç¢ºï¼Ÿ
- å„å€‹æ­¥é©Ÿçš„é †åº
- API èª¿ç”¨çš„æ™‚æ©Ÿ
- ç‹€æ…‹è½‰æ›

### 2. å‰µå»ºå¡æ‰£é™¤é‚è¼¯æ˜¯å¦ç¬¦åˆé æœŸï¼Ÿ
- å…è²»æ¬¡æ•¸ç”¨å®Œæ™‚æ‰£é™¤
- æ‰£é™¤æ™‚æ©Ÿï¼ˆç”Ÿæˆå‰ vs ä¿å­˜å¾Œï¼‰
- å¤±æ•—æ™‚æ˜¯å¦éœ€è¦é€€é‚„

### 3. Flow é‡ç”¨é‚è¼¯æ˜¯å¦æ­£ç¢ºï¼Ÿ
- Idempotency æª¢æŸ¥
- é‡ç”¨æ¢ä»¶
- é¿å…é‡è¤‡æ‰£è²»

### 4. ç‹€æ…‹æ¸…é™¤æ™‚æ©Ÿæ˜¯å¦åˆé©ï¼Ÿ
- æ€§åˆ¥é¸æ“‡é é¢è¼‰å…¥æ™‚æ¸…é™¤
- å‰µå»ºæˆåŠŸå¾Œæ¸…é™¤
- AI Magician è¨ˆæ•¸å™¨æ¸…é™¤

### 5. ä¸­æ–·æ¢å¾©æ©Ÿåˆ¶æ˜¯å¦éœ€è¦æ”¹é€²ï¼Ÿ
- æ˜¯å¦éœ€è¦å¯¦ç¾æ™ºèƒ½æ¢å¾©
- sessionStorage vs localStorage
- æ•¸æ“šåŒæ­¥åˆ°å¾Œç«¯

### 6. å…¶ä»–å•é¡Œæˆ–éºæ¼ï¼Ÿ

è«‹å‘Šè¨´æˆ‘å“ªäº›åœ°æ–¹éœ€è¦ä¿®æ­£ï¼
