# å‰å¾Œå°é‡‘å¹£é¤˜é¡ä¸åŒæ­¥å•é¡Œä¿®å¾©

**ä¿®å¾©æ—¥æœŸ**: 2025-01-18
**å•é¡Œç·¨è™Ÿ**: #WALLET-SYNC-001
**åš´é‡æ€§**: é«˜ï¼ˆå½±éŸ¿ç”¨æˆ¶é«”é©—å’Œç®¡ç†å“¡æ“ä½œï¼‰

---

## ğŸ” å•é¡Œæè¿°

### ç—‡ç‹€
- **ç®¡ç†å¾Œå°**ä¿®æ”¹ç”¨æˆ¶é‡‘å¹£å¾Œï¼Œ**ä¸»æ‡‰ç”¨å‰ç«¯**é¡¯ç¤ºçš„é‡‘å¹£é¤˜é¡æœªç«‹å³æ›´æ–°
- æœ€é•·å»¶é²æ™‚é–“ï¼š**10-15 åˆ†é˜**
- å½±éŸ¿ç”¨æˆ¶é«”é©—å’Œç®¡ç†å“¡çš„å³æ™‚æ“ä½œé©—è­‰

### æ ¹æœ¬åŸå› 

é€™æ˜¯ä¸€å€‹**ä¸‰å±¤ç·©å­˜å•é¡Œ**ï¼š

| å±¤ç´š | ä½ç½® | åŸ TTL | å•é¡Œ |
|-----|------|--------|------|
| **å¾Œç«¯ç·©å­˜** | `chat-app/backend/src/user/userProfileCache.service.js` | 5 åˆ†é˜ | ç®¡ç†å¾Œå°ä¿®æ”¹å¾Œæœªæ¸…é™¤ä¸»æ‡‰ç”¨ç·©å­˜ |
| **å‰ç«¯ç·©å­˜** | `chat-app/frontend/src/composables/useUserProfile.ts` | 10 åˆ†é˜ | ç·©å­˜æ™‚é–“éé•· |
| **ç‹€æ…‹ä¸åŒæ­¥** | `useCoins` vs `useUserProfile` | N/A | å…©å€‹ composable ç‹€æ…‹ç¨ç«‹ |

### æ™‚é–“ç·šåˆ†æ

```
T=0s   âŒ ç®¡ç†å“¡åœ¨ç®¡ç†å¾Œå°ä¿®æ”¹ç”¨æˆ¶é‡‘å¹£ï¼ˆ1000 â†’ 2000ï¼‰
       â†“
T=0s   âœ… Firestore ä¸­ users é›†åˆå·²æ›´æ–°ç‚º 2000
       â†“
T=0-5m âŒ ä¸»æ‡‰ç”¨å¾Œç«¯çš„ userProfileCache ä»è¿”å›èˆŠå€¼ 1000ï¼ˆ5åˆ†é˜å…§ï¼‰
       â†“
T=0-10m âŒ ä¸»æ‡‰ç”¨å‰ç«¯çš„ useUserProfile ä»ä½¿ç”¨èˆŠç·©å­˜ 1000ï¼ˆ10åˆ†é˜å…§ï¼‰
       â†“
T=5m   âš ï¸ ä¸»æ‡‰ç”¨å¾Œç«¯ç·©å­˜éæœŸï¼Œä¸‹æ¬¡ API èª¿ç”¨æ‰æœƒé‡æ–°è®€å–
       â†“
T=10m  âš ï¸ ä¸»æ‡‰ç”¨å‰ç«¯ç·©å­˜éæœŸï¼Œä¸‹æ¬¡è¨ªå•æ‰æœƒé‡æ–°è®€å–
```

**çµæœ**ï¼šç”¨æˆ¶åœ¨æœ€é•· **10-15 åˆ†é˜**å…§çœ‹ä¸åˆ°é‡‘å¹£æ›´æ–°ã€‚

---

## âœ… ä¿®å¾©æ–¹æ¡ˆ

### ä¿®å¾© 1ï¼šæ¸›å°‘å¾Œç«¯ç·©å­˜ TTLï¼ˆ5 åˆ†é˜ â†’ 1 åˆ†é˜ï¼‰

**æ–‡ä»¶**: `chat-app/backend/src/user/userProfileCache.service.js`

**ä¿®æ”¹å‰**:
```javascript
const CACHE_CONFIG = {
  stdTTL: 300,  // 5 åˆ†é˜
  // ...
};
```

**ä¿®æ”¹å¾Œ**:
```javascript
const CACHE_CONFIG = {
  stdTTL: 60,  // âœ… æ”¹ç‚º 1 åˆ†é˜
  // ...
};
```

**æ•ˆæœ**ï¼šç®¡ç†å¾Œå°ä¿®æ”¹é‡‘å¹£å¾Œï¼Œæœ€å¤š **1 åˆ†é˜**å¾Œç«¯ç·©å­˜å°±æœƒéæœŸã€‚

---

### ä¿®å¾© 2ï¼šæ¸›å°‘å‰ç«¯ç·©å­˜ TTLï¼ˆ10 åˆ†é˜ â†’ 1 åˆ†é˜ï¼‰

**æ–‡ä»¶**: `chat-app/frontend/src/composables/useUserProfile.ts`

**ä¿®æ”¹å‰**:
```typescript
const CACHE_TTL = 10 * 60 * 1000; // 10 åˆ†é˜
```

**ä¿®æ”¹å¾Œ**:
```typescript
const CACHE_TTL = 1 * 60 * 1000;  // âœ… æ”¹ç‚º 1 åˆ†é˜
```

**æ•ˆæœ**ï¼šå‰ç«¯ç·©å­˜æœ€å¤š **1 åˆ†é˜**å°±æœƒéæœŸä¸¦é‡æ–°è®€å–ã€‚

---

### ä¿®å¾© 3ï¼šclearUserProfile åŒæ™‚æ¸…é™¤ç·©å­˜

**æ–‡ä»¶**: `chat-app/frontend/src/composables/useUserProfile.ts`

**ä¿®æ”¹å‰**:
```typescript
const clearUserProfile = (): void => {
  baseState.user = null;
};
```

**ä¿®æ”¹å¾Œ**:
```typescript
const clearUserProfile = (): void => {
  baseState.user = null;
  profileCache.clear();  // âœ… æ¸…é™¤ç·©å­˜
};
```

**æ•ˆæœ**ï¼šæ‰‹å‹•èª¿ç”¨æ¸…é™¤æ™‚æœƒåŒæ™‚æ¸…ç©ºç·©å­˜å’Œç‹€æ…‹ã€‚

---

### ä¿®å¾© 4ï¼šuseCoins è³¼è²·å¾Œæ¸…é™¤ useUserProfile ç·©å­˜

**æ–‡ä»¶**: `chat-app/frontend/src/composables/useCoins.ts`

**æ–°å¢é‚è¼¯**:
```typescript
// è³¼è²·æˆåŠŸå¾Œ
if (data.coinsAdded !== undefined) {
  coinsState.value.balance += data.coinsAdded;
}

// âœ… æ–°å¢ï¼šæ¸…é™¤ useUserProfile ç·©å­˜ï¼Œç¢ºä¿ç‹€æ…‹åŒæ­¥
try {
  const { clearUserProfile } = await import('./useUserProfile');
  clearUserProfile();
} catch (err) {
  logger.warn('[é‡‘å¹£] ç„¡æ³•æ¸…é™¤ useUserProfile ç·©å­˜:', err);
}
```

**æ•ˆæœ**ï¼šè³¼è²·é‡‘å¹£å¾Œï¼Œå…©å€‹ composable çš„ç‹€æ…‹ç«‹å³åŒæ­¥ã€‚

---

### ä¿®å¾© 5ï¼šç®¡ç†å¾Œå°æ·»åŠ æ—¥èªŒæé†’

**æ–‡ä»¶**: `chat-app-admin/backend/src/services/user/user.service.js`

**æ–°å¢é‚è¼¯**:
```javascript
if (coins !== undefined || walletBalance !== undefined || assets !== undefined) {
  console.warn(`[ç®¡ç†å¾Œå°] âš ï¸ ç”¨æˆ¶ ${userId} çš„é‡‘å¹£/è³‡ç”¢å·²æ›´æ–°`);
  console.warn(`[ç®¡ç†å¾Œå°] âš ï¸ ä¸»æ‡‰ç”¨çš„ç·©å­˜å°‡åœ¨ 1-2 åˆ†é˜å…§éæœŸä¸¦é¡¯ç¤ºæ–°æ•¸æ“š`);
  console.warn(`[ç®¡ç†å¾Œå°] âš ï¸ å¦‚éœ€ç«‹å³ç”Ÿæ•ˆï¼Œè«‹ç”¨æˆ¶é‡æ–°ç™»å…¥æˆ–ç­‰å¾…ç·©å­˜éæœŸ`);
}
```

**æ•ˆæœ**ï¼šç®¡ç†å“¡ä¿®æ”¹é‡‘å¹£æ™‚æœƒæ”¶åˆ°æ˜ç¢ºçš„æ—¥èªŒæé†’ã€‚

---

## ğŸ“Š ä¿®å¾©æ•ˆæœå°æ¯”

| æŒ‡æ¨™ | ä¿®å¾©å‰ | ä¿®å¾©å¾Œ | æ”¹å–„ |
|-----|--------|--------|------|
| **å¾Œç«¯ç·©å­˜ TTL** | 5 åˆ†é˜ | 1 åˆ†é˜ | â¬‡ï¸ 80% |
| **å‰ç«¯ç·©å­˜ TTL** | 10 åˆ†é˜ | 1 åˆ†é˜ | â¬‡ï¸ 90% |
| **æœ€å¤§å»¶é²æ™‚é–“** | 10-15 åˆ†é˜ | 1-2 åˆ†é˜ | â¬‡ï¸ 87% |
| **ç‹€æ…‹åŒæ­¥** | ä¸åŒæ­¥ | è‡ªå‹•åŒæ­¥ | âœ… å®Œå…¨ä¿®å¾© |
| **ç®¡ç†å“¡å¯è¦‹æ€§** | ç„¡æé†’ | æ¸…æ™°æ—¥èªŒ | âœ… å®Œå…¨æ”¹å–„ |

---

## ğŸ§ª é©—è­‰æ­¥é©Ÿ

### æ¸¬è©¦å ´æ™¯ 1ï¼šç®¡ç†å¾Œå°ä¿®æ”¹é‡‘å¹£

1. **è¨˜éŒ„åˆå§‹å€¼**
   - ä¸»æ‡‰ç”¨é¡¯ç¤ºï¼š1000 é‡‘å¹£
   - Firestore å¯¦éš›å€¼ï¼š1000 é‡‘å¹£

2. **ç®¡ç†å¾Œå°ä¿®æ”¹**
   - ç®¡ç†å“¡å°‡é‡‘å¹£æ”¹ç‚º 2000
   - æŸ¥çœ‹å¾Œç«¯æ—¥èªŒï¼Œæ‡‰è©²çœ‹åˆ°è­¦å‘Šè¨Šæ¯

3. **é©—è­‰ä¸»æ‡‰ç”¨åŒæ­¥**
   - **ç«‹å³åˆ·æ–°å‰ç«¯**ï¼šå¯èƒ½ä»é¡¯ç¤º 1000ï¼ˆç·©å­˜æœªéæœŸï¼‰
   - **ç­‰å¾… 1-2 åˆ†é˜å¾Œåˆ·æ–°**ï¼šæ‡‰é¡¯ç¤º 2000 âœ…

4. **é©—è­‰å¾Œç«¯ API**
   ```bash
   # èª¿ç”¨ç”¨æˆ¶è³‡æ–™ API
   curl -H "Authorization: Bearer <token>" \
     http://localhost:4000/api/users/<userId>
   ```
   - **1 åˆ†é˜å…§**ï¼šå¯èƒ½è¿”å› 1000ï¼ˆå¾Œç«¯ç·©å­˜ï¼‰
   - **1 åˆ†é˜å¾Œ**ï¼šæ‡‰è¿”å› 2000 âœ…

---

### æ¸¬è©¦å ´æ™¯ 2ï¼šä¸»æ‡‰ç”¨è³¼è²·é‡‘å¹£

1. **è³¼è²·å‰**
   - é‡‘å¹£é¤˜é¡ï¼š1000

2. **è³¼è²·å¥—é¤**
   - è³¼è²· 500 é‡‘å¹£å¥—é¤

3. **ç«‹å³é©—è­‰**
   - **useCoins.balance**ï¼šæ‡‰ç«‹å³é¡¯ç¤º 1500 âœ…
   - **useUserProfile.user.wallet.balance**ï¼šæ‡‰ç«‹å³åŒæ­¥ç‚º 1500 âœ…
   - **å¾Œç«¯ Firestore**ï¼šå·²æ›´æ–°ç‚º 1500 âœ…

---

### æ¸¬è©¦å ´æ™¯ 3ï¼šæ‰‹å‹•åˆ·æ–°

1. **èª¿ç”¨ clearUserProfile()**
   ```typescript
   import { useUserProfile } from '@/composables/useUserProfile';
   const { clearUserProfile } = useUserProfile();
   clearUserProfile();
   ```

2. **é©—è­‰æ•ˆæœ**
   - `baseState.user` æ‡‰ç‚º `null` âœ…
   - `profileCache` æ‡‰ç‚ºç©º âœ…
   - ä¸‹æ¬¡èª¿ç”¨ `loadUserProfile` æœƒå¾ API é‡æ–°ç²å– âœ…

---

## ğŸ”§ é–‹ç™¼è€…æ³¨æ„äº‹é …

### 1. ç·©å­˜ TTL å¹³è¡¡

**ç•¶å‰è¨­ç½®**ï¼š
- å¾Œç«¯ï¼š1 åˆ†é˜ï¼ˆåŸ 5 åˆ†é˜ï¼‰
- å‰ç«¯ï¼š1 åˆ†é˜ï¼ˆåŸ 10 åˆ†é˜ï¼‰

**å„ªé»**ï¼š
- âœ… å¿«é€ŸåŒæ­¥ï¼ˆ1-2 åˆ†é˜å…§ç”Ÿæ•ˆï¼‰
- âœ… æ¸›å°‘ç®¡ç†å¾Œå°ä¿®æ”¹çš„å»¶é²
- âœ… æå‡ç”¨æˆ¶é«”é©—

**æ¬Šè¡¡**ï¼š
- âš ï¸ API è«‹æ±‚ç•¥å¾®å¢åŠ ï¼ˆä½†ä»åœ¨å¯æ¥å—ç¯„åœï¼‰
- âš ï¸ Firestore è®€å–æ¬¡æ•¸ç•¥å¢ï¼ˆä½†æœ‰ LRU ç·©å­˜ä¿è­·ï¼‰

**ç›£æ§å»ºè­°**ï¼š
- å®šæœŸæª¢æŸ¥ Firestore è®€å–ç”¨é‡ï¼ˆFirebase Consoleï¼‰
- æŸ¥çœ‹ç·©å­˜å‘½ä¸­ç‡æ—¥èªŒï¼ˆå•Ÿå‹•æ™‚æœƒè¼¸å‡ºï¼‰

---

### 2. æœªä¾†å„ªåŒ–æ–¹å‘

#### é¸é … Aï¼šå¯¦æ™‚é€šçŸ¥ç³»çµ±ï¼ˆæ¨è–¦ï¼‰

ä½¿ç”¨ **Firebase Cloud Messaging** æˆ– **WebSocket** æ¨é€é‡‘å¹£è®Šæ›´é€šçŸ¥ï¼š

```typescript
// ç®¡ç†å¾Œå°ä¿®æ”¹é‡‘å¹£æ™‚
await notifyUserWalletUpdate(userId, newBalance);

// ä¸»æ‡‰ç”¨å‰ç«¯ç›£è½
onWalletUpdate((newBalance) => {
  coinsState.value.balance = newBalance;
  clearUserProfile();
});
```

**å„ªé»**ï¼š
- âœ… å¯¦æ™‚åŒæ­¥ï¼ˆ0 å»¶é²ï¼‰
- âœ… ä¸ä¾è³´ç·©å­˜éæœŸ

**ç¼ºé»**ï¼š
- âš ï¸ éœ€è¦é¡å¤–çš„åŸºç¤è¨­æ–½ï¼ˆFCM æˆ– WebSocket æœå‹™å™¨ï¼‰
- âš ï¸ å¢åŠ é–‹ç™¼è¤‡é›œåº¦

---

#### é¸é … Bï¼šä¸»æ‡‰ç”¨æä¾›æ¸…é™¤ç·©å­˜ API

åœ¨ä¸»æ‡‰ç”¨å¾Œç«¯æ·»åŠ ç®¡ç†å“¡å°ˆç”¨çš„æ¸…é™¤ç·©å­˜ç«¯é»ï¼š

```javascript
// chat-app/backend/src/routes/admin.routes.js
router.post('/admin/cache/clear-user/:userId',
  adminAuthMiddleware,
  async (req, res) => {
    const { userId } = req.params;
    deleteCachedUserProfile(userId);
    res.json({ success: true });
  }
);
```

ç®¡ç†å¾Œå°èª¿ç”¨æ­¤ APIï¼š

```javascript
// chat-app-admin/backend/src/services/user/user.service.js
if (coins !== undefined || walletBalance !== undefined) {
  // æ›´æ–° Firestore...

  // æ¸…é™¤ä¸»æ‡‰ç”¨ç·©å­˜
  try {
    await axios.post(
      `${MAIN_APP_API_URL}/api/admin/cache/clear-user/${userId}`,
      {},
      { headers: { Authorization: `Bearer ${adminToken}` } }
    );
  } catch (error) {
    console.warn('[ç®¡ç†å¾Œå°] æ¸…é™¤ä¸»æ‡‰ç”¨ç·©å­˜å¤±æ•—:', error.message);
  }
}
```

**å„ªé»**ï¼š
- âœ… ç«‹å³æ¸…é™¤ç·©å­˜ï¼ˆ0-1 ç§’å»¶é²ï¼‰
- âœ… ä¸éœ€è¦å¯¦æ™‚é€šçŸ¥ç³»çµ±

**ç¼ºé»**ï¼š
- âš ï¸ è·¨æ‡‰ç”¨ HTTP è«‹æ±‚ï¼ˆå¢åŠ ç¶²çµ¡é–‹éŠ·ï¼‰
- âš ï¸ éœ€è¦ç®¡ç†å“¡ token ç®¡ç†

---

#### é¸é … Cï¼šå…±äº«ç·©å­˜å±¤ï¼ˆRedisï¼‰

å°‡å…§å­˜ç·©å­˜æ›¿æ›ç‚º **Redis**ï¼Œå…©å€‹æ‡‰ç”¨å…±äº«åŒä¸€å€‹ Redis å¯¦ä¾‹ï¼š

```javascript
// ä¸»æ‡‰ç”¨å’Œç®¡ç†å¾Œå°éƒ½ä½¿ç”¨ç›¸åŒçš„ Redis
import Redis from 'ioredis';
const redis = new Redis(process.env.REDIS_URL);

// ç®¡ç†å¾Œå°ä¿®æ”¹é‡‘å¹£æ™‚
await redis.del(`user:${userId}:profile`);

// ä¸»æ‡‰ç”¨è‡ªå‹•å¤±æ•ˆç·©å­˜
const cached = await redis.get(`user:${userId}:profile`);
if (!cached) {
  // å¾ Firestore é‡æ–°è®€å–
}
```

**å„ªé»**ï¼š
- âœ… å®Œç¾åŒæ­¥ï¼ˆç«‹å³æ¸…é™¤ï¼‰
- âœ… å¯æ“´å±•åˆ°å¤šå€‹æœå‹™å™¨å¯¦ä¾‹

**ç¼ºé»**ï¼š
- âš ï¸ å¢åŠ  Redis åŸºç¤è¨­æ–½æˆæœ¬
- âš ï¸ å¢åŠ ç³»çµ±è¤‡é›œåº¦

---

### 3. ç•¶å‰æ–¹æ¡ˆçš„é©ç”¨æ€§

**ç•¶å‰ä¿®å¾©ï¼ˆæ¸›å°‘ TTLï¼‰é©åˆä»¥ä¸‹æƒ…æ³**ï¼š
- âœ… ç®¡ç†å“¡æ“ä½œé »ç‡ä¸é«˜ï¼ˆæ¯å¤© < 100 æ¬¡ï¼‰
- âœ… 1-2 åˆ†é˜å»¶é²å¯æ¥å—
- âœ… å¸Œæœ›ä¿æŒæ¶æ§‹ç°¡å–®

**å»ºè­°å‡ç´šç‚ºé¸é … B çš„æƒ…æ³**ï¼š
- âš ï¸ ç®¡ç†å“¡éœ€è¦ç«‹å³é©—è­‰ä¿®æ”¹çµæœ
- âš ï¸ é »ç¹ä¿®æ”¹ç”¨æˆ¶è³‡ç”¢ï¼ˆæ¯å¤© > 100 æ¬¡ï¼‰
- âš ï¸ ç”¨æˆ¶æŠ•è¨´é‡‘å¹£ä¸åŒæ­¥

**å»ºè­°å‡ç´šç‚ºé¸é … A æˆ– C çš„æƒ…æ³**ï¼š
- âš ï¸ éœ€è¦å¤šå€‹æœå‹™å™¨å¯¦ä¾‹ï¼ˆæ°´å¹³æ“´å±•ï¼‰
- âš ï¸ éœ€è¦å¯¦æ™‚é€šçŸ¥å…¶ä»–åŠŸèƒ½ï¼ˆéåƒ…é‡‘å¹£ï¼‰

---

## ğŸ“ ç›¸é—œæ–‡æª”

- **ç”¨æˆ¶æª”æ¡ˆç·©å­˜æ–‡æª”**: [chat-app/docs/USER_PROFILE_CACHE.md](../chat-app/docs/USER_PROFILE_CACHE.md)
- **ä¸»æ‡‰ç”¨é–‹ç™¼æŒ‡å—**: [chat-app/CLAUDE.md](../chat-app/CLAUDE.md)
- **ç®¡ç†å¾Œå°æ–‡æª”**: [chat-app-admin/README.md](../chat-app-admin/README.md)
- **Firestore é›†åˆæ¶æ§‹**: [chat-app/docs/firestore-collections.md](../chat-app/docs/firestore-collections.md)

---

## ğŸš€ éƒ¨ç½²æª¢æŸ¥æ¸…å–®

- [x] å¾Œç«¯ç·©å­˜ TTL å·²ä¿®æ”¹
- [x] å‰ç«¯ç·©å­˜ TTL å·²ä¿®æ”¹
- [x] clearUserProfile å·²å¢å¼·
- [x] useCoins è³¼è²·å¾Œæ¸…é™¤ç·©å­˜
- [x] ç®¡ç†å¾Œå°æ·»åŠ æ—¥èªŒæé†’
- [ ] é‡å•Ÿä¸»æ‡‰ç”¨å¾Œç«¯æœå‹™ï¼ˆä½¿æ–°é…ç½®ç”Ÿæ•ˆï¼‰
- [ ] é‡æ–°æ§‹å»ºä¸¦éƒ¨ç½²å‰ç«¯ï¼ˆvite buildï¼‰
- [ ] é©—è­‰æ¸¬è©¦å ´æ™¯ 1-3
- [ ] ç›£æ§ Firestore è®€å–ç”¨é‡ï¼ˆé¦–å‘¨ï¼‰

---

## ğŸ“ è¯çµ¡è³‡è¨Š

**ä¿®å¾©åŸ·è¡Œè€…**: Claude Code Agent
**å¯©æ ¸è€…**: å¾…å¯©æ ¸
**éƒ¨ç½²æ—¥æœŸ**: å¾…éƒ¨ç½²

å¦‚æœ‰å•é¡Œï¼Œè«‹åƒè€ƒä¸Šè¿°æ–‡æª”æˆ–è¯ç¹«é–‹ç™¼åœ˜éšŠã€‚
