# ç®¡ç†å¾Œè‡ºæ›´æ–°æ—¥èªŒ

## [2025-01-14] - é‡å¤§æ›´æ–°ï¼šå®Œå–„ç”¨æˆ¶åˆªé™¤åŠŸèƒ½

### âœ… ä¿®å¾©å’Œæ”¹é€²

#### 1. **å‰ç«¯ CSRF Token è™•ç†** (å·²ä¿®å¾©)
- **å•é¡Œ**: å‰ç«¯æ²’æœ‰ç²å–å’Œç™¼é€ CSRF Tokenï¼Œå°è‡´æ‰€æœ‰å¯«æ“ä½œè¿”å› 403 Forbidden
- **ä¿®å¾©**:
  - âœ… è‡ªå‹•ç²å– CSRF Token (`/api/csrf-token`)
  - âœ… æ‰€æœ‰ POST/PUT/DELETE/PATCH è«‹æ±‚è‡ªå‹•æ”œå¸¶ `x-csrf-token` header
  - âœ… Token éæœŸæ™‚è‡ªå‹•é‡æ–°ç²å–ä¸¦é‡è©¦è«‹æ±‚
  - âœ… è¨­ç½® `withCredentials: true` å…è¨±æ”œå¸¶ Cookie
- **å½±éŸ¿**: æ‰€æœ‰å¯«æ“ä½œç¾åœ¨éƒ½èƒ½æ­£å¸¸å·¥ä½œ
- **æ–‡ä»¶**: `frontend/src/utils/api.js`

#### 2. **å®Œå–„ç”¨æˆ¶åˆªé™¤é‚è¼¯** (å·²ä¿®å¾©)
- **å•é¡Œ**: å¾Œç«¯åˆªé™¤ç”¨æˆ¶æ™‚éºæ¼äº†å¤šå€‹ Firestore é›†åˆçš„æ¸…ç†ï¼Œå°è‡´æ•¸æ“šåº«ä¸­æ®˜ç•™å¤§é‡ç”¨æˆ¶æ•¸æ“š
- **éºæ¼çš„é›†åˆ**:
  - âŒ `user_potions` - ç”¨æˆ¶è—¥æ°´æ•¸æ“šï¼ˆå­é›†åˆï¼‰
  - âŒ `transactions` - äº¤æ˜“è¨˜éŒ„
  - âŒ `generatedVideos` - AI ç”Ÿæˆçš„å½±ç‰‡
  - âŒ `orders` - è¨‚å–®è¨˜éŒ„
  - âŒ `character_creation_flows` - è§’è‰²å‰µå»ºæµç¨‹
  - âŒ `idempotency_keys` - å†ªç­‰æ€§éµ
- **ä¿®å¾©**:
  - âœ… æ·»åŠ æ‰€æœ‰éºæ¼é›†åˆçš„æ¸…ç†é‚è¼¯
  - âœ… å¢åŠ è©³ç´°çš„æ—¥èªŒè¼¸å‡ºï¼Œä¾¿æ–¼è¿½è¹¤åˆªé™¤é€²åº¦
  - âœ… æ¯å€‹é›†åˆå–®ç¨è™•ç†ï¼Œå¤±æ•—ä¸æœƒä¸­æ–·æ•´å€‹æµç¨‹
  - âœ… è¿”å›è©³ç´°çš„åˆªé™¤çµ±è¨ˆä¿¡æ¯
- **å½±éŸ¿**: ç¾åœ¨åˆªé™¤ç”¨æˆ¶æœƒå¾¹åº•æ¸…ç†æ‰€æœ‰ç›¸é—œæ•¸æ“š
- **æ–‡ä»¶**: `backend/src/routes/users.routes.js`

### ğŸ†• æ–°å¢å·¥å…·

#### 1. **æ¬Šé™ç®¡ç†è…³æœ¬**
- **set-super-admin.js** - è¨­ç½®è¶…ç´šç®¡ç†å“¡æ¬Šé™
  ```bash
  node scripts/set-super-admin.js <emailæˆ–UID>
  ```
- **list-admins.js** - åˆ—å‡ºæ‰€æœ‰ç®¡ç†å“¡ç”¨æˆ¶
  ```bash
  node scripts/list-admins.js
  ```

#### 2. **æ•¸æ“šæ¸…ç†è…³æœ¬**
- **cleanup-user-data.js** - æ¸…ç†å·²åˆªé™¤ç”¨æˆ¶çš„éºç•™æ•¸æ“š
  ```bash
  node scripts/cleanup-user-data.js <ç”¨æˆ¶UID>
  ```
  - ç”¨æ–¼æ¸…ç†æ­·å²éºç•™æ•¸æ“šï¼ˆä¹‹å‰åˆªé™¤ä½†æœªæ¸…ç†ä¹¾æ·¨çš„ç”¨æˆ¶ï¼‰
  - æª¢æŸ¥ä¸¦æ¸…ç† 10 å€‹ä¸åŒçš„é›†åˆ
  - è¼¸å‡ºè©³ç´°çš„åˆªé™¤çµ±è¨ˆ

### ğŸ“š æ–°å¢æ–‡æª”

- **scripts/README.md** - è…³æœ¬å·¥å…·ä½¿ç”¨æŒ‡å—
- **scripts/CLEANUP_GUIDE.md** - ç”¨æˆ¶æ•¸æ“šæ¸…ç†è©³ç´°æŒ‡å—
- **CHANGELOG.md** - æ›´æ–°æ—¥èªŒï¼ˆæœ¬æ–‡ä»¶ï¼‰

### ğŸ”§ æŠ€è¡“ç´°ç¯€

#### åˆªé™¤é‚è¼¯æ”¹é€²å°æ¯”

**ä¹‹å‰ï¼ˆéºæ¼ 6 å€‹é›†åˆï¼‰**:
```javascript
deletionStats = {
  conversations: 0,
  photos: 0,
};
// åªæ¸…ç† 5 å€‹é›†åˆ:
// 1. conversations
// 2. user_photos + å­é›†åˆ
// 3. usage_limits
// 4. users
// 5. Firebase Auth
```

**ç¾åœ¨ï¼ˆå®Œæ•´æ¸…ç† 11 å€‹é›†åˆï¼‰**:
```javascript
deletionStats = {
  conversations: 0,
  photos: 0,
  potions: 0,           // âœ… æ–°å¢
  transactions: 0,      // âœ… æ–°å¢
  orders: 0,            // âœ… æ–°å¢
  videos: 0,            // âœ… æ–°å¢
  characterCreationFlows: 0,  // âœ… æ–°å¢
  idempotencyKeys: 0,   // âœ… æ–°å¢
  usageLimits: 0,
  users: 0,
};
// æ¸…ç† 11 å€‹é›†åˆ:
// 1. conversationsï¼ˆå°è©±è¨˜éŒ„ï¼‰
// 2. user_photos + å­é›†åˆï¼ˆç…§ç‰‡ï¼‰
// 3. user_potions + å­é›†åˆï¼ˆè—¥æ°´ï¼‰âœ… æ–°å¢
// 4. transactionsï¼ˆäº¤æ˜“è¨˜éŒ„ï¼‰âœ… æ–°å¢
// 5. ordersï¼ˆè¨‚å–®ï¼‰âœ… æ–°å¢
// 6. generatedVideosï¼ˆå½±ç‰‡ï¼‰âœ… æ–°å¢
// 7. character_creation_flowsï¼ˆè§’è‰²å‰µå»ºæµç¨‹ï¼‰âœ… æ–°å¢
// 8. idempotency_keysï¼ˆå†ªç­‰æ€§éµï¼‰âœ… æ–°å¢
// 9. usage_limitsï¼ˆä½¿ç”¨é™åˆ¶ï¼‰
// 10. usersï¼ˆç”¨æˆ¶åŸºæœ¬è³‡æ–™ï¼‰
// 11. Firebase Authï¼ˆèªè­‰ï¼‰
```

#### API éŸ¿æ‡‰æ”¹é€²

**ä¹‹å‰**:
```json
{
  "message": "ç”¨æˆ¶åˆªé™¤æˆåŠŸ",
  "userId": "...",
  "deletionStats": {
    "conversations": 0,
    "photos": 0
  }
}
```

**ç¾åœ¨**:
```json
{
  "message": "ç”¨æˆ¶åˆªé™¤æˆåŠŸ",
  "userId": "...",
  "deletionStats": {
    "conversations": 0,
    "photos": 0,
    "potions": 2,
    "transactions": 137,
    "orders": 0,
    "videos": 6,
    "characterCreationFlows": 0,
    "idempotencyKeys": 0,
    "usageLimits": 1,
    "users": 1
  },
  "totalDeleted": 147
}
```

### âš ï¸ é‡è¦æé†’

#### æ­·å²éºç•™æ•¸æ“šæ¸…ç†

å¦‚æœåœ¨æ­¤æ¬¡æ›´æ–°ä¹‹å‰åˆªé™¤éç”¨æˆ¶ï¼Œé€™äº›ç”¨æˆ¶å¯èƒ½æœ‰éºç•™æ•¸æ“šã€‚ä½¿ç”¨æ¸…ç†è…³æœ¬è™•ç†ï¼š

```bash
cd chat-app-admin/backend
node scripts/cleanup-user-data.js <ç”¨æˆ¶UID>
```

**ç¤ºä¾‹**ï¼ˆå¯¦éš›æ¸…ç†è¨˜éŒ„ï¼‰:
```
ç”¨æˆ¶: PS7LYFSstdgyr7b9sCOKFgt3QVB3
æ¸…ç†çµæœ:
  - user_potions: 2 å€‹è—¥æ°´è¨˜éŒ„
  - transactions: 137 ç­†äº¤æ˜“è¨˜éŒ„
  - generatedVideos: 6 å€‹å½±ç‰‡è¨˜éŒ„
  ç¸½è¨ˆ: 145 ç­†éºç•™è¨˜éŒ„å·²æ¸…ç†
```

#### å‡ç´šæ­¥é©Ÿ

1. **åˆ·æ–°å‰ç«¯é é¢**
   - Windows/Linux: `Ctrl + F5`
   - Mac: `Cmd + Shift + R`
   - é€™æœƒè‡ªå‹•ç²å–æ–°çš„ CSRF Token

2. **é‡å•Ÿç®¡ç†å¾Œè‡ºå¾Œç«¯æœå‹™**
   ```bash
   # å¦‚æœå¾Œç«¯æœå‹™æ­£åœ¨é‹è¡Œï¼Œé‡å•Ÿå®ƒ
   # ç¢ºä¿æ–°çš„åˆªé™¤é‚è¼¯ç”Ÿæ•ˆ
   ```

3. **ç¢ºèªæ¬Šé™**ï¼ˆå¯é¸ï¼‰
   ```bash
   cd chat-app-admin/backend
   node scripts/list-admins.js

   # å¦‚æœéœ€è¦è¨­ç½® super_admin æ¬Šé™
   node scripts/set-super-admin.js <ä½ çš„Email>
   ```

4. **æ¸…ç†æ­·å²éºç•™æ•¸æ“š**ï¼ˆå¯é¸ï¼‰
   ```bash
   # æª¢æŸ¥ Firestore Console ä¸­æ˜¯å¦æœ‰å·²åˆªé™¤ç”¨æˆ¶çš„éºç•™æ•¸æ“š
   # ä½¿ç”¨æ¸…ç†è…³æœ¬è™•ç†
   node scripts/cleanup-user-data.js <ç”¨æˆ¶UID>
   ```

### ğŸ¯ æ¸¬è©¦å»ºè­°

1. **æ¸¬è©¦åˆªé™¤åŠŸèƒ½**:
   - å‰µå»ºä¸€å€‹æ¸¬è©¦ç”¨æˆ¶
   - è®“è©²ç”¨æˆ¶é€²è¡Œå„ç¨®æ“ä½œï¼ˆå°è©±ã€è³¼è²·ã€ç”Ÿæˆç…§ç‰‡/å½±ç‰‡ç­‰ï¼‰
   - é€šéç®¡ç†å¾Œè‡ºåˆªé™¤è©²ç”¨æˆ¶
   - åœ¨ Firestore Console ä¸­é©—è­‰æ‰€æœ‰æ•¸æ“šå·²æ¸…é™¤

2. **æŸ¥çœ‹æ—¥èªŒè¼¸å‡º**:
   - åˆªé™¤ç”¨æˆ¶æ™‚ï¼Œå¾Œç«¯æœƒè¼¸å‡ºè©³ç´°çš„æ—¥èªŒ
   - å¯ä»¥è¿½è¹¤æ¯å€‹é›†åˆçš„æ¸…ç†é€²åº¦

3. **é©—è­‰çµ±è¨ˆæ•¸æ“š**:
   - API éŸ¿æ‡‰ä¸­æœƒåŒ…å«è©³ç´°çš„åˆªé™¤çµ±è¨ˆ
   - ç¢ºèªæ‰€æœ‰ç›¸é—œé›†åˆéƒ½å·²è™•ç†

### ğŸ“Š å½±éŸ¿è©•ä¼°

- **æ•¸æ“šå®Œæ•´æ€§**: âœ… å¤§å¹…æ”¹å–„ï¼Œä¸å†æœ‰éºç•™æ•¸æ“š
- **æ€§èƒ½å½±éŸ¿**: âš ï¸ åˆªé™¤æ™‚é–“å¢åŠ ï¼ˆéœ€æ¸…ç†æ›´å¤šé›†åˆï¼‰ï¼Œä½†åœ¨å¯æ¥å—ç¯„åœå…§
- **å‘å¾Œå…¼å®¹**: âœ… å®Œå…¨å…¼å®¹ï¼Œä¸å½±éŸ¿ç¾æœ‰åŠŸèƒ½
- **å®‰å…¨æ€§**: âœ… æå‡ï¼ŒCSRF Token ä¿è­·å·²æ­£å¸¸å·¥ä½œ

### ğŸ› å·²çŸ¥å•é¡Œ

ç„¡

### ğŸ“ å¾…è¾¦äº‹é …

- [ ] è€ƒæ…®å¯¦ç¾æ‰¹é‡æ¸…ç†å·¥å…·ï¼ˆæƒæä¸¦æ¸…ç†æ‰€æœ‰éºç•™æ•¸æ“šï¼‰
- [ ] è€ƒæ…®å¯¦ç¾å­¤ç«‹æ•¸æ“šæª¢æ¸¬ï¼ˆå®šæœŸæª¢æŸ¥æ˜¯å¦æœ‰ä¸å°æ‡‰ Firebase Auth çš„æ•¸æ“šï¼‰
- [ ] è€ƒæ…®å¯¦ç¾è»Ÿåˆªé™¤æ©Ÿåˆ¶ï¼ˆä¿ç•™æ•¸æ“šä½†æ¨™è¨˜ç‚ºå·²åˆªé™¤ï¼Œå¯æ¢å¾©ï¼‰

---

## ç›¸é—œéˆæ¥

- [è…³æœ¬å·¥å…·èªªæ˜](backend/scripts/README.md)
- [æ•¸æ“šæ¸…ç†æŒ‡å—](backend/scripts/CLEANUP_GUIDE.md)
- [ç®¡ç†å¾Œè‡ºå®Œæ•´æ–‡æª”](README.md)
