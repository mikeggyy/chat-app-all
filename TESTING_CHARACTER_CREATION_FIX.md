# 角色創建資料保存修復 - 測試指南

## 修復內容

### 🔥 關鍵修復：錯誤處理改進

**問題根源**：`useCharacterCreationFlow.ts` 和 `CharacterCreateGeneratingView.vue` 中的 `syncSummaryToBackend` 函數會靜默吞併所有同步錯誤，導致：
- 即使保存失敗，用戶也能繼續下一步
- 最終創建角色時，因為沒有 persona 數據，導致欄位全空

**已修復的文件**：
1. `chat-app/frontend/src/composables/useCharacterCreationFlow.ts`
   - `syncSummaryToBackend()` 現在會重新拋出所有錯誤
   - 初始化失敗、flowId 缺失、同步失敗都會拋出明確的錯誤訊息

2. `chat-app/frontend/src/views/CharacterCreateGeneratingView.vue`
   - `persistCreationSummary()` 捕獲錯誤後會顯示提示並重新拋出
   - 選擇步驟和設定步驟的確認按鈕都有錯誤處理
   - 同步失敗時會停留在當前頁面，阻止跳轉

3. **AI 魔法師重置**：角色創建成功後自動重置計數（`CharacterCreateVoiceView.vue`）

## 測試步驟

### 1. 重啟前端開發服務器（必須！）

```bash
# 停止前端服務器（按 Ctrl+C）
# 然後重新啟動
cd chat-app/frontend
npm run dev
```

### 2. 清除瀏覽器緩存和 Storage

1. 打開瀏覽器開發者工具（F12）
2. Application 標籤 → Storage → Clear storage
3. 勾選所有選項（Local storage, Session storage, Cache storage）
4. 點擊「Clear site data」
5. 刷新頁面（Ctrl+R）

### 3. 創建新角色並觀察

#### 步驟 A：選擇性別和外觀

1. 訪問 `http://192.168.1.107:5173/#/create-character/gender`
2. 選擇性別（男性或女性）
3. 點擊「下一步」

#### 步驟 B：生成圖片

1. 等待圖片生成完成
2. **檢查點 1**：第一張圖片應該自動選中（有邊框或高亮）
3. 選擇一張圖片
4. 點擊「下一步」

**⚠️ 重要**：打開瀏覽器控制台（F12 → Console），觀察是否有錯誤

#### 步驟 C：填寫角色設定

1. 填寫以下**所有字段**（請勿留空）：
   - 角色名：例如「測試角色」
   - 角色設定：例如「一個友善的 AI 助手」
   - 隱藏設定：例如「測試用角色」
   - 開場白：例如「你好，很高興認識你！」

2. **檢查點 2**：填寫完成後，「下一步」按鈕應該變為可點擊

3. 點擊「下一步」

**⚠️ 重要**：觀察控制台輸出

- ✅ 成功：沒有錯誤，跳轉到語音頁面
- ❌ 失敗：出現紅色錯誤訊息，例如：
  - `保存角色設定失敗，請檢查網絡連接後重試`
  - `保存外觀設定失敗，請檢查網絡連接後重試`

如果出現錯誤，請：
1. **不要關閉頁面**
2. 檢查網絡連接
3. 檢查後端服務器是否正常運行
4. 將控制台的完整錯誤訊息複製給我

#### 步驟 D：選擇語音並完成

1. 選擇一個語音（或跳過）
2. 點擊「完成創建」
3. 等待角色創建成功

### 4. 驗證資料是否正確保存

#### 方法 1：檢查角色詳情頁面

1. 創建成功後，點擊「查看角色」
2. 檢查以下字段是否顯示：
   - ✅ 角色名
   - ✅ 背景設定（角色設定）
   - ✅ 隱藏設定
   - ✅ 開場白
   - ✅ 圖片
   - ✅ 語音（如果選擇了）

#### 方法 2：使用診斷腳本

```bash
cd chat-app/backend
node scripts/check-character-data.js <角色ID>
```

角色 ID 可以從：
- 角色詳情頁面的 URL：`/#/character/match-xxxxx`
- 或者從瀏覽器控制台的創建成功日誌中找到

### 5. 測試 AI 魔法師重置

1. 創建第一個角色時，使用 AI 魔法師 3 次（最大限制）
2. 完成創建
3. 立即創建第二個角色
4. **檢查點 3**：AI 魔法師的可用次數應該重置為 3/3

## 預期結果

### ✅ 修復成功的標誌

1. 所有字段都正確保存到資料庫
2. 角色詳情頁面顯示完整資料
3. 同步失敗時會顯示錯誤提示，不會跳轉
4. AI 魔法師在每次創建後重置

### ❌ 仍有問題的標誌

1. 角色詳情頁面缺少字段
2. 診斷腳本顯示字段為空
3. 沒有看到任何錯誤提示，但資料沒有保存
4. AI 魔法師次數沒有重置

## 如果測試失敗

請提供以下資訊：

1. **瀏覽器控制台的完整錯誤訊息**（截圖或複製文字）
2. **網絡請求記錄**：
   - F12 → Network 標籤
   - 篩選 XHR
   - 找到 `flows` 相關的 PATCH 請求
   - 查看 Request Payload 和 Response
3. **診斷腳本的輸出**：
   ```bash
   node scripts/check-character-data.js <角色ID>
   ```
4. **填寫的資料內容**（確認不是因為空值）

## 額外的調試建議

### 查看網絡請求

1. F12 → Network 標籤
2. 填寫設定步驟並點擊「下一步」
3. 觀察是否有以下請求：
   - `PATCH /api/character-creation/flows/{flowId}`
   - 查看 Request Payload 是否包含 `persona` 數據
   - 查看 Response 是否返回 200/201 狀態碼

### 查看後端日誌

```bash
# 後端控制台應該顯示：
[Update Flow] Flow after merge: ...
```

如果沒有看到此日誌，說明請求沒有到達後端。

## 常見問題

### Q: 點擊「下一步」後沒有任何反應

A: 檢查表單驗證，確保所有必填字段都已填寫

### Q: 看到「保存角色設定失敗」的提示

A:
1. 檢查後端服務器是否正常運行
2. 檢查網絡連接
3. 查看瀏覽器控制台的詳細錯誤
4. 查看後端控制台是否有錯誤日誌

### Q: 資料仍然沒有保存

A: 請提供完整的測試結果，我會進一步診斷
