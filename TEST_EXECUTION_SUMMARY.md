# 商業邏輯測試執行指南 - 2025-01-13

## 📋 測試套件概覽

為驗證商業邏輯修復的完整性，我們創建了全面的自動化測試套件，涵蓋所有關鍵場景和邊緣情況。

### 測試文件位置

```
chat-app/backend/scripts/
├── test-all-business-logic.js      # 運行所有測試
├── test-membership-upgrade.js      # 會員升級測試（5 個場景）
├── test-character-unlock.js        # 角色解鎖購買測試（6 個場景）
└── TEST_GUIDE.md                   # 詳細測試指南
```

---

## 🚀 快速開始

### 方法 1: 使用 npm 腳本（推薦）

```bash
cd chat-app/backend

# 運行所有測試
npm run test:business-logic

# 或單獨運行
npm run test:membership    # 只測試會員升級
npm run test:unlock        # 只測試角色解鎖購買
```

### 方法 2: 直接運行腳本

```bash
cd chat-app/backend

# 運行所有測試
node scripts/test-all-business-logic.js

# 單獨運行
node scripts/test-membership-upgrade.js
node scripts/test-character-unlock.js
```

---

## 📊 測試覆蓋範圍

### 1. 會員升級測試 (5 個場景)

| 測試場景 | 驗證項目 | 覆蓋的修復 |
|---------|---------|----------|
| **測試 1**: 正常升級流程 | 會員等級、獎勵發放、鎖定清除 | 基礎功能 |
| **測試 2**: 保留剩餘拍照次數 | 次數計算、卡片轉換 | 業務邏輯 |
| **測試 3**: 防止並發升級 | 5 分鐘內拒絕重複 | P1-1 修復 |
| **測試 4**: 過期鎖定自動解鎖 | 6 分鐘後自動解鎖 | P1-1 修復 |
| **測試 5**: 舊數據兼容 | 無時間戳強制解鎖 | P1-1 修復 |

### 2. 角色解鎖購買測試 (6 個場景)

| 測試場景 | 驗證項目 | 覆蓋的修復 |
|---------|---------|----------|
| **測試 1**: 使用解鎖票購買 | 卡片扣除、同步更新 | P2-1 修復 |
| **測試 2**: 使用金幣購買 | 金幣扣除、交易記錄格式 | P1-2 修復 |
| **測試 3**: 舊格式兼容 | 數據遷移、雙向同步 | P2-1 修復 |
| **測試 4**: 解鎖票不足 | Fallback 到金幣 | 錯誤處理 |
| **測試 5**: 金幣不足 | Transaction 回滾 | 錯誤處理 |
| **測試 6**: 重複購買防止 | 防止重複扣款 | 安全性 |

**總計**: **11 個自動化測試場景**

---

## ✅ 預期測試結果

### 成功輸出示例

```
🧪 商業邏輯測試套件
測試時間: 2025/1/13 下午10:30:00
環境: 生產環境 Firestore

======================================================================
📋 會員升級測試
======================================================================

🚀 運行: test-membership-upgrade.js

============================================================
📋 測試: 測試 1: 正常升級流程（免費 → VIP，無剩餘拍照次數）
============================================================
創建測試用戶: test-membership-user-1705156200000 (free, 拍照次數: 0)
執行升級...
✅ 升級成功
✅ 用戶會員等級已更新為 VIP
✅ 角色解鎖卡發放正確: 10
✅ 拍照解鎖卡發放正確: 20
✅ 升級鎖定標記已清除
已清理測試用戶: test-membership-user-1705156200000

... (其他測試場景)

============================================================
📊 測試摘要
============================================================
✅ 測試 1: 通過
✅ 測試 2: 通過
✅ 測試 3: 通過
✅ 測試 4: 通過
✅ 測試 5: 通過

============================================================
✨ 所有測試通過！(5/5)
============================================================

✅ test-membership-upgrade.js 通過

======================================================================
📋 角色解鎖購買測試
======================================================================

... (類似輸出)

✅ test-character-unlock.js 通過

======================================================================
📊 測試總結
======================================================================
✅ 會員升級測試: 通過
✅ 角色解鎖購買測試: 通過

======================================================================
🎉 所有測試通過！(2/2)
======================================================================
```

---

## 🔧 測試環境配置

### 默認環境: 生產環境 Firestore

⚠️ **重要說明**:
- 測試會在生產環境 Firestore 上運行
- 使用唯一的測試用戶 ID（包含 `test-` 前綴和時間戳）
- 測試完成後自動清理所有數據
- **不會影響真實用戶數據**

### 在 Firebase Emulator 上測試（可選）

如果想在本地 Emulator 上測試：

```bash
# 終端 1: 啟動 Emulator
firebase emulators:start

# 終端 2: 設置環境變數並運行測試
export USE_FIREBASE_EMULATOR=true
npm run test:business-logic
```

---

## 📝 測試數據清理

測試腳本會自動清理以下數據：

1. ✅ `users` 集合 - 測試用戶文檔
2. ✅ `usage_limits` 集合 - 測試用戶限制數據
3. ✅ `transactions` 集合 - 測試交易記錄
4. ✅ `membership_history` 集合 - 測試會員歷史

**清理時機**: 每個測試完成後（在 `finally` 區塊中）

---

## 🐛 故障排除

### 問題 1: 測試失敗

**查看詳細錯誤**:
- 測試輸出包含詳細的錯誤訊息
- 檢查哪個驗證步驟失敗了
- 查看 Firestore Console 中的實際數據

**常見原因**:
- Firebase 連接問題
- 環境變數未正確配置
- Firestore 配額不足

### 問題 2: 測試卡住

**可能原因**:
- 網絡連接問題
- Firestore 響應慢
- Transaction 死鎖

**解決方案**:
- 按 Ctrl+C 終止測試
- 檢查網絡連接
- 重新運行測試

### 問題 3: 測試數據未清理

**手動清理**:
```bash
# 在 Firebase Console 中搜索並刪除
# 用戶 ID 包含 "test-" 的所有文檔
```

或創建清理腳本：
```javascript
// scripts/cleanup-test-data.js
const snapshot = await db.collection('users')
  .where('uid', '>=', 'test-')
  .where('uid', '<', 'test-~')
  .get();

for (const doc of snapshot.docs) {
  await doc.ref.delete();
}
```

---

## 📋 部署前檢查清單

### 1. 運行測試

```bash
cd chat-app/backend
npm run test:business-logic
```

- [ ] 所有測試通過 (11/11)
- [ ] 無錯誤或警告訊息
- [ ] 測試數據已自動清理

### 2. 驗證修復

檢查以下關鍵修復是否生效：

**P1-1: 會員升級鎖定**
- [ ] 並發升級被正確拒絕（測試 3）
- [ ] 過期鎖定自動解鎖（測試 4）
- [ ] 舊數據正確處理（測試 5）

**P1-2: 交易記錄格式**
- [ ] 類型為 "spend"（測試 2）
- [ ] 金額為絕對值（測試 2）
- [ ] 元數據包含 itemType（測試 2）

**P2-1: 卡片餘額統一**
- [ ] 新舊格式同步更新（測試 1, 3）
- [ ] 舊用戶數據正確遷移（測試 3）

### 3. 檢查 Firestore

- [ ] 無遺留的測試數據
- [ ] 生產數據未受影響

### 4. 文檔檢查

- [ ] 閱讀 [TEST_GUIDE.md](chat-app/backend/scripts/TEST_GUIDE.md)
- [ ] 理解每個測試場景的目的
- [ ] 知道如何添加新測試

---

## 📚 相關文檔

| 文檔 | 說明 |
|------|------|
| [TEST_GUIDE.md](chat-app/backend/scripts/TEST_GUIDE.md) | 詳細測試指南 |
| [BUSINESS_LOGIC_FIXES_2025-01-13_FINAL.md](BUSINESS_LOGIC_FIXES_2025-01-13_FINAL.md) | 修復詳情 |
| [LOGIC_VERIFICATION_REPORT_2025-01-13.md](LOGIC_VERIFICATION_REPORT_2025-01-13.md) | 邏輯驗證報告 |

---

## 🎯 下一步

### 部署前

1. ✅ 運行所有測試：`npm run test:business-logic`
2. ✅ 確認所有測試通過
3. ✅ 檢查測試輸出無異常

### 部署後

1. 📊 監控生產環境日誌
2. 🔍 查找以下日誌訊息：
   - "檢測到過期的升級鎖定"
   - "檢測到無時間戳的升級鎖定"
   - 交易記錄格式（type: "spend"）
3. 🎯 驗證真實用戶流程：
   - 會員升級
   - 角色解鎖購買
   - 舊用戶數據遷移

---

## 💡 測試最佳實踐

### 添加新測試

當你修改或添加新功能時：

1. **創建測試場景** - 在對應的測試文件中添加測試函數
2. **驗證所有情況** - 包括成功情況和錯誤情況
3. **清理測試數據** - 使用 `try...finally` 確保清理
4. **更新測試計數** - 更新測試摘要中的總數

### 測試命名規範

- `test-<功能名稱>.js` - 測試文件
- `testCamelCaseScenario()` - 測試函數
- 清晰的測試描述 - 使用 `logTest()`

---

## 📞 支持

如果遇到問題或需要幫助：

1. 查看測試輸出的詳細錯誤訊息
2. 檢查 Firestore Console 中的實際數據
3. 參考 [TEST_GUIDE.md](chat-app/backend/scripts/TEST_GUIDE.md)
4. 查看相關修復文檔了解預期行為

---

**測試套件版本**: 1.0.0
**創建日期**: 2025-01-13
**狀態**: ✅ 就緒
**維護者**: Claude Code

---

## 🎉 總結

✅ **測試套件已就緒**
✅ **11 個自動化測試場景**
✅ **100% 覆蓋關鍵修復**
✅ **自動數據清理**
✅ **詳細測試指南**

**立即開始測試**: `npm run test:business-logic`
