name: æ¸¬è©¦å¥—ä»¶

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  test-frontend:
    name: å‰ç«¯æ¸¬è©¦ (Frontend Tests)
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./chat-app/frontend

    steps:
    - name: Checkout ä»£ç¢¼
      uses: actions/checkout@v4

    - name: è¨­ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: chat-app/frontend/package-lock.json

    - name: å®‰è£ä¾è³´
      run: npm ci

    - name: é‹è¡Œ Composable æ¸¬è©¦
      run: npm run test:run -- src/composables/**/*.spec.js

    - name: ç”Ÿæˆè¦†è“‹çŽ‡å ±å‘Š
      run: npm run test:coverage
      continue-on-error: true

    - name: ä¸Šå‚³è¦†è“‹çŽ‡å ±å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: frontend-coverage
        path: chat-app/frontend/coverage
        retention-days: 30

  test-backend:
    name: å¾Œç«¯æ¸¬è©¦ (Backend API Tests)
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./chat-app/backend

    steps:
    - name: Checkout ä»£ç¢¼
      uses: actions/checkout@v4

    - name: è¨­ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: chat-app/backend/package-lock.json

    - name: å®‰è£ä¾è³´
      run: npm ci

    - name: é‹è¡Œ API è·¯ç”±æ¸¬è©¦
      run: npm run test:run -- src/**/*.spec.js
      env:
        NODE_ENV: test
        FIREBASE_ADMIN_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    - name: ç”Ÿæˆè¦†è“‹çŽ‡å ±å‘Š
      run: npm run test:coverage
      continue-on-error: true
      env:
        NODE_ENV: test

    - name: ä¸Šå‚³è¦†è“‹çŽ‡å ±å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: backend-coverage
        path: chat-app/backend/coverage
        retention-days: 30

  test-summary:
    name: æ¸¬è©¦ç¸½çµ (Test Summary)
    runs-on: ubuntu-latest
    needs: [test-frontend, test-backend]
    if: always()

    steps:
    - name: ç”Ÿæˆæ¸¬è©¦ç¸½çµ
      run: |
        echo "## æ¸¬è©¦çµæžœç¸½çµ ðŸŽ¯" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- å‰ç«¯æ¸¬è©¦: ${{ needs.test-frontend.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- å¾Œç«¯æ¸¬è©¦: ${{ needs.test-backend.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "è©³ç´°å ±å‘Šè«‹æŸ¥çœ‹å„å€‹ Job çš„è¼¸å‡ºã€‚" >> $GITHUB_STEP_SUMMARY
