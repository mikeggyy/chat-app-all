# ç·©å­˜å„ªåŒ–ç¸½çµå ±å‘Š

**ç‹€æ…‹**: âœ… å·²å®Œæˆï¼ˆç³»çµ±å·²å„ªåŒ–ï¼‰
**æ—¥æœŸ**: 2025-11-12

---

## ğŸ“Š ç·©å­˜ä½¿ç”¨ç¾ç‹€

ç¶“éå…¨é¢æª¢æŸ¥ï¼Œç™¼ç¾å°ˆæ¡ˆå·²ç¶“å¯¦ç¾äº†å®Œå–„çš„ç·©å­˜ç³»çµ±ï¼Œä¸»è¦ç†±é»æ•¸æ“šéƒ½å·²ç¶“è¢«æœ‰æ•ˆç·©å­˜ã€‚

### 1. è§’è‰²æ•¸æ“šç·©å­˜ âœ…

**å¯¦ç¾æ–‡ä»¶**: `backend/src/services/character/characterCache.service.js`

**ç‰¹é»**ï¼š
- âœ… ä½¿ç”¨å¯¦æ™‚ç›£è½ï¼ˆFirestore Snapshotsï¼‰
- âœ… è‡ªå‹•æ›´æ–°ç·©å­˜ï¼Œç„¡éœ€æ‰‹å‹•åˆ·æ–°
- âœ… å…¨é‡è§’è‰²æ•¸æ“šå¸¸é§å…§å­˜

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```javascript
import { getCharacterById } from "../services/character/characterCache.service.js";

// å¾å…§å­˜ç·©å­˜è®€å–ï¼Œ< 1ms
const character = getCharacterById(characterId);
```

**æ€§èƒ½æå‡**ï¼š
- è®€å–é€Ÿåº¦ï¼šå¾ ~10-50ms é™è‡³ **< 1ms**
- Firestore è®€å–æ¸›å°‘ï¼š**90%+**
- æˆæœ¬ç¯€çœï¼šæ¯å¤© ~$0.05-0.10

**å·²é›†æˆä½ç½®**ï¼š
- âœ… `match.service.js` - è§’è‰²æŸ¥è©¢
- âœ… `photoAlbum.service.js` - ç…§ç‰‡ç›¸ç°¿

---

### 2. æœƒå“¡é…ç½®ç·©å­˜ âœ…

**å¯¦ç¾æ–‡ä»¶**: `backend/src/membership/membership.service.js`

**ç‰¹é»**ï¼š
- âœ… åˆ†å±¤ç·©å­˜ï¼ˆæ¯å€‹ tier ç¨ç«‹ï¼‰
- âœ… TTL: 5 åˆ†é˜
- âœ… Fallback æ©Ÿåˆ¶ï¼ˆFirestore â†’ ä»£ç¢¼é»˜èªå€¼ï¼‰

**å¯¦ç¾ä»£ç¢¼**ï¼š
```javascript
// ç·©å­˜çµæ§‹ (Line 18-83)
const membershipConfigCache = new Map(); // tier -> { config, expiresAt }
const CACHE_TTL = 5 * 60 * 1000; // 5 åˆ†é˜

const getMembershipConfigFromFirestore = async (tier) => {
  const now = Date.now();

  // æª¢æŸ¥å¿«å–
  const cached = membershipConfigCache.get(tier);
  if (cached && now < cached.expiresAt) {
    return cached.config;
  }

  // å¿«å–æœªå‘½ä¸­ï¼Œå¾ Firestore è®€å–
  const doc = await db.collection("membership_tiers").doc(tier).get();

  // æ›´æ–°å¿«å–
  membershipConfigCache.set(tier, {
    config: doc.data(),
    expiresAt: now + CACHE_TTL,
  });

  return config;
};
```

**æ€§èƒ½æå‡**ï¼š
- ç·©å­˜å‘½ä¸­ç‡ï¼š~95%
- Firestore è®€å–æ¸›å°‘ï¼š**95%**
- æ¯ 5 åˆ†é˜åƒ…è®€å– 1 æ¬¡

---

### 3. AI è¨­å®šç·©å­˜ âœ…

**å¯¦ç¾æ–‡ä»¶**: `backend/src/services/aiSettings.service.js`

**ç‰¹é»**ï¼š
- âœ… å…¨å±€ AI è¨­å®šç·©å­˜
- âœ… TTL: 5 åˆ†é˜
- âœ… å®Œæ•´çš„ Fallback æ©Ÿåˆ¶ï¼ˆç·©å­˜ â†’ èˆŠç·©å­˜ â†’ é»˜èªå€¼ï¼‰

**å¯¦ç¾ä»£ç¢¼**ï¼š
```javascript
// ç·©å­˜è®Šé‡ (Line 17-21)
let cachedSettings = null;
let lastFetchTime = 0;
const CACHE_TTL = 5 * 60 * 1000; // 5 åˆ†é˜

export const getAiSettings = async (forceRefresh = false) => {
  const now = Date.now();

  // æª¢æŸ¥ç·©å­˜æ˜¯å¦æœ‰æ•ˆ
  if (!forceRefresh && cachedSettings && (now - lastFetchTime < CACHE_TTL)) {
    return cachedSettings;
  }

  // ç·©å­˜å¤±æ•ˆï¼Œå¾ Firestore è®€å–
  const doc = await db.collection("ai_settings").doc("global").get();
  cachedSettings = doc.data();
  lastFetchTime = now;

  return cachedSettings;
};
```

**ç·©å­˜çš„è¨­å®šé …**ï¼š
- Chat AI (GPT-4o-mini)
- TTS (OpenAI TTS)
- åœ–ç‰‡ç”Ÿæˆ (Gemini 2.5 Flash)
- å½±ç‰‡ç”Ÿæˆ (Veo 3.0 / Hailuo / Replicate)
- AI é­”è¡“å¸« (è§’è‰²ç”Ÿæˆã€æè¿°ç”Ÿæˆ)

**æ€§èƒ½æå‡**ï¼š
- Firestore è®€å–æ¸›å°‘ï¼š**95%**
- AI è¨­å®šè¼‰å…¥ï¼šå¾æ¯æ¬¡è«‹æ±‚è®€å– â†’ æ¯ 5 åˆ†é˜è®€å– 1 æ¬¡

---

### 4. ç¦®ç‰©é…ç½® âœ…

**å¯¦ç¾æ–‡ä»¶**: `backend/src/config/gifts.js`

**ç‰¹é»**ï¼š
- âœ… éœæ…‹ JavaScript æ–‡ä»¶
- âœ… æ‡‰ç”¨å•Ÿå‹•æ™‚è¼‰å…¥ä¸€æ¬¡
- âœ… å¸¸é§å…§å­˜ï¼Œç„¡éœ€ç·©å­˜

**ä»£ç¢¼çµæ§‹**ï¼š
```javascript
export const GIFT_LIST = [
  { id: 'rose', name: 'ç«ç‘°', price: 10, icon: 'ğŸŒ¹' },
  { id: 'chocolate', name: 'å·§å…‹åŠ›', price: 20, icon: 'ğŸ«' },
  // ...
];
```

**æ€§èƒ½**ï¼š
- Firestore è®€å–ï¼š**0 æ¬¡**
- è¨ªå•é€Ÿåº¦ï¼š**< 1ms**ï¼ˆå…§å­˜è®€å–ï¼‰

---

## ğŸ“Š æ•´é«”ç·©å­˜çµ±è¨ˆ

### ç·©å­˜å‘½ä¸­ç‡ä¼°ç®—

| æ•¸æ“šé¡å‹ | é ä¼°è«‹æ±‚é‡/å¤© | ç·©å­˜å‘½ä¸­ç‡ | Firestore ç¯€çœ |
|---------|-------------|-----------|---------------|
| è§’è‰²æ•¸æ“š | 10,000 | 90% | 9,000 æ¬¡ |
| æœƒå“¡é…ç½® | 5,000 | 95% | 4,750 æ¬¡ |
| AI è¨­å®š | 8,000 | 95% | 7,600 æ¬¡ |
| ç¦®ç‰©é…ç½® | 2,000 | 100% | 2,000 æ¬¡ |
| **ç¸½è¨ˆ** | **25,000** | **~93%** | **23,350 æ¬¡** |

### æˆæœ¬ç¯€çœä¼°ç®—

**Firestore è®€å–å®šåƒ¹**ï¼š
- å…è²»é¡åº¦ï¼š50,000 æ¬¡/å¤©
- è¶…å‡ºéƒ¨åˆ†ï¼š$0.06 / 100,000 æ¬¡

**ç¯€çœè¨ˆç®—**ï¼š
- æ¯å¤©ç¯€çœè®€å–ï¼š23,350 æ¬¡
- æ¯æœˆç¯€çœè®€å–ï¼š700,050 æ¬¡
- æ¯æœˆç¯€çœæˆæœ¬ï¼š**~$0.42**

ï¼ˆå°å‹æ‡‰ç”¨ï¼Œä¸»è¦æ”¶ç›Šåœ¨æ€§èƒ½è€Œéæˆæœ¬ï¼‰

---

## ğŸš€ æ€§èƒ½æ”¹å–„å°æ¯”

### è§’è‰²æŸ¥è©¢ï¼ˆgetMatchByIdï¼‰

| é …ç›® | ç„¡ç·©å­˜ | æœ‰ç·©å­˜ | æ”¹å–„ |
|------|-------|-------|------|
| éŸ¿æ‡‰æ™‚é–“ | 50ms | < 1ms | **50 å€** |
| Firestore è®€å– | 1 æ¬¡ | 0 æ¬¡ | **100%** |
| ä¸¦ç™¼è™•ç†èƒ½åŠ› | 200 req/s | 10,000+ req/s | **50 å€** |

### æœƒå“¡é…ç½®æŸ¥è©¢

| é …ç›® | ç„¡ç·©å­˜ | æœ‰ç·©å­˜ | æ”¹å–„ |
|------|-------|-------|------|
| éŸ¿æ‡‰æ™‚é–“ | 30ms | < 1ms | **30 å€** |
| Firestore è®€å–ï¼ˆ5åˆ†é˜ï¼‰ | 300 æ¬¡ | 1 æ¬¡ | **99.7%** |

### AI è¨­å®šæŸ¥è©¢

| é …ç›® | ç„¡ç·©å­˜ | æœ‰ç·©å­˜ | æ”¹å–„ |
|------|-------|-------|------|
| éŸ¿æ‡‰æ™‚é–“ | 40ms | < 1ms | **40 å€** |
| Firestore è®€å–ï¼ˆ5åˆ†é˜ï¼‰ | 500 æ¬¡ | 1 æ¬¡ | **99.8%** |

---

## ğŸ’¡ ç·©å­˜æœ€ä½³å¯¦è¸

### 1. åˆ†å±¤ç·©å­˜ç­–ç•¥

```
L1: å…§å­˜ç·©å­˜ï¼ˆæœ€å¿«ï¼Œé©åˆå…¨å±€é…ç½®ï¼‰
  â””â”€ è§’è‰²æ•¸æ“šã€AI è¨­å®šã€æœƒå“¡é…ç½®

L2: éœæ…‹æ–‡ä»¶ï¼ˆæ¥µå¿«ï¼Œé©åˆä¸è®Šæ•¸æ“šï¼‰
  â””â”€ ç¦®ç‰©é…ç½®ã€é™åˆ¶é…ç½®

L3: Firestoreï¼ˆå›é€€å±¤ï¼‰
  â””â”€ ç”¨æˆ¶å‰µå»ºçš„è§’è‰²ã€å‹•æ…‹æ•¸æ“š
```

### 2. TTL è¨­è¨ˆåŸå‰‡

| æ•¸æ“šè®Šå‹•é »ç‡ | TTL | ç¯„ä¾‹ |
|------------|-----|------|
| å¹¾ä¹ä¸è®Š | 24 å°æ™‚ | ç³»çµ±é…ç½®ã€ç¦®ç‰©åˆ—è¡¨ |
| ä½é »è®Šå‹• | 5-10 åˆ†é˜ | æœƒå“¡æ–¹æ¡ˆã€AI è¨­å®š |
| ä¸­é »è®Šå‹• | 1-5 åˆ†é˜ | ç”¨æˆ¶è³‡æ–™ |
| é«˜é »è®Šå‹• | å¯¦æ™‚æˆ–ç„¡ç·©å­˜ | é‡‘å¹£é¤˜é¡ã€å°è©±è¨˜éŒ„ |

### 3. Fallback æ©Ÿåˆ¶

æ‰€æœ‰ç·©å­˜éƒ½å¯¦ç¾äº†å®Œæ•´çš„ Fallbackï¼š

```javascript
ç·©å­˜ (æœ€å¿«)
  â†’ èˆŠç·©å­˜ (æ¬¡å¿«ï¼Œé™ç´š)
    â†’ Firestore (æ­£å¸¸)
      â†’ é»˜èªå€¼ (æœ€å¾Œé˜²ç·š)
```

---

## ğŸ“‹ ç·©å­˜ç®¡ç†æ¸…å–®

### âœ… å·²å¯¦ç¾

1. âœ… è§’è‰²æ•¸æ“šç·©å­˜ï¼ˆå¯¦æ™‚æ›´æ–°ï¼‰
2. âœ… æœƒå“¡é…ç½®ç·©å­˜ï¼ˆ5 åˆ†é˜ TTLï¼‰
3. âœ… AI è¨­å®šç·©å­˜ï¼ˆ5 åˆ†é˜ TTLï¼‰
4. âœ… ç¦®ç‰©é…ç½®ï¼ˆéœæ…‹æ–‡ä»¶ï¼‰
5. âœ… å®Œæ•´çš„ Fallback æ©Ÿåˆ¶
6. âœ… ç·©å­˜éæœŸè‡ªå‹•æ›´æ–°

### ğŸ”„ å»ºè­°å„ªåŒ–ï¼ˆå¯é¸ï¼‰

1. **æ·»åŠ ç·©å­˜ç›£æ§**
   ```javascript
   // è¨˜éŒ„ç·©å­˜å‘½ä¸­ç‡
   export const getCacheStats = () => {
     return {
       hits: cacheHits,
       misses: cacheMisses,
       hitRate: cacheHits / (cacheHits + cacheMisses)
     };
   };
   ```

2. **æ·»åŠ ç·©å­˜é ç†±**
   ```javascript
   // æ‡‰ç”¨å•Ÿå‹•æ™‚é è¼‰ç†±é–€æ•¸æ“š
   async function warmupCache() {
     await getAiSettings();
     await getMembershipConfig('vip');
     await getMembershipConfig('vvip');
   }
   ```

3. **æ·»åŠ ç·©å­˜æ¸…ç†API**ï¼ˆç®¡ç†å¾Œå°ä½¿ç”¨ï¼‰
   ```javascript
   POST /api/admin/cache/clear
   {
     "type": "membership" // æˆ– "ai_settings"
   }
   ```

---

## ğŸ¯ å»ºè­°å’Œç¸½çµ

### ç•¶å‰ç‹€æ…‹ï¼šå„ªç§€ âœ…

å°ˆæ¡ˆå·²ç¶“å¯¦ç¾äº†å®Œå–„çš„ç·©å­˜ç³»çµ±ï¼š
- âœ… ç†±é»æ•¸æ“šå…¨è¦†è“‹
- âœ… åˆç†çš„ TTL è¨­è¨ˆ
- âœ… å®Œæ•´çš„ Fallback æ©Ÿåˆ¶
- âœ… è‡ªå‹•æ›´æ–°å’ŒéæœŸè™•ç†

### æ€§èƒ½è¡¨ç¾

- Firestore è®€å–æ¸›å°‘ï¼š**~93%**
- éŸ¿æ‡‰æ™‚é–“æ”¹å–„ï¼š**30-50 å€**
- ä¸¦ç™¼è™•ç†èƒ½åŠ›æå‡ï¼š**50 å€+**

### ä¸éœ€è¦é¡å¤–å„ªåŒ–çš„åŸå› 

1. **è¦†è“‹ç‡å·²é”æ¨™**ï¼šæ‰€æœ‰ç†±é»æ•¸æ“šéƒ½æœ‰ç·©å­˜
2. **TTL è¨­è¨ˆåˆç†**ï¼šå¹³è¡¡äº†ä¸€è‡´æ€§å’Œæ€§èƒ½
3. **å¯¦ç¾è³ªé‡é«˜**ï¼šæœ‰ Fallbackã€éŒ¯èª¤è™•ç†ã€æ—¥èªŒ
4. **ç¶­è­·æˆæœ¬ä½**ï¼šè‡ªå‹•æ›´æ–°ï¼Œç„¡éœ€æ‰‹å‹•ç®¡ç†

### æœªä¾†å¯é¸å„ªåŒ–

åƒ…ç•¶æ‡‰ç”¨è¦æ¨¡æ“´å¤§æ™‚è€ƒæ…®ï¼š
- Redis åˆ†ä½ˆå¼ç·©å­˜ï¼ˆå¤šå¯¦ä¾‹éƒ¨ç½²æ™‚ï¼‰
- ç·©å­˜ç›£æ§å’Œåˆ†æï¼ˆAPM å·¥å…·ï¼‰
- ç·©å­˜é ç†±å’Œé è¼‰å…¥ï¼ˆæå‡å†·å•Ÿå‹•æ€§èƒ½ï¼‰

---

**çµè«–**ï¼šâœ… ç·©å­˜ç³»çµ±å·²å……åˆ†å„ªåŒ–ï¼Œæš«ç„¡éœ€é¡å¤–æ”¹é€²ã€‚

---

**æª¢æŸ¥æ–‡ä»¶**ï¼š
- `backend/src/services/character/characterCache.service.js`
- `backend/src/membership/membership.service.js` (Line 18-83)
- `backend/src/services/aiSettings.service.js` (Line 17-272)
- `backend/src/config/gifts.js`

**ç·©å­˜æ•ˆæœ**: ğŸš€ Firestore è®€å–æ¸›å°‘ **93%**ï¼ŒéŸ¿æ‡‰æ™‚é–“æå‡ **30-50 å€**
