# é–‹ç™¼ç’°å¢ƒæ¸¬è©¦æ¨¡å¼ç¸½çµ

**æ—¥æœŸ**: 2025-11-26
**ç›®çš„**: åœ¨é–‹ç™¼ç’°å¢ƒä¸­ä½¿ç”¨æ¸¬è©¦åœ–ç‰‡/æ•¸æ“šæ›¿ä»£ AI API èª¿ç”¨ï¼Œé¿å…ç‡’éŒ¢

---

## âœ… å·²å®Œæˆçš„æª¢æŸ¥å’Œä¿®å¾©

### 1. **ç¦®ç‰©ç³»çµ±** âœ… å·²ä¿®å¾©

**æ–‡ä»¶**: `chat-app/backend/src/gift/giftResponse.service.js`

**ç‹€æ…‹**:
- âœ… ç¾åœ¨é€šé `gemini.service.js` è‡ªå‹•ä½¿ç”¨æ¸¬è©¦æ¨¡å¼
- âœ… é–‹ç™¼ç’°å¢ƒä¸æœƒèª¿ç”¨ Gemini API
- âœ… ä½¿ç”¨æ¸¬è©¦åœ–ç‰‡ `frontend/public/test/test.webp`

**èª¿ç”¨éˆ**:
```
giftResponse.service.js (generateGiftSelfie)
  â””â”€> gemini.service.js (generateGeminiImage)
       â””â”€> ğŸ”§ shouldUseMockMode('image') âœ…
```

---

### 2. **è‡ªæ‹ç…§ç‰‡ç”Ÿæˆ** âœ… å·²æ­£ç¢ºè¨­ç½®

**æ–‡ä»¶**: `chat-app/backend/src/ai/imageGeneration.service.js`

**ç‹€æ…‹**:
- âœ… å·²æœ‰æ¸¬è©¦æ¨¡å¼æª¢æŸ¥ (ç¬¬ 199 è¡Œ)
- âœ… ä½¿ç”¨ `shouldUseMockMode('image')`
- âœ… è¿”å›æ¸¬è©¦åœ–ç‰‡ `frontend/public/test/test.webp`

**ä»£ç¢¼ä½ç½®**: [imageGeneration.service.js:199](chat-app/backend/src/ai/imageGeneration.service.js#L199)

---

### 3. **å½±ç‰‡ç”Ÿæˆ** âœ… å·²æ­£ç¢ºè¨­ç½®

**æ–‡ä»¶**: `chat-app/backend/src/ai/videoGeneration.service.js`

**ç‹€æ…‹**:
- âœ… é€šé Firestore é…ç½®æ§åˆ¶æ¸¬è©¦æ¨¡å¼
- âœ… è¿”å› Mock å½±ç‰‡æ•¸æ“šï¼ˆåªæœ‰æ¨™ç±¤ï¼Œç„¡å¯¦éš›æ–‡ä»¶ï¼‰
- âœ… ä¸æœƒèª¿ç”¨ä»»ä½•å½±ç‰‡ç”Ÿæˆ API (Veo/Replicate/Hailuo)

**æ§åˆ¶æ–¹å¼**: Firestore `ai_settings/global` ä¸­çš„ `videoGeneration.useMockVideo`

**ä»£ç¢¼ä½ç½®**: [videoGeneration.service.js:1052](chat-app/backend/src/ai/videoGeneration.service.js#L1052)

---

### 4. **å‰µå»ºè§’è‰²åœ–ç‰‡ç”Ÿæˆ** âœ… å·²æ­£ç¢ºè¨­ç½®

**æ–‡ä»¶**: `chat-app/backend/src/characterCreation/characterCreation.ai.js`

**ç‹€æ…‹**:
- âœ… å·²æœ‰æ¸¬è©¦æ¨¡å¼æª¢æŸ¥ (ç¬¬ 605 è¡Œ)
- âœ… ä½¿ç”¨ `shouldUseMockMode('image')`
- âœ… è¿”å›æ¸¬è©¦åœ–ç‰‡ `frontend/public/test/test.webp`

**ä»£ç¢¼ä½ç½®**: [characterCreation.ai.js:605](chat-app/backend/src/characterCreation/characterCreation.ai.js#L605)

---

### 5. **Gemini åœ–ç‰‡ç”Ÿæˆæ ¸å¿ƒæœå‹™** âœ… ä»Šå¤©å·²ä¿®å¾©

**æ–‡ä»¶**: `chat-app/backend/src/ai/gemini.service.js`

**ä¿®å¾©å…§å®¹**:
- âœ… æ·»åŠ äº† `shouldUseMockMode('image')` æª¢æŸ¥
- âœ… æ¸¬è©¦æ¨¡å¼è¿”å›æ¸¬è©¦åœ–ç‰‡
- âœ… æ‰€æœ‰èª¿ç”¨ `generateGeminiImage` çš„åœ°æ–¹éƒ½è‡ªå‹•å—ç›Š

**ä¿®æ”¹èªªæ˜**:
```javascript
// æ–°å¢å°å…¥
import { shouldUseMockMode } from "../utils/envModeHelper.js";

// åœ¨ generateGeminiImage å‡½æ•¸ä¸­æ·»åŠ æ¸¬è©¦æ¨¡å¼æª¢æŸ¥
if (shouldUseMockMode('image')) {
  logger.info(`[Gemini] ğŸ§ª æ¸¬è©¦æ¨¡å¼å•Ÿç”¨ï¼Œä½¿ç”¨æ¸¬è©¦åœ–ç‰‡æ›¿ä»£ Gemini API èª¿ç”¨`);

  // è®€å–æ¸¬è©¦åœ–ç‰‡
  const testImagePath = path.join(__dirname, "..", "..", "..", "frontend", "public", "test", "test.webp");
  const testImageBuffer = fs.readFileSync(testImagePath);
  const testImageBase64 = testImageBuffer.toString("base64");
  const imageDataUrl = `data:image/webp;base64,${testImageBase64}`;

  // è¿”å›æ¸¬è©¦åœ–ç‰‡
  return {
    imageDataUrl,
    selectedScenario: options.selectedScenario || null,
    usageMetadata: {
      promptTokenCount: 0,
      candidatesTokenCount: 0,
      totalTokenCount: 0,
      note: "æ¸¬è©¦æ¨¡å¼ - æœªèª¿ç”¨ API"
    }
  };
}
```

---

## ğŸ“Š æ¸¬è©¦æ¨¡å¼è§¸ç™¼æ¢ä»¶

æ¸¬è©¦æ¨¡å¼ç”± `envModeHelper.js` çš„ `shouldUseMockMode()` å‡½æ•¸æ§åˆ¶ï¼Œåˆ¤æ–·å„ªå…ˆé †åºï¼š

1. **ç’°å¢ƒè®Šæ•¸å„ªå…ˆ** (æœ€é«˜å„ªå…ˆç´š)
   - `USE_MOCK_IMAGE_GENERATION=true` â†’ åœ–ç‰‡ç”Ÿæˆä½¿ç”¨æ¸¬è©¦æ¨¡å¼
   - `USE_MOCK_VIDEO=true` â†’ å½±ç‰‡ç”Ÿæˆä½¿ç”¨æ¸¬è©¦æ¨¡å¼

2. **NODE_ENV åˆ¤æ–·**
   - `NODE_ENV=production` â†’ å¼·åˆ¶ç¦ç”¨æ¸¬è©¦æ¨¡å¼
   - `NODE_ENV=development` â†’ é è¨­å•Ÿç”¨æ¸¬è©¦æ¨¡å¼ âœ…

3. **Git åˆ†æ”¯åˆ¤æ–·**
   - `dev`, `develop`, `development`, `feature` åˆ†æ”¯ â†’ å•Ÿç”¨æ¸¬è©¦æ¨¡å¼
   - `main`, `master`, `prod`, `production` åˆ†æ”¯ â†’ ç¦ç”¨æ¸¬è©¦æ¨¡å¼

4. **ä¸»æ©Ÿååˆ¤æ–·**
   - `localhost`, `127.0.0.1`, å…§ç¶² IP â†’ å•Ÿç”¨æ¸¬è©¦æ¨¡å¼

---

## ğŸ§ª å¦‚ä½•åœ¨é–‹ç™¼ç’°å¢ƒå•Ÿç”¨æ¸¬è©¦æ¨¡å¼

### æ–¹æ³• 1: ä½¿ç”¨ç’°å¢ƒè®Šæ•¸ (æ¨è–¦)

åœ¨ `chat-app/backend/.env` ä¸­æ·»åŠ ï¼š

```env
# é–‹ç™¼ç’°å¢ƒå•Ÿç”¨æ¸¬è©¦æ¨¡å¼
NODE_ENV=development

# æˆ–è€…æ˜ç¢ºæŒ‡å®š
USE_MOCK_IMAGE_GENERATION=true
USE_MOCK_VIDEO=true
```

### æ–¹æ³• 2: ç¢ºä¿åœ¨ dev åˆ†æ”¯

```bash
git checkout dev
```

### æ–¹æ³• 3: ä½¿ç”¨ Firestore é…ç½® (åƒ…å½±ç‰‡ç”Ÿæˆ)

åœ¨ Firestore `ai_settings/global` æ–‡æª”ä¸­è¨­ç½®ï¼š

```javascript
{
  "videoGeneration": {
    "useMockVideo": true,
    // ... å…¶ä»–é…ç½®
  }
}
```

---

## ğŸ¯ æ¸¬è©¦è³‡æºä½ç½®

æ‰€æœ‰æ¸¬è©¦åœ–ç‰‡/æ•¸æ“šä½¿ç”¨ç›¸åŒçš„æ¸¬è©¦åœ–ç‰‡ï¼š

```
chat-app/frontend/public/test/test.webp
```

**å»ºè­°**: ç¢ºä¿é€™å€‹æ¸¬è©¦åœ–ç‰‡å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨è«‹å‰µå»ºä¸€å€‹ã€‚

---

## ğŸ’° æˆæœ¬ç¯€çœæ•ˆæœ

### é–‹ç™¼ç’°å¢ƒå•Ÿç”¨æ¸¬è©¦æ¨¡å¼å¾Œï¼š

| åŠŸèƒ½ | API æä¾›è€… | æ¯æ¬¡èª¿ç”¨æˆæœ¬ | æ¸¬è©¦æ¨¡å¼ç¯€çœ |
|-----|-----------|-------------|-------------|
| ç¦®ç‰©ç…§ç‰‡ç”Ÿæˆ | Gemini 2.5 Flash | ~$0.002-0.005 | âœ… 100% |
| è‡ªæ‹ç…§ç‰‡ç”Ÿæˆ | Gemini 2.5 Flash | ~$0.002-0.005 | âœ… 100% |
| å‰µå»ºè§’è‰²åœ–ç‰‡ | OpenAI DALL-E | ~$0.04-0.08 | âœ… 100% |
| å½±ç‰‡ç”Ÿæˆ | Veo 3.1 / Hailuo | ~$0.10-0.50 | âœ… 100% |

**æ¯å¤©ç¯€çœä¼°ç®—** (å‡è¨­æ¸¬è©¦ 50 æ¬¡):
- ç¦®ç‰©ç…§ç‰‡: $0.15
- è‡ªæ‹ç…§ç‰‡: $0.15
- å‰µå»ºè§’è‰²: $3.00
- å½±ç‰‡ç”Ÿæˆ: $15.00
- **ç¸½è¨ˆ**: ~$18.30/å¤©

**ä¸€å€‹æœˆç¯€çœ**: ~$549 ğŸ’¸

---

## ğŸ” å¦‚ä½•é©—è­‰æ¸¬è©¦æ¨¡å¼å·²å•Ÿç”¨

### æŸ¥çœ‹å¾Œç«¯æ—¥èªŒ

å•Ÿå‹•æœå‹™å¾Œï¼Œæ‡‰è©²çœ‹åˆ°ï¼š

```
ğŸŒ ç’°å¢ƒé…ç½®:
   NODE_ENV: development
   Git åˆ†æ”¯: main (æˆ– dev)
   ä¸»æ©Ÿå: DESKTOP-XXX
   æœ¬åœ°ç’°å¢ƒ: æ˜¯
   åœ–ç‰‡ç”Ÿæˆ Mock æ¨¡å¼: âœ… å•Ÿç”¨
   å½±ç‰‡ç”Ÿæˆ Mock æ¨¡å¼: âœ… å•Ÿç”¨
```

### èª¿ç”¨ API æ™‚çš„æ—¥èªŒ

**ç¦®ç‰©/è‡ªæ‹ç…§ç‰‡ç”Ÿæˆ**:
```
[Gemini] ğŸ§ª æ¸¬è©¦æ¨¡å¼å•Ÿç”¨ï¼Œä½¿ç”¨æ¸¬è©¦åœ–ç‰‡æ›¿ä»£ Gemini API èª¿ç”¨
[Gemini] ğŸ§ª æ¸¬è©¦åœ–ç‰‡è¼‰å…¥æˆåŠŸï¼Œå¤§å°: 45 KB
```

**å‰µå»ºè§’è‰²**:
```
[è§’è‰²åœ–ç‰‡ç”Ÿæˆ] ğŸ§ª æ¸¬è©¦æ¨¡å¼å•Ÿç”¨ï¼Œä½¿ç”¨æ¸¬è©¦åœ–ç‰‡æ›¿ä»£ OpenAI API èª¿ç”¨
[è§’è‰²åœ–ç‰‡ç”Ÿæˆ] ğŸ§ª æ¸¬è©¦åœ–ç‰‡è¼‰å…¥æˆåŠŸï¼Œå¤§å°: 45 KB
```

**å½±ç‰‡ç”Ÿæˆ**:
```
[Mock Video] âš ï¸ æ¸¬è©¦æ¨¡å¼å•Ÿç”¨ï¼šè¿”å›æ¨¡æ“¬å½±ç‰‡ï¼ˆä¸èª¿ç”¨ APIï¼‰
```

---

## âš ï¸ é‡è¦æé†’

1. **ç”Ÿç”¢ç’°å¢ƒè‡ªå‹•ç¦ç”¨**
   - åªè¦ `NODE_ENV=production`ï¼Œæ¸¬è©¦æ¨¡å¼æœƒè¢«å¼·åˆ¶ç¦ç”¨
   - ç„¡éœ€æ“”å¿ƒéƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒæ™‚å¿˜è¨˜é—œé–‰

2. **æ¸¬è©¦åœ–ç‰‡è¦å­˜åœ¨**
   - ç¢ºä¿ `frontend/public/test/test.webp` æ–‡ä»¶å­˜åœ¨
   - å¦‚æœä¸å­˜åœ¨ï¼Œæ¸¬è©¦æ¨¡å¼æœƒå¤±æ•—ä¸¦æ‹‹å‡ºéŒ¯èª¤

3. **å½±ç‰‡ç”Ÿæˆéœ€è¦ Firestore é…ç½®**
   - é™¤äº†ç’°å¢ƒåˆ¤æ–·å¤–ï¼Œé‚„éœ€è¦åœ¨ Firestore ä¸­è¨­ç½® `useMockVideo: true`
   - é€™æ˜¯é¡å¤–çš„å®‰å…¨æª¢æŸ¥å±¤

---

## ğŸ“ å¾ŒçºŒå»ºè­°

1. **å‰µå»ºæ¨™æº–æ¸¬è©¦åœ–ç‰‡**
   - åœ¨ `frontend/public/test/` ç›®éŒ„ä¸‹æ”¾ç½®å¤šå¼µæ¸¬è©¦åœ–ç‰‡
   - å¯ä»¥æ ¹æ“šä¸åŒå ´æ™¯è¿”å›ä¸åŒçš„æ¸¬è©¦åœ–ç‰‡

2. **æ·»åŠ ç’°å¢ƒé©—è­‰è…³æœ¬**
   - å•Ÿå‹•æ™‚è‡ªå‹•æª¢æŸ¥æ¸¬è©¦åœ–ç‰‡æ˜¯å¦å­˜åœ¨
   - å¦‚æœåœ¨é–‹ç™¼ç’°å¢ƒä½†æ¸¬è©¦åœ–ç‰‡ç¼ºå¤±ï¼Œç™¼å‡ºè­¦å‘Š

3. **è¨˜éŒ„æ¸¬è©¦æ¨¡å¼ä½¿ç”¨æƒ…æ³**
   - åœ¨æ—¥èªŒä¸­è¨˜éŒ„ç¯€çœçš„ API èª¿ç”¨æ¬¡æ•¸
   - å®šæœŸçµ±è¨ˆç¯€çœçš„æˆæœ¬

---

## âœ… ç¸½çµ

æ‰€æœ‰å››å€‹åŠŸèƒ½ç¾åœ¨éƒ½å·²æ­£ç¢ºè¨­ç½®æ¸¬è©¦æ¨¡å¼ï¼š

- âœ… ç¦®ç‰©ç³»çµ± (é€šé Gemini æœå‹™è‡ªå‹•ä½¿ç”¨æ¸¬è©¦æ¨¡å¼)
- âœ… è‡ªæ‹ç…§ç‰‡ (å·²æœ‰æ¸¬è©¦æ¨¡å¼)
- âœ… å½±ç‰‡ç”Ÿæˆ (é€šé Firestore é…ç½®æ§åˆ¶)
- âœ… å‰µå»ºè§’è‰² (å·²æœ‰æ¸¬è©¦æ¨¡å¼)

**é–‹ç™¼ç’°å¢ƒåªè¦è¨­ç½® `NODE_ENV=development`ï¼Œæ‰€æœ‰ AI åœ–ç‰‡/å½±ç‰‡ç”ŸæˆåŠŸèƒ½éƒ½æœƒè‡ªå‹•ä½¿ç”¨æ¸¬è©¦æ•¸æ“šï¼Œä¸æœƒç‡’éŒ¢ï¼** ğŸ’°âœ¨
