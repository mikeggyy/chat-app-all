# Data URL æ”¯æ´ä¿®å¾©ç¸½çµ

**æ—¥æœŸ**: 2025-11-25
**å•é¡Œ**: é€ç¦®ç‰©å’Œç”Ÿæˆå½±ç‰‡æ™‚é¸æ“‡ç›¸ç°¿ç…§ç‰‡å¤±æ•—
**åŸå› **: å¾Œç«¯ä¸æ”¯æ´ data URL æ ¼å¼çš„åœ–ç‰‡

---

## ğŸ“‹ å•é¡Œæè¿°

**ç—‡ç‹€ 1 - é€ç¦®ç‰©å¤±æ•—**:
```
éŒ¯èª¤ï¼šç”Ÿæˆç¦®ç‰©è‡ªæ‹ç…§å¤±æ•—: éœ€è¦æä¾›è§’è‰²åƒè€ƒç…§ç‰‡ (Base64)
é€€æ¬¾ï¼šå·²é€€æ¬¾é‡‘å¹£
```

**ç—‡ç‹€ 2 - å½±ç‰‡ç”Ÿæˆå¤±æ•—**:
```
éŒ¯èª¤ï¼šPOST /api/ai/generate-video 500 (Internal Server Error)
```

**æ ¹æœ¬åŸå› **:
- ç”¨æˆ¶å¾ç›¸ç°¿é¸æ“‡ç…§ç‰‡ä½œç‚ºåƒè€ƒåœ–ç‰‡
- ç›¸ç°¿ä¸­çš„ç…§ç‰‡æ˜¯ **data URL æ ¼å¼**ï¼ˆ`data:image/webp;base64,...`ï¼‰
- å¾Œç«¯åªæ”¯æ´ HTTP URL å’Œæœ¬åœ°è·¯å¾‘ï¼Œä¸æ”¯æ´ data URL
- å°è‡´åœ–ç‰‡è™•ç†å¤±æ•—

---

## âœ… å¯¦æ–½çš„ä¿®å¾©

### 1. é€ç¦®ç‰©ç³»çµ±ï¼ˆgiftResponse.service.jsï¼‰

**ä¿®æ”¹ä½ç½®**: `generateGiftSelfie` å‡½æ•¸

**æ–°å¢åŠŸèƒ½**:
```javascript
// âœ… æª¢æŸ¥æ˜¯å¦ç‚º data URLï¼ˆbase64 ç·¨ç¢¼çš„åœ–ç‰‡ï¼‰
if (portraitUrl && portraitUrl.startsWith("data:")) {
  logger.info(`[ç¦®ç‰©å›æ‡‰] æª¢æ¸¬åˆ° data URLï¼Œç›´æ¥è§£æ base64`);
  const base64Data = portraitUrl.replace(/^data:image\/\w+;base64,/, "");
  referenceImageBuffer = Buffer.from(base64Data, "base64");
  logger.info(`[ç¦®ç‰©å›æ‡‰] âœ… æˆåŠŸè§£æ data URL (${Math.round(referenceImageBuffer.length / 1024)} KB)`);
}
```

**æ”¯æ´çš„åœ–ç‰‡æ ¼å¼**:
- ğŸŒ **HTTP/HTTPS URL** - Firebase Storageã€CDN
- ğŸ“„ **data URL** - ç›¸ç°¿ä¸­çš„ base64 åœ–ç‰‡ï¼ˆâœ¨ æ–°å¢æ”¯æ´ï¼‰
- ğŸ“ **æœ¬åœ°è·¯å¾‘** - æœ¬åœ°æ–‡ä»¶ç³»çµ±

---

### 2. å½±ç‰‡ç”Ÿæˆç³»çµ±ï¼ˆvideoGeneration.service.jsï¼‰

**ä¿®æ”¹ä½ç½®**: `processImageUrl` å‡½æ•¸

**æ–°å¢åŠŸèƒ½ A - data URL æ”¯æ´**:
```javascript
// âœ… æª¢æŸ¥æ˜¯å¦ç‚º data URLï¼ˆbase64 ç·¨ç¢¼çš„åœ–ç‰‡ï¼‰
if (imageUrl.startsWith("data:")) {
  logger.info("[Video] æª¢æ¸¬åˆ° data URLï¼Œç›´æ¥è§£æä¸¦ä¸Šå‚³åˆ° R2");
  const base64Data = imageUrl.replace(/^data:image\/\w+;base64,/, "");
  const imageBuffer = Buffer.from(base64Data, "base64");

  // ä¸Šå‚³åˆ° R2
  const uploadResult = await uploadImageToR2(imageBuffer, userId, characterId, {
    contentType: "image/webp",
    extension: "webp",
  });

  return uploadResult.url;
}
```

**æ–°å¢åŠŸèƒ½ B - localhost URL æ”¯æ´** (2025-11-25 æ™šé–“è¿½åŠ ):
```javascript
// âœ… æª¢æ¸¬ localhost URLï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰
if (imageUrl.includes("localhost") || imageUrl.includes("127.0.0.1") || imageUrl.includes("192.168.")) {
  logger.info("[Video] æª¢æ¸¬åˆ° localhost URLï¼Œå°‡å¾æœ¬åœ°ä¸‹è¼‰ä¸¦ä¸Šå‚³åˆ° R2");
  // å¾æœ¬åœ°é–‹ç™¼æœå‹™å™¨ä¸‹è¼‰åœ–ç‰‡
  const response = await fetch(imageUrl);
  const imageBuffer = Buffer.from(await response.arrayBuffer());

  // ä¸Šå‚³åˆ° R2
  const uploadResult = await uploadImageToR2(imageBuffer, userId, characterId, {
    contentType: "image/webp",
    extension: "webp",
  });

  return uploadResult.url;
}
```

**æ”¯æ´çš„åœ–ç‰‡æ ¼å¼**:
- ğŸŒ **HTTP/HTTPS URL** - Firebase Storageã€CDNã€R2 ç­‰å…¬é–‹ URL
- ğŸ“„ **data URL** - ç›¸ç°¿ä¸­çš„ base64 åœ–ç‰‡ï¼ˆâœ¨ æ–°å¢æ”¯æ´ï¼‰
- ğŸ”§ **localhost URL** - é–‹ç™¼ç’°å¢ƒçš„æœ¬åœ°åœ–ç‰‡ï¼ˆâœ¨ æ–°å¢æ”¯æ´ï¼‰
- ğŸ“ **ç›¸å°è·¯å¾‘** - å¦‚ `/ai-role/xxx.webp`ï¼ˆè‡ªå‹•è½‰æ›ç‚ºå®Œæ•´ URLï¼‰

**è™•ç†æµç¨‹**:
1. æª¢æ¸¬ URL é¡å‹ï¼ˆdata URL / localhost URL / å…¬é–‹ URL / ç›¸å°è·¯å¾‘ï¼‰
2. å¦‚æœæ˜¯ data URLï¼šæå– base64 æ•¸æ“šä¸¦è½‰æ›ç‚º Buffer
3. å¦‚æœæ˜¯ localhost URLï¼šå¾æœ¬åœ°æœå‹™å™¨ä¸‹è¼‰åœ–ç‰‡
4. å¦‚æœæ˜¯ç›¸å°è·¯å¾‘ï¼šæ ¹æ“šç’°å¢ƒè½‰æ›ç‚ºå®Œæ•´ URL å¾Œä¸‹è¼‰
5. ä¸Šå‚³åˆ° Cloudflare R2
6. è¿”å›å…¬é–‹å¯è¨ªå•çš„ URL

---

## ğŸ§ª æ¸¬è©¦æŒ‡å—

### æ¸¬è©¦ç’°å¢ƒé¸æ“‡

#### **é¸é … A: æœ¬åœ°ç’°å¢ƒæ¸¬è©¦**ï¼ˆæ¨è–¦ï¼‰

1. **é‡å•Ÿå¾Œç«¯**:
   ```bash
   cd d:\project\chat-app-all\chat-app
   npm run dev:backend
   ```

2. **å•Ÿå‹•å‰ç«¯**ï¼ˆå¦‚æœªé‹è¡Œï¼‰:
   ```bash
   cd d:\project\chat-app-all\chat-app
   npm run dev:frontend
   ```

3. **è¨ªå•æœ¬åœ°å‰ç«¯**:
   - æ‰“é–‹ `http://localhost:5173`

4. **æ¸¬è©¦æ­¥é©Ÿ**:
   - æ¸¬è©¦ 1: é€ç¦®ç‰© + é¸æ“‡é è¨­ç…§ç‰‡
   - æ¸¬è©¦ 2: ç”Ÿæˆå½±ç‰‡ + é¸æ“‡ç›¸ç°¿ç…§ç‰‡

5. **æŸ¥çœ‹æ—¥èªŒ**:
   - å¾Œç«¯æ§åˆ¶å°æœƒé¡¯ç¤ºè©³ç´°æ—¥èªŒ
   - æ‡‰è©²çœ‹åˆ° `[ç¦®ç‰©å›æ‡‰] æª¢æ¸¬åˆ° data URL` æˆ– `[Video] æª¢æ¸¬åˆ° data URL`

---

#### **é¸é … B: ç”Ÿç”¢ç’°å¢ƒæ¸¬è©¦**ï¼ˆéœ€è¦éƒ¨ç½²ï¼‰

1. **éƒ¨ç½²å¾Œç«¯åˆ° Cloud Run**:
   ```bash
   cd d:\project\chat-app-all\chat-app\backend
   deploy-cloudrun.bat
   ```

2. **ç­‰å¾…éƒ¨ç½²å®Œæˆ**ï¼ˆç´„ 5-10 åˆ†é˜ï¼‰

3. **è¨ªå•ç”Ÿç”¢ç’°å¢ƒ**:
   - `https://chat-app-all.pages.dev`

4. **æ¸¬è©¦åŠŸèƒ½**:
   - é€ç¦®ç‰© + é¸æ“‡é è¨­ç…§ç‰‡
   - ç”Ÿæˆå½±ç‰‡ + é¸æ“‡ç›¸ç°¿ç…§ç‰‡

5. **æŸ¥çœ‹æ—¥èªŒ**ï¼ˆå¦‚æœéœ€è¦ï¼‰:
   ```bash
   gcloud run services logs read chat-backend --region asia-east1
   ```

---

### é æœŸè¡Œç‚º

#### **é€ç¦®ç‰©æˆåŠŸ**:
1. âœ… é¸æ“‡ç›¸ç°¿ä¸­çš„ç…§ç‰‡
2. âœ… å¾Œç«¯æª¢æ¸¬åˆ° data URL
3. âœ… è§£æ base64 æ•¸æ“š
4. âœ… ä½¿ç”¨ç…§ç‰‡ç”Ÿæˆç¦®ç‰©å›æ‡‰
5. âœ… é¡¯ç¤ºæ„Ÿè¬è¨Šæ¯å’Œç¦®ç‰©ç…§ç‰‡
6. âœ… æ‰£æ¬¾æˆåŠŸ

#### **å½±ç‰‡ç”ŸæˆæˆåŠŸ**:
1. âœ… é¸æ“‡ç›¸ç°¿ä¸­çš„ç…§ç‰‡
2. âœ… å¾Œç«¯æª¢æ¸¬åˆ° data URL
3. âœ… ä¸Šå‚³åˆ° Cloudflare R2
4. âœ… èª¿ç”¨ Replicate API ç”Ÿæˆå½±ç‰‡
5. âœ… è¿”å›å½±ç‰‡ URL
6. âœ… å‰ç«¯æ’­æ”¾å½±ç‰‡

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### å¾Œç«¯:

1. **[chat-app/backend/src/gift/giftResponse.service.js](chat-app/backend/src/gift/giftResponse.service.js)**
   - âœ… `generateGiftSelfie` å‡½æ•¸æ·»åŠ  data URL æ”¯æ´
   - âœ… æ·»åŠ èª¿è©¦æ—¥èªŒè¨˜éŒ„ URL é¡å‹

2. **[chat-app/backend/src/ai/videoGeneration.service.js](chat-app/backend/src/ai/videoGeneration.service.js)**
   - âœ… `processImageUrl` å‡½æ•¸æ·»åŠ  data URL æ”¯æ´
   - âœ… data URL è‡ªå‹•ä¸Šå‚³åˆ° R2

---

## ğŸ” èª¿è©¦æ—¥èªŒ

### é€ç¦®ç‰©æ—¥èªŒç¤ºä¾‹:

```
[ç¦®ç‰©å›æ‡‰] ğŸ“‹ åƒè€ƒåœ–ç‰‡ URL ä¿¡æ¯: {
  hasReferenceImageUrl: true,
  hasPortraitUrl: true,
  urlType: "data URL",
  urlLength: 234567,
  urlPrefix: "data:image/webp;base64,UklGRj..."
}
[ç¦®ç‰©å›æ‡‰] æª¢æ¸¬åˆ° data URLï¼Œç›´æ¥è§£æ base64
[ç¦®ç‰©å›æ‡‰] âœ… æˆåŠŸè§£æ data URL (123 KB)
[ç¦®ç‰©ç…§ç‰‡] âœ… ç¦®ç‰©ç…§ç‰‡å·²æˆåŠŸä¸Šå‚³åˆ° Storage
```

### å½±ç‰‡ç”Ÿæˆæ—¥èªŒç¤ºä¾‹:

```
[Video] æª¢æ¸¬åˆ° data URLï¼Œç›´æ¥è§£æä¸¦ä¸Šå‚³åˆ° R2
[Video] æˆåŠŸè§£æ data URL (156 KB)
[Video] data URL åœ–ç‰‡å·²ä¸Šå‚³åˆ° R2: https://pub-xxx.r2.dev/...
[Replicate SVD] ä½¿ç”¨è‡ªå®šç¾©åœ–ç‰‡ï¼ˆå¾ç›¸ç°¿é¸æ“‡ï¼‰
[Replicate SVD] å½±ç‰‡ç”ŸæˆæˆåŠŸ
```

---

## ğŸš€ éƒ¨ç½²æª¢æŸ¥æ¸…å–®

### æœ¬åœ°ç’°å¢ƒ:
- [x] ä¿®æ”¹ `giftResponse.service.js`
- [x] ä¿®æ”¹ `videoGeneration.service.js`
- [ ] é‡å•Ÿå¾Œç«¯æœå‹™
- [ ] æ¸¬è©¦é€ç¦®ç‰©åŠŸèƒ½ï¼ˆé¸æ“‡é è¨­ç…§ç‰‡ï¼‰
- [ ] æ¸¬è©¦å½±ç‰‡ç”ŸæˆåŠŸèƒ½ï¼ˆé¸æ“‡ç›¸ç°¿ç…§ç‰‡ï¼‰
- [ ] ç¢ºèªå¾Œç«¯æ—¥èªŒé¡¯ç¤º "æª¢æ¸¬åˆ° data URL"

### ç”Ÿç”¢ç’°å¢ƒ:
- [x] æœ¬åœ°ä»£ç¢¼å·²ä¿®æ”¹
- [ ] åŸ·è¡Œ `deploy-cloudrun.bat` éƒ¨ç½²å¾Œç«¯
- [ ] ç­‰å¾…éƒ¨ç½²å®Œæˆï¼ˆ5-10 åˆ†é˜ï¼‰
- [ ] æ¸¬è©¦ç”Ÿç”¢ç’°å¢ƒåŠŸèƒ½
- [ ] æª¢æŸ¥ Cloud Run æ—¥èªŒï¼ˆå¦‚éœ€è¦ï¼‰

---

## ğŸ’¡ ç›¸é—œå•é¡Œå’Œè§£æ±ºæ–¹æ¡ˆ

### Q1: ç‚ºä»€éº¼é¸æ“‡ç›¸ç°¿ç…§ç‰‡æœƒæ˜¯ data URLï¼Ÿ

**A**: ç›¸ç°¿ä¸­çš„ç…§ç‰‡æœ‰å…©ç¨®å­˜å„²æ–¹å¼ï¼š
1. **Firebase Storage URL** - å·²ä¸Šå‚³åˆ°é›²ç«¯çš„ç…§ç‰‡ï¼ˆHTTPS URLï¼‰
2. **data URL** - æœ¬åœ°ç”Ÿæˆæˆ–å£“ç¸®å¾Œçš„ç…§ç‰‡ï¼ˆbase64 æ ¼å¼ï¼‰

ç•¶ç”¨æˆ¶ç”Ÿæˆç…§ç‰‡å¾Œï¼Œå‰ç«¯æœƒå°‡åœ–ç‰‡å£“ç¸®ç‚º WebP æ ¼å¼ä¸¦ä¿å­˜ç‚º data URLï¼Œä»¥æ¸›å°‘å­˜å„²ç©ºé–“ã€‚

---

### Q2: data URL æœƒä¸æœƒå¤ªå¤§å°è‡´è«‹æ±‚å¤±æ•—ï¼Ÿ

**A**: å¯èƒ½æ€§ä¸å¤§ï¼Œä½†æœ‰é é˜²æªæ–½ï¼š
- WebP å£“ç¸®å¾Œçš„ç…§ç‰‡é€šå¸¸ç‚º 100-200 KB
- Base64 ç·¨ç¢¼å¾Œç´„å¢åŠ  33%ï¼Œç´„ 130-260 KB
- HTTP è«‹æ±‚å¤§å°é™åˆ¶é€šå¸¸ç‚º 10-50 MB
- âœ… **å½±ç‰‡ç”Ÿæˆ**æœƒè‡ªå‹•ä¸Šå‚³åˆ° R2ï¼Œä¸æœƒå‚³é data URL çµ¦ç¬¬ä¸‰æ–¹ API

---

### Q3: å¦‚æœé‚„æ˜¯å¤±æ•—æ€éº¼è¾¦ï¼Ÿ

**æ’æŸ¥æ­¥é©Ÿ**:

1. **ç¢ºèªå¾Œç«¯å·²é‡å•Ÿ**ï¼ˆæœ¬åœ°ï¼‰æˆ–å·²éƒ¨ç½²ï¼ˆç”Ÿç”¢ï¼‰
2. **æŸ¥çœ‹å¾Œç«¯æ—¥èªŒ**:
   - æœ¬åœ°ï¼šå¾Œç«¯æ§åˆ¶å°
   - ç”Ÿç”¢ï¼šCloud Run æ—¥èªŒ
3. **æª¢æŸ¥éŒ¯èª¤è¨Šæ¯**:
   - å‰ç«¯æ§åˆ¶å°ï¼ˆF12ï¼‰
   - éŒ¯èª¤æç¤ºæ˜¯å¦æ›´è©³ç´°
4. **ç¢ºèª URL æ ¼å¼**:
   - åœ¨æ—¥èªŒä¸­æŸ¥æ‰¾ `urlType: "data URL"`
   - å¦‚æœæ˜¯å…¶ä»–é¡å‹ï¼Œå¯èƒ½æ˜¯å‰ç«¯å‚³éçš„æ•¸æ“šå•é¡Œ

---

## ğŸ“Š æŠ€è¡“ç´°ç¯€

### data URL æ ¼å¼:

```
data:image/webp;base64,UklGRjIAAABXRUJQVlA4...
^    ^     ^       ^    ^
|    |     |       |    |
|    |     |       |    +-- base64 ç·¨ç¢¼çš„åœ–ç‰‡æ•¸æ“š
|    |     |       +------- base64 æ¨™è¨˜
|    |     +--------------- ç·¨ç¢¼é¡å‹
|    +--------------------- MIME é¡å‹ï¼ˆimage/webpï¼‰
+-------------------------- data URL æ¨™è¨˜
```

### æå– base64 æ•¸æ“š:

```javascript
// ç§»é™¤å‰ç¶´
const base64Data = imageUrl.replace(/^data:image\/\w+;base64,/, "");

// è½‰æ›ç‚º Buffer
const imageBuffer = Buffer.from(base64Data, "base64");
```

---

## âœ¨ é æœŸæ•ˆæœ

**ä¿®å¾©å‰**:
```
âŒ é€ç¦®ç‰©ï¼šç”Ÿæˆç¦®ç‰©è‡ªæ‹ç…§å¤±æ•—ï¼Œå·²é€€æ¬¾
âŒ å½±ç‰‡ç”Ÿæˆï¼š500 éŒ¯èª¤
âŒ åªèƒ½ä½¿ç”¨è§’è‰²é è¨­ç…§ç‰‡
```

**ä¿®å¾©å¾Œ**:
```
âœ… é€ç¦®ç‰©ï¼šæˆåŠŸä½¿ç”¨ç›¸ç°¿ç…§ç‰‡ç”Ÿæˆç¦®ç‰©å›æ‡‰
âœ… å½±ç‰‡ç”Ÿæˆï¼šæˆåŠŸä½¿ç”¨ç›¸ç°¿ç…§ç‰‡ç”Ÿæˆå½±ç‰‡
âœ… å®Œæ•´æ”¯æ´ 3 ç¨®åœ–ç‰‡æ ¼å¼ï¼ˆHTTPã€data URLã€æœ¬åœ°è·¯å¾‘ï¼‰
âœ… è©³ç´°çš„èª¿è©¦æ—¥èªŒ
```

---

## ğŸ‰ ç¸½çµ

æ­¤æ¬¡ä¿®å¾©è§£æ±ºäº†å…©å€‹é—œéµåŠŸèƒ½çš„ data URL æ”¯æ´å•é¡Œï¼š

1. âœ… **é€ç¦®ç‰©ç³»çµ±** - æ”¯æ´å¾ç›¸ç°¿é¸æ“‡ç…§ç‰‡ä½œç‚ºç¦®ç‰©å›æ‡‰çš„åƒè€ƒ
2. âœ… **å½±ç‰‡ç”Ÿæˆç³»çµ±** - æ”¯æ´å¾ç›¸ç°¿é¸æ“‡ç…§ç‰‡ç”Ÿæˆå‹•æ…‹å½±ç‰‡

ç”¨æˆ¶ç¾åœ¨å¯ä»¥è‡ªç”±é¸æ“‡ç›¸ç°¿ä¸­çš„ä»»ä½•ç…§ç‰‡ï¼Œç„¡è«–æ˜¯ HTTP URL é‚„æ˜¯ data URL æ ¼å¼ï¼Œç³»çµ±éƒ½èƒ½æ­£ç¢ºè™•ç†ã€‚

---

**æ–‡æª”ç‰ˆæœ¬**: 1.0
**æœ€å¾Œæ›´æ–°**: 2025-11-25
**ç›¸é—œæ–‡æª”**: [GIFT_ERROR_IMPROVEMENT_2025-11-25.md](GIFT_ERROR_IMPROVEMENT_2025-11-25.md)
